# V16 Журналирование событий безопасности и обработка ошибок

## Задачи контроля

Журналы безопасности отличаются от журналов ошибок или производительности и служат для записи событий, связанных с безопасностью, таких как решения по аутентификации, контроль доступа или попытки обхода механизмов защиты (например, проверка входных данных или бизнес-логики). Их основная задача — обеспечить обнаружение, реагирование и расследование инцидентов за счёт предоставления структурированных данных с высокой информативной ценностью для аналитических систем, таких как SIEM.

Журналы не должны содержать конфиденциальные персональные данные, если это не предусмотрено законом, а все залогированные сведения должны защищаться как актив высокой важности. Процесс журналирования не должен нарушать конфиденциальность или безопасность системы. Кроме того, приложения должны отрабатывать ошибки безопасным образом, исключая необоснованное раскрытие информации или disruption (нарушение работы).

Подробные инструкции по внедрению см. в OWASP Cheat Sheets в разделе ссылок.

## V16.1 Документация по ведению логов

Этот раздел обеспечивает четкий и полный учет журналирования во всем стеке приложения. Это необходимо для эффективного мониторинга безопасности, реагирования на инциденты и соответствия требованиям.

| # | Описание | Уровень |
| :---: | :--- | :---: |
| **16.1.1** | Убедитесь в существовании реестра, в котором документируется ведение журнала на каждом уровне технологического стека приложения, включая какие события регистрируются, форматы логов, где хранятся эти журналы, как они используются, как контролируется доступ к ним и как долго хранятся журналы. | 2 |

## V16.2 Общее журналирование

В этом разделе устанавливаются требования, обеспечивающие единообразную структуру журналов безопасности и наличие метаданных. Цель — обеспечить машиночитаемость логов и возможность их анализа в распределённых системах и инструментах мониторинга.

Естественно, события безопасности часто связаны с конфиденциальными данными. Если такие данные регистрируются без должного внимания, сами журналы становятся секретными и, следовательно, подпадают под действие требований шифрования (прим. автора - законодательства), более строгих политик хранения и могут быть раскрыты в ходе аудита.

Крайне важно регистрировать только необходимые данные и обращаться с данными журналов с той же осторожностью, что и с другими конфиденциальными активами.

Приведенные ниже требования устанавливают основополагающие требования к регистрации метаданных, синхронизации, форматированию и контролю.

| # | Описание | Уровень |
| :---: | :--- | :---: |
| **16.2.1** | Убедитесь, что каждая запись журнала содержит необходимые метаданные (например, когда, где, кто, что), которые позволят провести подробное исследование временной шкалы, когда произошло событие. | 2 |
| **16.2.2** | Убедитесь, что все источники времени компонентов системы журналирования синхронизированы, а временные метки в метаданных событий безопасности используют UTC или содержат явное указание смещения часового пояса. Рекомендуется применять UTC для обеспечения согласованности в распределённых системах и предотвращения ошибок при переходе на летнее/зимнее время. | 2 |
| **16.2.3** | Убедитесь, что приложение записывает и передаёт логи исключительно в те файлы и сервисы, которые указаны в реестре журналирования. | 2 |
| **16.2.4** | Убедитесь, что логи могут быть прочитаны и коррелированы используемой системой обработки журналов, предпочтительно с использованием общего стандартного формата логирования. | 2 |
| **16.2.5** | Убедитесь, что приложение применяет соответствующие меры защиты при логировании конфиденциальных данных в зависимости от уровня их чувствительности: например, полностью запрещает запись в логи таких данных, как учетные данные или платежные реквизиты, а для других данных (например, сессионных токенов) использует хеширование или частичное/полное маскирование. | 2 |

## V16.3 Инциденты безопасности

В этом разделе определяются требования к журналированию событий безопасности в приложении. Фиксация этих событий критически важна для выявления подозрительной активности, проведения расследований и выполнения нормативных требований.

В этом разделе описываются типы регистрируемых событий, но он не претендует на исчерпывающую информацию. Каждое приложение имеет уникальные факторы риска и эксплуатационный контекст.

Обратите внимание, что, хотя ASVS включает регистрацию событий безопасности в свою область применения, функции оповещения и корреляции (например, правила SIEM или инфраструктура мониторинга) не входят в сферу применения и обрабатываются операционными системами и системами мониторинга.

| # | Описание | Уровень |
| :---: | :--- | :---: |
| **16.3.1** | Убедитесь, что все операции аутентификации регистрируются, включая успешные и неудачные попытки. Также следует фиксировать дополнительные метаданные, такие как тип аутентификации или использованные факторы проверки. | 2 |
| **16.3.2** | Убедитесь, что ведется журнал неудачных попыток авторизации. Для уровня L3 это должно включать в себя журналирование всех решений об авторизации, включая журналирование доступа к конфиденциальным данным (без регистрации самих конфиденциальных данных). | 2 |
| **16.3.3** | Убедитесь, что приложение регистрирует все события безопасности, определенные в документации, а также фиксирует попытки обхода механизмов защиты, включая проверку входных данных, бизнес-логики и системы защиты от автоматизированных атак. | 2 |
| **16.3.4** | Убедитесь, что приложение регистрирует в журналах неожиданные ошибки и сбои механизмов безопасности, включая, например, ошибки TLS-соединения на стороне сервера. | 2 |

## V16.4 Защита журналов

Журналы представляют собой ценные источники forensic-данных и должны быть надёжно защищены. Если логи можно легко изменить или удалить, они теряют целостность и становятся ненадёжными для расследования инцидентов или судебных разбирательств. Кроме того, журналы могут раскрывать внутреннюю логику работы приложения или содержать конфиденциальные метаданные, что делает их привлекательной целью для злоумышленников.

В данном разделе определены требования, обеспечивающие защиту журналов от несанкционированного доступа, изменений и раскрытия и безопасную передачу и хранение в изолированных защищённых системах.

| # | Описание | Уровень |
| :---: | :--- | :---: |
| **16.4.1** | Убедитесь, что все компоненты системы логирования корректно кодируют данные, чтобы предотвратить атаки типа внедрения в журналы (log injection). | 2 |
| **16.4.2** | Убедитесь, что логи защищены от неавторизованного доступа и не могут быть модифицированы. | 2 |
| **16.4.3** | Убедитесь, что логи безопасно передаются в логически изолированную систему для анализа, обнаружения угроз, генерации оповещений и эскалации инцидентов. Это гарантирует сохранность журналов даже в случае компрометации основного приложения. | 2 |

## V16.5 Обработка ошибок

Данный раздел определяет требования к безопасному и корректному завершению работы приложений в случае сбоев, исключающему раскрытие конфиденциальной внутренней информации.

| # | Описание | Уровень |
| :---: | :--- | :---: |
| **16.5.1** | Убедитесь, что при возникновении непредвиденной или связанной с безопасностью ошибки пользователю возвращается только общее сообщение, гарантируя отсутствие раскрытия конфиденциальных внутренних данных системы, таких как трассировки стека, запросы, секретные ключи и токены. | 2 |
| **16.5.2** | Убедитесь, что приложение продолжает работать в безопасном режиме при недоступности внешних ресурсов, используя такие механизмы, как автоматические выключатели (circuit breakers) или плавное снижение функциональности (graceful degradation). | 2 |
| **16.5.3** | Убедитесь, что приложение корректно и безопасно завершает работу при возникновении исключений, предотвращая опасные сценарии по типу «fail-open», когда, например, транзакция ошибочно выполняется, несмотря на ошибки в логике валидации. | 2 |
| **16.5.4** | Убедитесь, что определён обработчик ошибок «крайние меры», который будет перехватывать все необработанные ошибки. Это необходимо как для предотвращения потери информации об ошибках, которая должна быть записана в файлы журналов, так и для того, чтобы ошибка не остановила весь процесс приложения, что привело бы к потере доступности. | 3 |

Примечание: Некоторые языки программирования (включая Swift, Go и многие функциональные языки в силу их парадигмы) не поддерживают исключения или обработчики событий «крайней меры». В таких случаях архитекторам и разработчикам следует использовать подходы, соответствующие паттернам, языковым особенностям или возможностям фреймворка, чтобы гарантировать безопасную обработку исключительных, непредвиденных или связанных с безопасностью событий.

## Ссылки

Для дополнительной информации см. также:

* [OWASP Web Security Testing Guide: Testing for Error Handling](https://owasp.org/www-project-web-security-testing-guide/stable/4-Web_Application_Security_Testing/08-Testing_for_Error_Handling/README)
* [OWASP Authentication Cheat Sheet section about error messages](https://cheatsheetseries.owasp.org/cheatsheets/Authentication_Cheat_Sheet.html#authentication-and-error-messages)
* [OWASP Logging Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/Logging_Cheat_Sheet.html)
* [OWASP Application Logging Vocabulary Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/Logging_Vocabulary_Cheat_Sheet.html)

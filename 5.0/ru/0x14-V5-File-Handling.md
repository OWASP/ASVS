# V5 Работа с файлами

## Цель контроля

Использование файлов может нести различные риски для приложения, включая отказ в обслуживании (DoS), несанкционированный доступ и переполнение хранилища. В этой главе приведены требования, для предотвращения этих рисков.

## V5.1 Документация по работе с файлами

Этот раздел содержит требование документировать ожидаемые характеристики файлов, принимаемых приложением, как необходимое условие для разработки и проверки соответствующих мер безопасности.

| # | Описание | Уровень |
| :---: | :--- | :---: |
| **5.1.1** | Убедитесь, что документация определяет допустимые типы файлов, ожидаемые расширения и максимальный размер (включая распакованный размер) для каждой функции загрузки. Также убедитесь, что в документации указано, как файлы обезвреживаются для конечных пользователей (например, как приложение ведёт себя при обнаружении вредоносного файла). | 2 |

## V5.2 Загрузка файлов и содержимое

Функциональность загрузки файлов является основным источником недоверенных файлов. Этот раздел описывает требования, обеспечивающие безопасность приложения от вреда, связанного с наличием, объёмом или содержимым этих файлов.

| # | Описание | Уровень |
| :---: | :--- | :---: |
| **5.2.1** | Убедитесь, что приложение принимает только те файлы, которые может обработать без потери производительности или отказа в обслуживании. | 1 |
| **5.2.2** | Убедитесь, что при загрузке файла (включая файлы внутри архивов, таких как ZIP) приложение проверяет, соответствует ли расширение ожидаемому, и валидирует, соответствует ли содержимое типу, указанному в расширении. Это включает проверку начальных 'magic bytes', перезапись изображений, использование специализированных библиотек. Для уровня 1 — достаточно проверок для файлов, критичных с точки зрения бизнеса или безопасности. Для уровней 2 и выше — для всех файлов. | 1 |
| **5.2.3** | Убедитесь, что приложение проверяет архивы (например, zip, gz, docx, odt) на максимально допустимый распакованный размер и максимальное количество файлов до распаковки. | 2 |
| **5.2.4** | Убедитесь, что для каждого пользователя установлены квоты на общий размер и количество файлов, чтобы один пользователь не мог переполнить хранилище. | 3 |
| **5.2.5** | Убедитесь, что приложение не позволяет загружать архивы с символьными ссылками (symlinks), если это не требуется по бизнес-логике. Если требуется — разрешён только строго определённый список допустимых символьных ссылок. | 3 |
| **5.2.6** | Убедитесь, что приложение отклоняет изображения с числом пикселей выше допустимого, чтобы предотвратить атаки 'pixel flood'. | 3 |

## V5.3 Хранение файлов

Этот раздел содержит требования для предотвращения исполнения файлов после загрузки, обнаружения опасного содержимого и предотвращения использования недоверенных данных для управления путями хранения файлов.

| # | Описание | Уровень |
| :---: | :--- | :---: |
| **5.3.1** | Убедитесь, что загруженные или сгенерированные из недоверенного ввода файлы, находящиеся в публичной директории, не исполняются как серверный код при обращении к ним по HTTP. | 1 |
| **5.3.2** | Убедитесь, что при создании путей к файлам приложение использует внутренние или доверенные данные, а не пользовательские имена файлов. Если использование пользовательских имён или метаданных необходимо — требуется строгая проверка и очистка. Это защита от path traversal, LFI, RFI и SSRF. | 1 |
| **5.3.3** | Убедитесь, что при обработке файлов на сервере (например, при распаковке) игнорируются пути, заданные пользователем, во избежание уязвимостей типа 'zip slip'. | 3 |

## V5.4 Скачивание файлов

Этот раздел содержит требования для снижения рисков при выдаче файлов на загрузку, включая защиту от path traversal и инъекций, а также проверку содержимого.

| # | Описание | Уровень |
| :---: | :--- | :---: |
| **5.4.1** | Убедитесь, что приложение валидирует или игнорирует имена файлов, переданных пользователем (включая в JSON, JSONP или URL-параметре), и указывает имя файла в заголовке Content-Disposition при ответе. | 2 |
| **5.4.2** | Убедитесь, что имена файлов, передаваемые (например, в HTTP-заголовках или вложениях в email), кодируются или очищаются (например, по RFC 6266), чтобы сохранить структуру документа и предотвратить инъекции. | 2 |
| **5.4.3** | Убедитесь, что файлы, полученные из недоверенных источников, сканируются антивирусом, чтобы не распространять известное вредоносное содержимое. | 2 |

## Ссылки

Подробнее:

* [OWASP File Upload Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/File_Upload_Cheat_Sheet.html)
* [Example of using symlinks for arbitrary file read](https://hackerone.com/reports/1439593)
* [Explanation of "Magic Bytes" from Wikipedia](https://en.wikipedia.org/wiki/List_of_file_signatures)

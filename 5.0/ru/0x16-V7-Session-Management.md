# V7 Управление сессиями

## Задачи контроля

Механизмы управления сессиями позволяют приложениям связывать взаимодействия пользователя и устройства во времени, даже при использовании протоколов без состояния (например, HTTP). Современные приложения могут использовать несколько токенов сессии с разными характеристиками и назначением. Безопасная система управления сессиями — это система, предотвращающая получение, использование или иное злоупотребление сессией жертвы злоумышленником. Приложения, поддерживающие сессии, должны соответствовать следующим концептуальным требованиям:

* Сессии уникальны для каждого пользователя, их идентификаторы нельзя угадать, и ими нельзя «поделиться» с другими.
* Сессии становятся недействительными, когда они больше не нужны, т.е. при бездействии пользователя срок действия сессии истекает.

Многие требования в этой главе основаны на [NIST SP 800-63 Digital Identity Guidelines](https://pages.nist.gov/800-63-4/), с фокусом на распространённые угрозы и уязвимости аутентификации.

Обратите внимание, что конкретные требования по реализации различных механизмов управления сессиями приведены в других разделах:

* Требования по безопасности HTTP cookies — в разделе «Безопасность веб-интерфеса».
* Требования по автономным токенам — в разделе «Автономные токены».

## V7.1 Документация по управлению сессиями

Нет единого шаблона, подходящего для всех приложений. Поэтому необходимо проводить анализ рисков с документированием решений по безопасности, касающихся управления сессиями, до реализации и тестирования. Это обеспечивает адаптацию системы управления сессиями к конкретным требованиям приложения.

Независимо от того, используется ли механизм сессий с сохранением состояния (stateful) или без (stateless), анализ должен быть завершён и задокументирован, чтобы продемонстрировать соответствие всем требованиям безопасности. Также необходимо учесть взаимодействие с системами единого входа (SSO), если они используются.

| # | Описание | Уровень |
| :---: | :--- | :---: |
| **7.1.1** | Убедитесь, что тайм-аут бездействия и абсолютное максимальное время жизни сессии задокументированы, соответствуют другим контрольным мерам и сопровождаются обоснованием любых отклонений от требований повторной аутентификации NIST SP 800-63B. | 2 |
| **7.1.2** | Убедитесь, что документация определяет допустимое количество одновременных (параллельных) сессий для одного аккаунта, а также поведение системы и действия при достижении этого лимита. | 2 |
| **7.1.3** | Убедитесь, что все системы, создающие и управляющие сессиями пользователей в рамках федеративной идентификации (например, SSO), задокументированы вместе с механизмами координации сроков действия сессий, условий завершения и случаев, требующих повторной аутентификации. | 2 |

## V7.2 Базовая безопасность сессий

Требования этого раздела обеспечивают безопасное создание и валидацию сессионных токенов.

| # | Описание | Уровень |
| :---: | :--- | :---: |
| **7.2.1** | Убедитесь, что все проверки сессионных токенов выполняются на доверенной серверной стороне. | 1 |
| **7.2.2** | Убедитесь, что приложение использует либо автономные токены, либо ссылочные токены, которые генерируются динамически, не используя статические API-секреты или ключи. | 1 |
| **7.2.3** | Убедитесь, что ссылочные токены являются уникальными, создаются с использованием криптографически безопасного генератора псевдослучайных чисел (CSPRNG) и обладают энтропией не менее 128 бит. | 1 |
| **7.2.4** | Убедитесь, что при аутентификации пользователя (включая повторную) создается новый токен сессии, а текущий — аннулируется. | 1 |

## V7.3 Тайм-ауты сессии

Механизмы тайм-аутов сессии уменьшают временное окно для угонов и других атак. Тайм-ауты должны соответствовать документированным решениям по безопасности.

| # | Описание | Уровень |
| :---: | :--- | :---: |
| **7.3.1** | Убедитесь, что есть тайм-аут бездействия, после которого требуется повторная аутентификация, в соответствии с анализом рисков и документированными решениями. | 2 |
| **7.3.2** | Убедитесь, что установлено абсолютное максимальное время жизни сессии, по истечении которого требуется повторная аутентификация, в соответствии с анализом рисков и документированными решениями. | 2 |

## V7.4 Завершение сессий

Завершение сессии может происходить как со стороны самого приложения, так и через поставщика SSO, если управление сессиями делегировано ему. Завершение сессии должно требовать повторной аутентификации и быть эффективным во всех компонентах: приложении, федеративной аутентификации и других доверяющих сторонах.

Сессии с сохранением состояния обычно аннулируются на серверной стороне. self-contained токены нужно отзывать или блокировать, иначе они могут оставаться действительными до истечения срока их действия.

| # | Описание | Уровень |
| :---: | :--- | :---: |
| **7.4.1** | Убедитесь, что после завершения сессии (logout, истечение срока) дальнейшее её использование невозможно. Для ссылочных токенов или сессий с сохранением состояния это означает аннулирование на сервере. Для self-contained токенов необходимо реализовать механизм отзыва, например, список отозванных токенов, проверку времени выпуска или ротацию ключей подписи для каждого пользователя. | 1 |
| **7.4.2** | Убедитесь, что при удалении или отключении пользователя все активные сессии немедленно завершаются. | 1 |
| **7.4.3** | Убедитесь, что после изменения или удаления факторов аутентификации (например, смена пароля или MFA) приложение предлагает завершить все другие активные сессии. | 2 |
| **7.4.4** | Убедитесь, что на всех страницах, требующих аутентификации, имеется простой и видимый способ выхода. | 2 |
| **7.4.5** | Убедитесь, что администраторы могут завершать активные сессии конкретного пользователя или всех пользователей. | 2 |

## V7.5 Защита от злоупотреблений сессией

Этот раздел направлен на снижение рисков при активных сессиях, включая атаки с использованием действующей сессии жертвы.

При рассмотрении требований этого раздела нужно учитывать рекомендации для конкретных уровней, приведенные в разделе «Аутентификация»

| # | Описание | Уровень |
| :---: | :--- | :---: |
| **7.5.1** | Убедитесь, что приложение требует полной повторной аутентификации перед изменением чувствительных атрибутов аккаунта, которые могут влиять на аутентификацию (например, email, номер телефона, настройки MFA или данных восстановления доступа). | 2 |
| **7.5.2** | Убедитесь, что пользователь может просматривать и (после повторной аутентификации хотя бы по одному фактору) завершать активные сессии. | 2 |
| **7.5.3** | Убедитесь, что перед выполнением критически важных операций приложение требует повторной аутентификации (по крайней мере, одного фактора) или дополнительной проверки. | 3 |

## V7.6 Федеративная повторная аутентификация

Требования для сторон, реализующих логику Relying Party (RP) и Identity Provider (IdP), основаны на [NIST SP 800-63C](https://pages.nist.gov/800-63-4/sp800-63c.html).

| # | Описание | Уровень |
| :---: | :--- | :---: |
| **7.6.1** | Убедитесь, что срок действия и завершение сессий между RP и IdP соответствуют документации и включают повторную аутентификацию, если достигнут максимальный допустимый интервал между событиями аутентификации. | 2 |
| **7.6.2** | Убедитесь, что создание сессии требует согласия пользователя или явного действия, предотвращающего несанкционированное создание сессий без участия пользователя. | 2 |

## Ссылки

Для дополнительной информации см. также:

* [OWASP Web Security Testing Guide: Session Management Testing](https://owasp.org/www-project-web-security-testing-guide/stable/4-Web_Application_Security_Testing/06-Session_Management_Testing)
* [OWASP Session Management Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/Session_Management_Cheat_Sheet.html)

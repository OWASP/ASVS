# V15 Безопасная разработка и архитектура

## Задачи контроля

Многие требования ASVS относятся либо к конкретной области безопасности, такой как аутентификация или авторизация, либо к определённому типу функциональности приложения, например, к логированию или работе с файлами.

В этой главе представлены общие требования безопасности, которые следует учитывать при проектировании и разработке приложений. Эти требования касаются не только чистоты архитектуры и качества кода, но и конкретных практик проектирования и программирования, необходимых для обеспечения безопасности приложений.

## V15.1 Документация по безопасной разработке и архитектуре

Многие требования по созданию безопасной и защищенной архитектуры зависят от четкого документирования решений, принятых в отношении реализации конкретных механизмов безопасности и компонентов, используемых в приложении.

В этом разделе излагаются требования к документации, включая определение компонентов, которые считаются содержащими «опасную функциональность» или «рискованными компонентами».

Компонент с «опасной функциональностью» может быть разработан внутри компании или представлять собой внешнюю зависимость, который выполняет такие операции, как десериализация ненадежных данных, парсинг необработанных файлов или двоичных данных, динамическое выполнение кода или непосредственное управление памятью. Уязвимости в таких операциях создают высокий риск компрометации приложения и его инфраструктуры.

«Компонент с повышенным риском» — это сторонняя библиотека (т.е. не разработанная внутри компании) с отсутствующими или неэффективно реализованными средствами контроля безопасности в отношении процессов разработки или функциональности. Примерами служат компоненты, которые не поддерживаются, находятся на этапе завершения жизненного цикла или ранее содержали серьезные уязвимости.

В этом разделе также подчеркивается важность определения соответствующих сроков устранения уязвимостей в сторонних компонентах.

| # | Описание | Уровень |
| :---: | :--- | :---: |
| **15.1.1** | Убедитесь, что в документации по приложению определены сроки устранения уязвимостей на основе оценки рисков для внешних зависимостей с уязвимостями и для обновления библиотек в целом, чтобы минимизировать риск, связанный с этими компонентами. | 1 |
| **15.1.2** | Убедитесь, что ведется реестр всех используемых сторонних библиотек (например, Software Bill of Materials, SBOM), с обязательной проверкой, что компоненты получены из предопределенных, доверенных и регулярно поддерживаемых репозиториев. | 2 |
| **15.1.3** | Убедитесь, что в документации приложения указан функционал, требующий значительных временных или вычислительных ресурсов. Необходимо указать, как предотвратить потерю доступности из-за чрезмерного использования этого функционала и как избежать ситуаций, когда формирование ответа занимает больше времени, чем установленный системой таймаут. Возможные меры защиты могут включать асинхронную обработку, использование очередей и ограничение количества параллельных процессов для каждого пользователя и приложения. | 2 |
| **15.1.4** | Убедитесь, что в документации приложения указаны внешние библиотеки, которые считаются «компонентами с повышенным риском». | 3 |
| **15.1.5** | Убедитесь, что в документации приложения выделены те части приложения, в которых используются «функционал с повышенным риском». | 3 |

## V15.2 Архитектура безопасности и зависимости

В этом разделе содержатся требования по работе с уязвимыми, устаревшими и небезопасными зависимостями и компонентами посредством управления зависимостями.

Он также включает использование методов архитектурного уровня, таких как «песочница», инкапсуляция, контейнеризация и сетевая изоляция, для снижения влияния использования «операций с повышенным риском» и «компонентов с повышенным риском» (как определено в предыдущем разделе) и предотвращения потери доступности из-за чрезмерного использования ресурсоемких функций.

| # | Описание | Уровень |
| :---: | :--- | :---: |
| **15.2.1** | Убедитесь, что приложение содержит только те компоненты, которые не нарушили задокументированные сроки обновления и исправления. | 1 |
| **15.2.2** | Убедитесь, что в приложении реализованы меры защиты от потери доступности из-за функциональности, требующей много времени или ресурсов, на основе задокументированных решений и стратегий безопасности для этого. | 2 |
| **15.2.3** | Убедитесь, что производственная среда включает только те функции, которые необходимы для работы приложения, и не предоставляет лишние функции, такие как тестовый код, примеры кода и инструменты разработки. | 2 |
| **15.2.4** | Убедитесь, что сторонние компоненты и все их транзитивные зависимости загружаются только из ожидаемых репозиториев (внутренних или внешних) и отсутствует риск атаки через подмену зависимостей (dependency confusion attack) | 3 |
| **15.2.5** | Убедитесь, что приложение реализует дополнительные меры защиты для тех частей приложения, которые документированы как содержащие «функционал с повышенным риском» или использующие сторонние библиотеки, считающиеся «функционалом с повышенным риском». Это могут быть такие методы, как «песочница», инкапсуляция, контейнеризация или изоляция на сетевом уровне, чтобы задержать и предотвратить продвижение (pivoting) злоумышленников, скомпрометировавших одну часть приложения, к другим частям приложения. | 3 |

## V15.3 Безопасное программирование

В этом разделе рассматриваются типы уязвимостей, включая type juggling, prototype pollution и другие, возникающие из-за использования небезопасных паттернов программирования на конкретном языке. Некоторые уязвимости актуальны не для всех языков, тогда как другие требуют исправлений, зависящих от конкретного языка программирования, или связаны с особенностями обработки функций (например, HTTP-параметров) в конкретном языке или фреймворке. Также рассматривается риск установки обновлений приложения без криптографической проверки.

В данном разделе также рассматриваются риски, связанные с использованием объектов для представления данных и их передачей через внешние API. В этом случае приложение должно гарантировать, что поля данных, которые не должны быть доступны для записи, не будут изменены пользовательским вводом (mass assignment), и что API избирательно определяет, какие поля данных возвращаются. Если доступ к полю зависит от прав пользователя, это следует рассматривать в контексте требования к контролю доступа на уровне полей в главе «Авторизация».

| # | Описание | Уровень |
| :---: | :--- | :---: |
| **15.3.1** | Убедитесь, что приложение возвращает только необходимое подмножество полей из объекта данных. Например, оно не должно возвращать весь объект данных, поскольку некоторые отдельные поля должны быть недоступны пользователям. | 1 |
| **15.3.2** | Убедитесь, что при вызовах внешних URL-адресов бэкэнд приложения настроен так, чтобы не выполнять перенаправления, если только это не предусмотрено функционалом. | 2 |
| **15.3.3** | Убедитесь, что в приложении реализованы защитные механизмы против атак типа массового присвоения (mass assignment) путем строгого ограничения разрешенных полей для каждого контроллера и действия, исключая возможность добавления или изменения значений полей, которые не должны быть доступны для данной конкретной операции. | 2 |
| **15.3.4** | Убедитесь, что все прокси и промежуточное ПО корректно передают исходный IP-адрес пользователя, используя доверенные поля данных, которые не могут быть изменены конечным пользователем, а приложение и веб-сервер используют это правильное значение для ведения логирования и принятия решений по безопасности, таких как ограничение запросов. При этом следует учитывать, что даже исходный IP-адрес может быть ненадежным из-за динамических IP-адресов, VPN или корпоративных файрволов. | 2 |
| **15.3.5** | Убедитесь, что приложение явно проверяет соответствие переменных ожидаемому типу данных и использует строгие операции сравнения. Это необходимо для предотвращения уязвимостей, связанных с type juggling и type confusion, вызванных тем, что код приложения делает предположения о типе переменной. | 2 |
| **15.3.6** | Убедитесь, что JavaScript-код написан таким образом, чтобы предотвратить prototype pollution, например, используя Set() или Map() вместо обычных литералов объекта. | 2 |
| **15.3.7** | Убедитесь, что приложение защищено от атак типа HTTP Parameter Pollution (HPP), особенно если используемый фреймворк не различает источники параметров запроса (строка запроса, тело запроса, куки или заголовки). | 2 |

## V15.4 Безопасная работа с параллельными процессами

Проблемы безопасности работы параллельных процессов, такие как состояния гонки (race conditions), уязвимости типа «проблем синхронизации проверки и использования ресурсов» (TOCTOU), взаимные блокировки (deadlocks), постоянно повторяющиеся блокировки (livelocks), нехватка ресурсов у потоков (thread starvation) и некорректная синхронизация (improper synchronization), могут приводить к неожиданному поведению системы и создавать угрозы безопасности. В этом разделе рассматриваются различные методы и стратегии, помогающие снизить эти риски.

| # | Описание | Уровень |
| :---: | :--- | :---: |
| **15.4.1** | Убедитесь, что к общим объектам в многопоточном коде (например, кэшам, файлам или объектам в памяти, используемым несколькими потоками) используется безопасный многопоточный доступ и механизмов синхронизации, таких как блокировки или семафоры, чтобы избежать состояний гонки и повреждения данных. | 3 |
| **15.4.2** | Убедитесь, что проверки состояния ресурса, например его существования или разрешений, а также зависящие от него действия выполняются как одна атомарная операция, чтобы предотвратить условия гонки времени проверки и времени использования (TOCTOU). Например, проверка существования файла перед его открытием или проверка прав доступа пользователя перед его предоставлением. | 3 |
| **15.4.3** | Убедитесь, что блокировки применяются согласованно, чтобы предотвратить взаимные блокировки потоков (deadlocks) или их бесконечные повторы, а также что логика блокировки инкапсулирована в коде, отвечающем за управление ресурсом. Это гарантирует, что блокировки не могут быть случайно или намеренно изменены внешними классами или кодом. | 3 |
| **15.4.4** | Убедитесь, что политики распределения ресурсов предотвращают нехватку ресурсов у потоков, обеспечивая справедливый доступ к ресурсам, например, используя пулы потоков, позволяя потокам с более низким приоритетом выполняться в течение разумного периода времени. | 3 |

## Ссылки

Для дополнительной информации см. также:

* [OWASP Prototype Pollution Prevention Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/Prototype_Pollution_Prevention_Cheat_Sheet.html)
* [OWASP Mass Assignment Prevention Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/Mass_Assignment_Cheat_Sheet.html)
* [OWASP CycloneDX Bill of Materials Specification](https://owasp.org/www-project-cyclonedx/)
* [OWASP Web Security Testing Guide: Testing for HTTP Parameter Pollution](https://owasp.org/www-project-web-security-testing-guide/stable/4-Web_Application_Security_Testing/07-Input_Validation_Testing/04-Testing_for_HTTP_Parameter_Pollution)

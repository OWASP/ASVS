# V11 Криптография

## Цель контроля

Цель этой главы - определить наилучшие методы общего использования криптографии, а также привить фундаментальное понимание ее принципов и стимулировать переход к более устойчивым и современным подходам. В ней рассмотрены следующие пункты:

* Внедрение надежных криптографических систем, которые являются отказоустойчивыми, адаптируются к меняющимся угрозам и ориентированы на будущее.
* Использование криптографических механизмов, которые одновременно являются безопасными и соответствуют лучшим практикам индустрии.
* Поддержка безопасной системы управления криптографическими ключами с надлежащим контролем доступа и аудитом.
* Регулярная оценка криптографической отрасли для определения рисков и соответствующей адаптации алгоритмов.
* Обнаружение и управление криптографическими сценариями использования на протяжении всего жизненного цикла приложения с целью обеспечения учёта и защиты всех криптографических ресурсов.

В дополнение к обозначенным общим принципам и лучшим практикам данный документ также представляет более углубленную техническую информацию о требованиях в Приложении C - Стандарты криптографии. Он содержит алгоритмы и конфигурации, которые считаются "утвержденными" в соответствии с требованиями, изложенными в данном разделе.

Требования для решения отдельных криптографических задач, таких как управление секретами или обеспечение безопасного соединения будут рассмотрены в разных частях стандарта.

## V11.1 Инвентаризация и документирование криптографии

Приложения должны проектироваться с использованием надёжной криптографической архитектуры для защиты данных в соответствии с их классификацией. Шифровать всё подряд — это расточительно, а не шифровать ничего — юридическая халатность. Необходимо найти баланс, который обычно достигается на этапе архитектурного или высокоуровневого проектирования, в ходе дизайн-спринтов или архитектурных исследований. Проектирование криптографии «на ходу» или доработка её после разработки приложения неизбежно приведёт к гораздо большим затратам на обеспечение безопасности, чем если бы она была заложена с самого начала.

Важно регулярно обнаруживать, вести учёт и оценивать все криптографические активы. В приложении приведена дополнительная информация о том, как это делать.

Также критически важно подготовить криптографические системы к будущему появлению квантовых компьютеров. Постквантовая криптография (Post-Quantum Cryptography, PQC) — это криптографические алгоритмы, разработанные так, чтобы оставаться надёжными против атак квантовых компьютеров, которые, как ожидается, смогут взламывать широко используемые алгоритмы, такие как RSA и эллиптические кривые (ECC).

В приложении также содержатся текущие рекомендации по проверенным PQC-примитивам и стандартам.

| # | Описание | Уровень |
| :---: | :--- | :---: |
| **11.1.1** | Убедитесь, что задокументирована политика управления криптографическими ключами и описан их жизненный цикл в соответствии со стандартом управления ключей, таким как NIST SP 800-57. Убедитесь, что ключи известны только тем сущностям, которым они должны быть доступны (например, ключи не передавались более чем двум участникам для общих секретов и более чем одному участнику для приватных ключей). | 2 |
| **11.1.2** | Убедитесь, что проводится инвентаризация криптографических средств, которая непрерывно поддерживается, регулярно обновляется и включает все криптографические ключи, алгоритмы и сертификаты, используемые в приложении. Также должна быть задокументирована информация о том, где ключи могут и не могут использоваться в системе, а также какие типы данных могут и не могут быть защищены с помощью этих ключей. | 2 |
| **11.1.3** | Убедитесь, что используются механизмы обнаружения криптографии для идентификации всех случаев применения криптографии в системе , включая операции шифрования, хеширования и цифровой подписи. | 3 |
| **11.1.4** | Убедитесь, что ведётся и поддерживается инвентаризация криптографических средств. В неё должен входить документированный план, описывающий переход на новые криптографические стандарты, такие как постквантовая криптография, чтобы своевременно реагировать на будущие угрозы. | 3 |

## V11.2 Безопасная реализация криптографии

Данный раздел содержит требования для определения (выбора), реализации и дальнейшего управления основными криптографическими алгоритмами в приложении. Основная цель - убедиться в том, что используются исключительно надежные, утвержденные криптографические примитивы в соответствии с текущими стандартами (н-р, NIST, ISO/IEC) и лучшими практиками разработки. Организации должны убедиться, что каждый криптографический компонент выбран с учетом рецензируемых исследований и практического тестирования безопасности.

| # | Описание | Уровень |
| :---: | :--- | :---: |
| **11.2.1** | Убедитесь, что для криптографических операций используются  утвержденные в индустрии реализации (включая библиотеки и аппаратные реализации). | 2 |
| **11.2.2** | Убедитесь, что архитектура приложения поддерживает быструю реконфигурацию, усовершенствование или смену в любой момент случайных чисел, аутентифицированного шифрования, MAC, алгоритмов хеширования, длин ключей, количества раундов, шифров и режимов шифрования для защиты от криптографических атак. Также должна поддерживаться возможность смены ключей, паролей и повторного шифрования данных. Это позволит беспрепятственно перейти на постквантовую криптографию (PQC), как только станут широко доступны высоконадёжные реализации одобренных схем или стандартов PQC. | 2 |
| **11.2.3** | Убедитесь, что все криптографические примитивы используют как минимум 128-бит стойкости с учетом алгоритма, размера ключа и конфигурации. Например, 256-битный ECC ключ обеспечивает примерно 128 бит безопасности, тогда как для достижения того же уровня безопасности в RSA требуется ключ длиной 3072 бита. | 2 |
| **11.2.4** | Убедитесь, что все криптографические операции выполняются за константное время, без использования "short-circuit" операций в сравнениях, вычислениях, возвратах функций для избежания утечек информации. | 3 |
| **11.2.5** | Убедитесь, что все криптографические модули обеспечивают безопасное завершение работы при ошибках, а обработка ошибок реализована таким образом, чтобы не создавать уязвимостей, например, таких как атаки Padding Oracle. | 3 |

## V11.3 Алгоритмы шифрования

Алгоритмы аутентифицированного шифрования на основе AES и ChaCha20 составляют основу современной криптографической практики.

| # | Описание | Уровень |
| :---: | :--- | :---: |
| **11.3.1** | Убедитесь, что не используются небезопасные режимы блочного шифрования (н-р, ECB) и слабые схемы дополнения (padding) (н-р, PKCS#1 v1.5). | 1 |
| **11.3.2** | Убедитесь, что используются только утверждённые шифры и режимы, такие как AES с GCM. | 1 |
| **11.3.3** | Убедитесь, что зашифрованные данные защищены от несанкционированного изменения, предпочтительно с использованием утверждённого метода аутентифицированного шифрования или путём комбинирования утверждённого метода шифрования с утверждённым алгоритмом MAC. | 2 |
| **11.3.4** | Убедитесь, что случайные числа (nonce), векторы инициализации (IV) и другие одноразовые числа не используются более одного раза для одной и той же пары ключа шифрования и элемента данных. Метод их генерации должен соответствовать требованиям используемого алгоритма. | 3 |
| **11.3.5** | Убедитесь, что любая комбинация алгоритма шифрования и алгоритма MAC работает в режиме encrypt-then-MAC (EtM). | 3 |

## V11.4 Хеширование и функции на основе хеширования

Криптографические хеш-функции применяются во множестве криптографических протоколов, таких как цифровые подписи, HMAC, функции генерации ключа (KDF), генерация случайных битов и хранение паролей. Безопасность криптографической системы напрямую зависит от стойкости используемых хеш-функций. В этом разделе изложены требования к использованию надёжных хеш-функций в криптографических операциях.

Для хранения паролей, вместе с Приложениием C - Стандарты криптографии, рекомендуем использовать [OWASP Password Storage Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/Password_Storage_Cheat_Sheet.html#password-hashing-algorithms)

| # | Описание | Уровень |
| :---: | :--- | :---: |
| **11.4.1** | Убедитесь, что только утвержденные хэш-функции используются для стандартных сценариев использования в криптографии, включая цифровую подпись, HMAC, KDF, генерацию случайных чисел. Запрещено использовать неустойчивые хэш-функции, (н-р, MD5) для любого использования в криптографии. | 1 |
| **11.4.2** | Убедитесь, что пароли хранятся с использованием утверждённой, вычислительно затратной функции генерации ключа (также известной как «функция хеширования паролей»), с параметрами, настроенными в соответствии с актуальными рекомендациями. Настройки должны обеспечивать баланс между безопасностью и производительностью, чтобы сделать атаки перебором достаточно сложными для требуемого уровня безопасности. | 2 |
| **11.4.3** | Убедитесь, что хэш-функции, используемые в формировании цифровой подписи, как часть аутентификации и целостности данных, устойчивы к коллизиям и имеют достаточную длину. | 2 |
| **11.4.4** | Убедитесь, что приложение использует утвержденную функцию генерации ключа с использованием параметров расширения ключа (key stretching) при генерации ключа из пароля. Параметры должны быть сбалансированы с точки зрения безопасности, производительности и устойчивости к атакам полного перебора при компрометации результирующего криптографического ключа. | 2 |

## V11.5 Случайные значения

Криптографически стойкая генерация псевдослучайных чисел (Cryptographically secure Pseudo-random Number Generation (CSPRNG)) чрезвычайно сложна для правильной реализации. Как правило, хорошие источники энтропии в системе быстро истощаются при чрезмерном использовании, тогда как источники с меньшей степенью случайности могут приводить к предсказуемым ключам и секретам.

| # | Описание | Уровень |
| :---: | :--- | :---: |
| **11.5.1** | Убедитесь, что все случайные числа и строки, которые должны быть непредсказуемы, должны быть сгенерированы с помощью CSPRNG и иметь хотя бы 128 бит энтропии. Учтите, что UUID не удовлетворяют данному условию. | 2 |
| **11.5.2** | Убедитесь, что механизм генерации случайных чисел является надежным даже при высокой нагрузке. | 3 |

## V11.6 Криптография с публичным ключом

Криптография с публичным ключом используется там, где невозможно или нежелательно распределять ключ между несколькими сторонами.

Также существует потребность в утвержденных методах обмена ключами, таких как Diffie-Hellman (DH) и Elliptic Curve Diffie-Hellman (ECDH), чтобы убедиться, что криптосистема остается безопасной к современным угрозам. Раздел "Безопасная коммуникация" содержит требования для TLS, так что требования данной секции применимы в ситуациях, где криптография с открытым ключом используется отдельно от TLS.

| # | Описание | Уровень |
| :---: | :--- | :---: |
| **11.6.1** | Убедитесь, что только утвержденные криптографические алгоритмы и режимы операций используются для генерации ключа и инициализации случайного значения для его генерации (seeding), а также для генерации цифровой подписи и верификации. Алгоритмы генерации ключей не должны генерировать небезопасные ключи уязвимые к известным атакам, например, ключи RSA уязвимы к факторизации Ферма. | 2 |
| **11.6.2** | Убедитесь, что для обмена ключами используются утверждённые криптографические алгоритмы (например, Диффи-Хеллман) с особым вниманием к обеспечению использования безопасных параметров. Это предотвратит атаки на процесс установления ключа, которые могут привести к атакам «человек посередине» или криптографическим взломам. | 3 |

## V11.7 Шифрование данных в процессе использования

Защита данных во время их обработки имеет первостепенное значение. Рекомендуется использовать такие методы, как полное шифрование памяти, шифрование данных при передаче, а также обеспечение как можно более быстрого шифрования данных после их использования.

| # | Описание | Уровень |
| :---: | :--- | :---: |
| **11.7.1** | Убедитесь, что используется полное шифрование памяти, которое защищает конфиденциальные данные во время их использования, предотвращая доступ к ним неавторизованных пользователей или процессов. | 3 |
| **11.7.2** | Убедитесь, что минимизация данных обеспечивает раскрытие минимально необходимого объёма данных во время обработки, а также что данные шифруются сразу после использования или как можно скорее. | 3 |

## Ссылки

Подробнее:

* [OWASP Web Security Testing Guide: Testing for Weak Cryptography](https://owasp.org/www-project-web-security-testing-guide/stable/4-Web_Application_Security_Testing/09-Testing_for_Weak_Cryptography)
* [OWASP Cryptographic Storage Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/Cryptographic_Storage_Cheat_Sheet.html)
* [FIPS 140-3](https://csrc.nist.gov/pubs/fips/140-3/final)
* [NIST SP 800-57](https://csrc.nist.gov/publications/detail/sp/800-57-part-1/rev-5/final)

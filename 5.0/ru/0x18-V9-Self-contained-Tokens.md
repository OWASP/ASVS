# V9 Автономные токены

## Задачи контроля

В оригинальном RFC 6749 OAuth 2.0 от 2012 года упоминается концепция автономного токена (self-contained token). Она относится к токенам, которые содержат данные или утверждения (claims), на основе которых получатель будет принимать решения по безопасности. Автономный токен следует отличать от простого токена, содержащего только идентификатор, который принимающая сторона использует для локального поиска данных.

Наиболее распространёнными примерами автономных токенов являются JSON Web Tokens (JWTs) и SAML Assertions. Но автономные токены получили широкое распространение даже за пределами OAuth и OIDC. Безопасность этой концепции зависит от возможности проверить целостность токена и убедиться, что он действителен для конкретного контекста. Этот процесс сопряжен с множеством подводных камней, и в этой главе подробно описываются механизмы, помогающие приложениям обходить их.

## V9.1 Источник токена и его целостность

В данном разделе изложены требования, гарантирующие, что токен был выпущен доверенной стороной и не был модифицирован.

| # | Description | Level |
| :---: | :--- | :---: |
| **9.1.1** | Убедитесь, что автономные токены проверяются на целостность с помощью цифровой подписи или MAC, прежде чем доверять их содержимому. | 1 |
| **9.1.2** | Проверяйте, что автономные токены создаются и проверяются исключительно с помощью алгоритмов из списка допустимых в данном контексте. Список допустимых алгоритмов должен включать только разрешенные алгоритмы (желательно либо только симметричные, либо только асимметричные) и ни в коем случае не содержать алгоритм None. Если необходимо поддерживать оба типа алгоритмов, потребуются дополнительные средства контроля для предотвращения путаницы с ключами (key confusion). | 1 |
| **9.1.3** | Убедитесь, что ключи, используемые для проверки автономных токенов, получены из доверенных, предварительно настроенных источников. Это предотвращает возможность указания злоумышленниками ненадёжных источников и ключей. Для JWT и других JWS структур заголовки 'jku', 'x5u' и 'jwk' должны проверяться по белому списку. | 1 |

## V9.2 Содержимое токена

Прежде чем принимать решения по безопасности на основе данных из токена, важно проверить два момента: что срок действия токена актуален на момент предъявления, и что токен предназначен для использования принимающим сервисом в тех целях, для которых он был передан. Это предотвращает небезопасное перекрестное использование токена между различными сервисами или использование разного типа токенов от одного и того же эмитента.

Конкретные требования для OAuth и OIDC рассматриваются в соответствующей главе.

| # | Description | Level |
| :---: | :--- | :---: |
| **9.2.1** | Убедитесь, что при указанном сроке действия токен и его содержимое принимаются только в том случае, если срок действия токена не истёк. Например, для JWT нужно проверить поля 'nbf' и 'exp'. | 1 |
| **9.2.2** | Убедитесь, что сервис, принимающий токен, проверяет его тип и соответствие назначению перед обработкой содержимого токена. Например, для принятия решений об авторизации могут быть приняты только Access Token, а для подтверждения аутентификации пользователя — только ID Token. | 2 |
| **9.2.3** | Убедитесь, что сервис принимает только токены, предназначенные для использования с этим сервисом (audience). Для JWT это можно сделать, проверив наличие утверждения «aud» по белому списку, определенному в сервисе. | 2 |
| **9.2.4** | Убедитесь, что, если эмитент токенов использует один и тот же закрытый ключ для выпуска токенов различным сервисам (audiences), выпущенные токены содержат явное указание целевых сервисов. Это предотвратит повторное использования токенов в не предназначенных для них сервисах. Если идентификатор сервиса (audience identifier) назначается динамически, эмитент токенов должен проверить audiences для исключения подмены получателей (audience impersonation). | 2 |

## Ссылки

Для дополнительной информации см. также:

* [OWASP JSON Web Token Cheat Sheet for Java Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/JSON_Web_Token_for_Java_Cheat_Sheet.html) (но имеет полезные общие рекомендации)

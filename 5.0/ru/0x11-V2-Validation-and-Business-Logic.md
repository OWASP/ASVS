# V2 Валидация и бизнес-логика

## Задачи контроля

Цель этой главы — убедиться, что проверенное приложение соответствует следующим высокоуровневым целям:

* Входные данные, полученные приложением, соответствуют бизнес- или функциональным ожиданиям.
* Поток бизнес-логики последователен, выполняется по порядку и не может быть обойден.
* Бизнес-логика содержит ограничения и механизмы для обнаружения и предотвращения автоматизированных атак, таких как постоянные небольшие переводы средств или добавление миллиона друзей по одному за раз.
* Критически важные потоки бизнес-логики учитывают случаи злоупотреблений и действий злоумышленников и имеют защиту от подмены, подделки, раскрытия информации и атак с повышением привилегий.

## V2.1 Документация валидации и бизнес-логики

Документация по валидации и бизнес-логике должна четко определять ограничения бизнес-логики, правила валидации и контекстную согласованность объединенных данных, чтобы было понятно, что необходимо реализовать в приложении.

| # | Описание | Уровень |
| :---: | :--- | :---: |
| **2.1.1** | Убедитесь, что в документации приложения определены правила проверки входных данных на соответствие ожидаемой структуре. Это могут быть распространённые форматы данных, такие как номера кредитных карт, адреса электронной почты, номера телефонов, или внутренний формат данных. | 1 |
| **2.1.2** | Убедитесь, что в документации приложения указано, как проверять логическую и контекстную согласованность объединенных данных, например, проверять соответствие района и почтового индекса. | 2 |
| **2.1.3** | Убедитесь, что ожидания относительно ограничений и проверок бизнес-логики задокументированы как для уровня отдельного пользователя, так и для глобального уровня всего приложения. | 2 |

## V2.2 Валидация ввода

Эффективные средства контроля валидации входных данных обеспечивают соответствие бизнес- или функциональных ожиданий приложения относительно типа данных. Такой контроль валидации обеспечивает высокое качество данных и уменьшает поверхность атаки. Однако такой контроль не устраняет и не заменяет необходимость использования корректного кодирования, параметризации или санитизации данных при использовании данных в другом компоненте или для их представления для вывода.

В данном контексте «входные данные» могут поступать из самых разных источников, включая поля HTML-форм, запросы REST, параметры URL, поля заголовков HTTP, файлы cookie, файлы на диске, базы данных и внешние API.

Механизм бизнес-логики может проверять, что конкретное входное значение представляет собой число меньше 100. Функционал будет проверять и ожидать, что число ниже определенного порогового значения, поскольку это число определяет количество повторений конкретного цикла, а большое значение может привести к чрезмерной нагрузке и потенциальному отказу в обслуживании.

Хотя валидация по схеме явно не предписана, она может быть наиболее эффективным механизмом для полного охвата валидацией HTTP API или других интерфейсов, использующих JSON или XML.

Обратите внимание на следующие моменты при валидации по схеме:

* «Опубликованная версия» спецификации валидации по JSON-схеме считается готовой к использованию, но, грубо говоря, «нестабильной». При использовании валидации по JSON-схеме убедитесь в отсутствии расхождений с приведенными ниже требованиями.
* Любые используемые библиотеки валидации по JSON-схеме также следует отслеживать и при необходимости обновлять после формализации стандарта.
* Валидацию DTD не следует использовать, а оценку DTD фреймворка следует отключить, чтобы избежать проблем с атаками XXE на DTD.

| # | Описание | Уровень |
| :---: | :--- | :---: |
| **2.2.1** | Убедитесь, что входные данные провалидированы для обеспечения соответствия бизнес- или функциональным ожиданиям. Валидация должна осуществляться либо по списку допустимых значений, шаблонов и диапазонов, либо путем сравнения входных данных с ожидаемой структурой и логическими ограничениями в соответствии с предопределенными правилами. Для L1 валидация может быть сосредоточена на входных данных, используемых для принятия конкретных бизнес-решений или решений, связанных с безопасностью. Для L2 и выше это должно применяться ко всем входным данным. | 1 |
| **2.2.2** | Убедитесь, что приложение разработано с принудительной валидацией входных данных на уровне доверенного сервиса. Хотя проверка на стороне клиента повышает удобство использования и должна поощряться, на неё не следует полагаться как на средство контроля безопасности. | 1 |
| **2.2.3** | Убедитесь, что приложение обеспечивает обоснованность комбинаций данных в соответствии с предопределенными правилам. Например: возраст должен соответствовать дате рождения; страна и почтовый индекс; количество товара в заказе и на складе. | 2 |

## V2.3 Безопасность бизнес-логики

В этом разделе рассматриваются ключевые требования, гарантирующие, что приложение обеспечит корректное выполнение процессов бизнес-логики и не будет уязвимо для атак, использующих логику и поток работы приложения.

| # | Описание | Уровень |
| :---: | :--- | :---: |
| **2.3.1** | Убедитесь, что приложение обрабатывает потоки бизнес-логики для одного и того же пользователя в ожидаемом последовательном порядке шагов и без пропуска шагов. | 1 |
| **2.3.2** | Убедитесь, что ограничения бизнес-логики реализованы в соответствии с документацией приложения, чтобы избежать эксплуатации её недостатков. | 2 |
| **2.3.3** | Убедитесь, что транзакции используются на уровне бизнес-логики таким образом, что операция бизнес-логики либо выполняется полностью, либо откатывается к предыдущему корректному состоянию. | 2 |
| **2.3.4** | Убедитесь, что на уровне бизнес-логики используются механизмы блокировки, чтобы гарантировать невозможность двойного бронирования ограниченных по количеству ресурсов (например, мест в театре или слотов доставки) путем манипулирования логикой приложения. | 2 |
| **2.3.5** | Убедитесь, что для важных потоков бизнес-логики требуется многопользовательское (multi-user) одобрение, чтобы предотвратить несанкционированные или случайные действия. Потоки бизнес-логики могут включать, помимо прочего, крупные денежные переводы, утверждение контрактов, доступ к секретной информации или обход ограничений безопасности на производстве. | 3 |

## V2.4 Анти-автоматизация

В этом разделе представлены меры по борьбе с автоматизацией, гарантирующие необходимость взаимодействия, аналогичного человеческому, и предотвращают чрезмерные автоматизированные запросы.

| # | Описание | Уровень |
| :---: | :--- | :---: |
| **2.4.1** | Убедитесь, что используются средства противодействия автоматизации для защиты от чрезмерных вызовов функций приложения, которые могут привести к утечке данных, созданию ненужных данных, исчерпанию квот, нарушению ограничений скорости, отказу в обслуживании или чрезмерному использованию дорогостоящих ресурсов. | 2 |
| **2.4.2** | Убедитесь, что потоки бизнес-логики требуют реалистичного человеческого времени, предотвращая чрезмерно быструю отправку транзакций. | 3 |

## Ссылки

Для дополнительной информации см. также:

* [OWASP Web Security Testing Guide: Input Validation Testing](https://owasp.org/www-project-web-security-testing-guide/v42/4-Web_Application_Security_Testing/07-Input_Validation_Testing/README.html)
* [OWASP Web Security Testing Guide: Business Logic Testing](https://owasp.org/www-project-web-security-testing-guide/v42/4-Web_Application_Security_Testing/10-Business_Logic_Testing/README)
* Анти-автоматизация может быть достигнута разными путями, включая применение [OWASP Automated Threats to Web Applications](https://owasp.org/www-project-automated-threats-to-web-applications/)
* [OWASP Input Validation Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/Input_Validation_Cheat_Sheet.html)
* [JSON Schema](https://json-schema.org/specification.html)

# V1 Encoding and Sanitization

## هدف

این فصل به ضعف‌های رایج امنیتی در برنامه‌های وب می‌پردازد که ناشی از پردازش ناامن داده‌های غیرقابل‌اعتماد است. چنین ضعف‌هایی ممکن است منجر به آسیب‌پذیری‌های فنی مختلفی شوند، در شرایطی که داده‌های غیرقابل‌اعتماد، مطابق با دستور زبان مفسر مربوطه تفسیر می‌شوند.

در برنامه‌های وب مدرن، همواره بهترین کار استفاده از APIهای امن‌تر مانند parameterized queries، auto-escaping یا templating frameworks است. در غیر این صورت، اجرای دقیق و محتاطانه‌ی encoding، escaping یا sanitization برای امنیت برنامه حیاتی خواهد بود.

اعتبارسنجی ورودی به‌عنوان مکانیزم «دفاع در عمق» عمل می‌کند و از ورود محتوای غیرمنتظره یا خطرناک جلوگیری می‌کند. با این حال، از آنجا که هدف اصلی آن تطابق محتوا با الزامات عملکردی و تجاری است، الزامات مرتبط با آن در فصل «اعتبارسنجی و منطق کسب‌وکار» آمده است.

## V1.1 ساختار Encoding and Sanitization

در بخش‌های زیر، الزامات مختص سورس کد  یا مختص مفسر برای پردازش امن داده‌های ناامن به‌منظور جلوگیری از آسیب‌پذیری‌های امنیتی ارائه شده‌اند. این الزامات، ترتیب انجام این پردازش و محل مناسب اجرای آن را پوشش می‌دهند. همچنین، هدف آن‌ها این است که هنگام ذخیره‌سازی داده، محتوا در حالت اولیه خود باقی بماند و به‌صورت encoded یا escaped (مثلاً HTML encoding) ذخیره نشود تا از بروز مشکلات ناشی از رمزگذاری دوگانه (double encoding) جلوگیری شود.

| #         | Description                                                                                                                                                                                                                                                                              | Level |
|:---------:|:---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |:-----:|
| **1.1.1** | ورودی فقط یک‌بار به فرم استاندارد decoded  یا unescaped شود، و این تنها زمانی انجام شود که انتظار می‌رود داده واقعاً در آن قالب رمزگذاری‌شده دریافت شده باشد. این فرآیند باید قبل از هرگونه پردازش بعدی روی ورودی انجام شود، و به‌هیچ‌وجه نباید پس از اعتبارسنجی یا پاک‌سازی انجام گیرد. | 2     |
| **1.1.2** | برنامه فرآیند encode و escape خروجی را به‌عنوان آخرین مرحله انجام می‌دهد؛ به‌گونه‌ای که این عملیات یا دقیقاً پیش از استفاده داده در مفسر مربوطه انجام شود، یا اینکه خود مفسر به‌طور داخلی این کار را انجام دهد.                                                                          | 2     |

## V1.2 پیشگیری از تزریق

encode و escape خروجی‌ها زمان دریافت ورودی‌های حساس که ممکن است منجر به تزریق شوند، برای امنیت برنامه حیاتی است. معمولاً این encode و escape خروجی ذخیره نمی‌شوند، بلکه صرفاً برای ایمن‌سازی نمایش در همان لحظه در مفسر استفاده می‌شوند. انجام زودهنگام این عملیات ممکن است باعث خرابی محتوا یا بی‌اثر شدن فرایند encoding و escaping شود.

در بسیاری از موارد، کتابخانه‌های نرم‌افزاری توابع امن یا امن‌تری را برای انجام خودکار این کار ارائه می‌دهند، با این حال باید اطمینان حاصل شود که برای زمینه (context) موردنظر صحیح هستند.

| #          | Description                                                                                                                                                                                                                                                                                                                                                                                                                                                         | Level |
|:----------:|:------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |:-----:|
| **1.2.1**  | encoding خروجی برای پاسخ HTTP، سند HTML یا سند XML با زمینه‌ای که داده در آن استفاده می‌شود باید متناسب باشد؛ برای مثال، در رمزگذاری کاراکترهای مربوط به عناصر HTML، صفات HTML، توضیحات HTML، CSS یا فیلدهای هدر HTTP به‌گونه‌ای عمل شود که ساختار پیام یا سند تغییر نکند.                                                                                                                                                                                          | 1     |
| **1.2.2**  | هنگام ساخت پویا آدرس‌های URL، داده‌های غیرقابل‌اعتماد باید متناسب با زمینه استفاده‌شان رمزگذاری شوند (مثلاً URL   Encoding   یا base64url برای پارامترهای کوئری یا مسیر) همچنین اطمینان حاصل شود که فقط پروتکل‌های امن در URL مجاز باشند (برای نمونه، استفاده از JavaScript:  یا data:  ممنوع شود)                                                                                                                                                                  | 1     |
| **1.2.3**  | هنگام تولید پویا محتوای JavaScript (از جملهJSON)، از encoding یا escaping  خروجی استفاده شود تا از تغییر ساختار پیام یا سند جلوگیری گردد (و از حملات تزریق JavaScript یا JSON پیشگیری شود).                                                                                                                                                                                                                                                                         | 1     |
| **1.2.4**  | در انتخاب داده یا اجرای کوئری‌های پایگاه داده (مانند SQL، HQL، NoSQL ...)، از parameterized queries، ORMها، یا Entity Framework استفاده شود یا به روش‌های دیگر، برنامه در برابر تزریق SQL و سایر حملات تزریقی پایگاه داده ایمن شده باشد. این موضوع هنگام نوشتن stored procedure‌ها نیز صدق می‌کند.                                                                                                                                                                  | 1     |
| **1.2.5**  | برنامه در برابر تزریق دستورات سیستم‌عامل (OS command injection) محافظت شده است و در فراخوانی‌های سیستم‌عامل، از کوئری‌های پارامتری‌شده سیستم‌عامل یا Encoding خروجی دستورات سیستم‌عاملی استفاده می‌شود.                                                                                                                                                                                                                                                             | 1     |
| **1.2.6**  | برنامه در برابر آسیب‌پذیری‌های تزریق LDAP محافظت شده است، یا اینکه کنترل‌های امنیتی مشخصی برای جلوگیری از تزریق LDAP پیاده‌سازی شده‌اند.                                                                                                                                                                                                                                                                                                                            | 2     |
| **1.2.7**  | برنامه در برابر حملات تزریقXPath، به‌وسیله‌ی استفاده از کوئری‌های پارامتری‌شده یا کوئری‌های از پیش‌کامپایل‌شده محافظت شده باشد.                                                                                                                                                                                                                                                                                                                                     | 2     |
| **1.2.8**  | پردازشگرهای LaTeX به‌صورت امن پیکربندی شده‌اند (برای نمونه با عدم استفاده از گزینه‌ی --shell-escape ) و از فهرست مجاز دستورات (allowlist) برای جلوگیری از حملات تزریق LaTeX استفاده شده است.                                                                                                                                                                                                                                                                        | 2     |
| **1.2.9**  | برنامه کاراکترهای ویژه در عبارات Regex  را escape می‌کند (معمولاً با استفاده از \)، تا این کاراکترها به‌اشتباه به‌عنوان متاکاراکتر تفسیر نشوند.                                                                                                                                                                                                                                                                                                                     | 2     |
| **1.2.10** | برنامه در برابر حملات تزریق CSV و فرمول (Formula Injection) محافظت شده است. برنامه باید هنگام خروجی‌ گرفتن فایل‌های CSV، از قوانین escape تعیین‌شده در بخش‌های ۲.۶ و ۲.۷ استاندارد RFC 4180 پیروی کند. همچنین، هنگام خروجی گرفتن به فرمت CSV یا سایر فرمت‌های صفحه‌گسترده (مانند XLS، XLSX یا ODF)، اگر کاراکترهای ویژه‌ای مانند '='، '+'، '-'، '@'، \t (tab) و 0\ (Null character) در ابتدای مقدار یک فیلد قرار داشته باشند، باید با یک تک‌کوتیشن (') escape شوند. | 3     |

نکته: استفاده از کوئری‌های پارامتری‌شده (Parameterized Queries) یا  Escapingداده‌ها در SQL همیشه به‌تنهایی کافی نیست. بخش‌هایی از کوئری مثل نام جدول‌ها و ستون‌ها (از جمله نام ستون‌هایی که در دستور ORDER BY استفاده شده‌اند) را نمی‌توان با escape کردن امن کرد .اگر داده‌هایی که کاربر وارد کرده (حتی بعد از escape کردن) در این بخش‌ها استفاده شوند، ممکن است:کوئری به‌درستی اجرا نشود (خطای SQL بده)، یا باعث حمله‌ی SQL Injection شود.

## V1.3 پاک‌سازی (Sanitization)

ایده‌آل‌ترین روش محافظت در برابر استفاده از محتوای غیرقابل اعتماد در یک بستر ناامن، استفاده از encoding یا escaping متناسب با همان بستر است؛ روشی که معنای اصلی محتوای ناامن را حفظ می‌کند اما آن را برای استفاده در همان زمینه ایمن می‌سازد — همان‌طور که در بخش قبلی به‌تفصیل توضیح داده شد. 

اما اگر این امکان وجود نداشته باشد، باید از sanitization (پاک‌سازی) استفاده شود؛ یعنی حذف کاراکترها یا بخش‌هایی از محتوا که ممکن است خطرناک باشند. در برخی موارد، این کار ممکن است باعث تغییر معنای ورودی شود، اما از منظر امنیتی، چاره‌ای جز این وجود ندارد.

| #          | Description                                                                                                                                                                                                                                                                                                                                                                     | Level |
|:----------:|:------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |:-----:|
| **1.3.1**  | تمام ورودی‌های HTML غیرقابل اعتماد (مثلاً از طریق ویرایشگرهای WYSIWYG یا ابزارهای مشابه)، با استفاده از یک کتابخانه یا قابلیت امن و معتبر sanitization (پاک‌سازی) ‌شوند.                                                                                                                                                                                                        | 1     |
| **1.3.2**  | برنامه استفاده از تابعeval یا سایر قابلیت‌های اجرای پویا (dynamic) کد، مانند Spring Expression Language (SpEL)، اجتناب ‌کند. در مواردی که استفاده از این قابلیت‌ها اجتناب‌ناپذیر است، ورودی‌های کاربر که در اجرای کد گنجانده می‌شوند باید پیش از اجرا، به‌طور کامل پاک‌سازی (sanitized) شوند.                                                                                   | 1     |
| **1.3.3**  | بخش‌های حائز اهمیت که احتمال وقوع حملات ناشی از ورودی‌های کاربر در آنها بالاست؛ باید پیشاپیش عملیاتSanitization  جهت اقدامات ایمنی روی داده‌ها انجام شود؛ برای مثال، تنها کاراکترهایی که برای آن محتوا ایمن محسوب می‌شوند مجاز باشند، و ورودی‌های بیش‌از‌حد بلند نیز کوتاه (trim) شوند.                                                                                         | 2     |
| **1.3.4**  | محتوای اسکریپت‌پذیر (scriptable) فایل‌های SVG که توسط کاربر ارائه می‌شود، مورد اعتبارسنجی یا پاک‌سازی (sanitization) قرار گرفته باشد تا فقط شامل تگ‌ها و ویژگی‌هایی (attributes) باشد که برای برنامه ایمن هستند؛ برای مثال، از درج اسکریپت‌ها و عناصر خطرناک مانند foreignObject جلوگیری شده باشد.                                                                              | 2     |
| **1.3.5**  | برنامه محتوای زبان‌های قالب‌نویسی یا اسکریپت‌پذیر ارائه‌شده توسط کاربر، مانند Markdown، CSS یا استایل‌شیت‌های XSL، BBCode یا موارد مشابه را پاک‌سازی (sanitize) کرده یا غیرفعال کرده باشد.                                                                                                                                                                                      | 2     |
| **1.3.6**  | برنامه در برابر حملات جعل درخواست سمت سرور (SSRF) محافظت شده باشد؛ به این صورت که داده‌های غیرقابل اعتماد را در برابر یک لیست مجاز از پروتکل‌ها، دامنه‌ها، مسیرها و پورت‌ها اعتبارسنجی کرده و کاراکترهای بالقوه خطرناک را پیش از استفاده از داده برای فراخوانی سرویس دیگر پاک‌سازی (sanitize) می‌کند.                                                                           | 2     |
| **1.3.7**  | برنامه در برابر حملات تزریق قالب (Template Injection) محافظت شده باشد؛ به این صورت که ساخت قالب‌ها بر پایه داده‌های غیرقابل اعتماد مجاز نباشد. در صورتی که هیچ راه‌حل جایگزینی وجود نداشته باشد، هرگونه ورودی غیرقابل اعتماد که به‌صورت پویا در فرآیند ایجاد قالب وارد می‌شود، باید پیش از استفاده یا پاک‌سازی (sanitize) شود یا به‌صورت سخت‌گیرانه اعتبارسنجی (validate) گردد. | 2     |
| **1.3.8**  | برنامه، ورودی غیرقابل اعتماد را پیش از استفاده در کوئری‌های Java Naming and Directory Interface (JNDI) به‌درستی پاک‌سازی (sanitize) می‌کند و همچنین اطمینان حاصل شود که پیکربندی JNDI به‌گونه‌ای امن انجام شده تا از بروز حملات تزریق JNDI جلوگیری شود.                                                                                                                         | 2     |
| **1.3.9**  | برنامه، محتوا را پیش از ارسال به memcache پاک‌سازی (sanitize) می‌کند تا از حملات تزریق (injection attacks) جلوگیری شود.                                                                                                                                                                                                                                                         | 2     |
| **1.3.10** | رشته‌های قالب‌بندی (format strings) که ممکن است هنگام استفاده، به‌شکلی ناخواسته یا مخرب تفسیر شوند، پیش از پردازش پاک‌سازی (sanitize) شوند.                                                                                                                                                                                                                                     | 2     |
| **1.3.11** | برنامه ورودی‌های کاربر را پیش از ارسال به سامانه‌های ایمیل (مانند SMTP یا IMAP) پاک‌سازی (sanitize) ‌کند تا از حملات تزریق در SMTP یا IMAP جلوگیری شود.                                                                                                                                                                                                                         | 2     |
| **1.3.12** | عبارات منظم (Regular Expressions) عاری از اجزایی هستند که باعث بازگشت‌پذیری نمایی (exponential backtracking) می‌شوند، و همچنین ورودی‌های غیرقابل اعتماد به‌درستی پاک‌سازی (sanitize) شوند تا از حملات ReDoS (انکار سرویس با استفاده از عبارات منظم) یا Runaway Regex جلوگیری گردد.                                                                                              | 3     |

## V1.4 حافظه، رشته و کد بدون مدیریت (Memory, String, and Unmanaged Code)

الزامات زیر به ریسک‌های ناشی از استفاده ناایمن از حافظه می‌پردازند، که معمولاً در شرایطی مطرح هستند که برنامه از زبان‌های سیستمی یا کدهای مدیریت‌نشده (unmanaged code) استفاده می‌کند. 

در برخی موارد، می‌توان با تنظیم پرچم‌های کامپایلر (compiler flags) به این هدف دست یافت؛ مانند فعال‌سازی محافظت‌ها و هشدارهای مربوط به سرریز بافر (buffer overflow)، تصادفی‌سازی پشته (stack randomization)، جلوگیری از اجرای داده‌ها (DEP)، و همچنین توقف فرایند ساخت (build) در صورت شناسایی عملیات ناایمن روی اشاره‌گرها، حافظه، رشته‌های قالب‌بندی، اعداد صحیح یا رشته‌های متنی.

| #         | Description                                                                                                                                                                                                                                                                                  | Level |
|:---------:|:-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |:-----:|
| **1.4.1** | برنامه از رشته‌های ایمن از نظر مدیریت حافظه، کپی حافظه‌ای ایمن‌تر و حساب‌گری ایمن‌تر روی اشاره‌گرها استفاده می‌کند تا از سرریز پشته (stack overflow)، سرریز بافر (buffer overflow) یا سرریز حافظه پویای (heap overflow) جلوگیری کرده یا آن‌ها را شناسایی کند.                                | 2     |
| **1.4.2** | از تکنیک‌های اعتبارسنجی علامت (sign validation)، محدوده (range validation) و ورودی (input validation) استفاده شده است تا از بروز سرریز عدد صحیح (integer overflow) جلوگیری شود.                                                                                                              | 2     |
| **1.4.3** | حافظه و منابعی که به‌صورت پویا تخصیص داده شده‌اند، به‌درستی آزاد (release) می‌شوند و همچنین ارجاع‌ها یا اشاره‌گرها (pointers) به حافظه آزادشده حذف یا به null تنظیم می‌شوند تا از اشاره‌گرهای معلق (dangling pointers) و آسیب‌پذیری‌های استفاده پس از آزادسازی (use-after-free) جلوگیری شود. | 2     |

## V1.5 سریال‌زدایی ایمن (Safe Deserialization)

تبدیل داده‌ها از یک قالب ذخیره‌شده یا انتقال‌یافته به یک object واقعی برنامه)فرایند (deserialization در گذشته منبع بسیاری از آسیب‌پذیری‌های تزریق کد بوده است. بنابراین، انجام این فرایند باید با دقت و به‌صورت ایمن صورت گیرد تا از بروز چنین مشکلاتی جلوگیری شود.

به‌ویژه، برخی از روش‌های deserialization طبق مستندات زبان‌های برنامه‌نویسی یا چارچوب‌ها به‌عنوان ناایمن شناخته شده‌اند و نمی‌توانند هنگام کار با داده‌های غیرقابل‌اعتماد به‌صورت ایمن استفاده شوند. برای هر مکانیزم مورداستفاده، باید بررسی دقیق و مسئولانه (due diligence) انجام شود.

| #         | Description                                                                                                                                                                                                                                                                                                                                                                                 | Level |
|:---------:|:------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |:-----:|
| **1.5.1** | برنامه، XML Parserها را به‌گونه‌ای پیکربندی کرده باشد که از تنظیمات محدودکننده استفاده کنند، و ویژگی‌های ناایمنی مانند resolve کردن موجودیت‌های خارجی (external entities) غیرفعال شده باشند تا از حملات XML External Entity (XXE) جلوگیری شود.                                                                                                                                              | 1     |
| **1.5.2** | فرآیند deserialization داده‌های غیرقابل‌اعتماد، با اجرای مدیریت ایمن ورودی‌ها همراه باشد؛ برای مثال، استفاده از لیست مجاز (allowlist) انواع objectها یا محدود کردن انواع تعریف‌شده توسط کلاینت برای جلوگیری از حملات مرتبط با deserialization. همچنین، مکانیزم‌های deserialization که به‌طور صریح به‌عنوان ناایمن شناخته شده‌اند، نباید با داده‌های غیرقابل‌اعتماد مورد استفاده قرار گیرند. | 2     |
| **1.5.3** | Parser های مختلفی که در برنامه برای یک نوع داده مشخص استفاده می‌شوند (برای مثال: Parser های JSON، XML یا URL)، رفتار تحلیلی یکسانی دارند و از مکانیزم یکسانی برای encoding کاراکترها استفاده می‌کنند، تا از بروز مشکلاتی مانند آسیب‌پذیری در سازگاری JSON (JSON Interoperability) یا تفاوت در نحوه تحلیل URI یا مسیر فایل که ممکن است در حملات RFI یا SSRF سوءاستفاده شود، جلوگیری شود.     | 3     |

## References

برای اطلاعات بیشتر، همچنین به منابع زیر مراجعه کنید:

* [OWASP LDAP Injection Prevention Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/LDAP_Injection_Prevention_Cheat_Sheet.html)
* [OWASP Cross Site Scripting Prevention Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/Cross_Site_Scripting_Prevention_Cheat_Sheet.html)
* [OWASP DOM Based Cross Site Scripting Prevention Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/DOM_based_XSS_Prevention_Cheat_Sheet.html)
* [OWASP XML External Entity Prevention Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/XML_External_Entity_Prevention_Cheat_Sheet.html)
* [OWASP Web Security Testing Guide: Client-Side Testing](https://owasp.org/www-project-web-security-testing-guide/stable/4-Web_Application_Security_Testing/11-Client-side_Testing)
* [OWASP Java Encoding Project](https://owasp.org/owasp-java-encoder/)
* [DOMPurify - Client-side HTML Sanitization Library](https://github.com/cure53/DOMPurify)
* [RFC4180 - Common Format and MIME Type for Comma-Separated Values (CSV) Files](https://datatracker.ietf.org/doc/html/rfc4180#section-2)

برای اطلاعات بیشتر، به‌ویژه در مورد مشکلات deserialization یا parsing، لطفاً مراجعه کنید به:

* [OWASP Deserialization Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/Deserialization_Cheat_Sheet.html)
* [An Exploration of JSON Interoperability Vulnerabilities](https://bishopfox.com/blog/json-interoperability-vulnerabilities)
* [Orange Tsai - A New Era of SSRF Exploiting URL Parser In Trending Programming Languages](https://www.blackhat.com/docs/us-17/thursday/us-17-Tsai-A-New-Era-Of-SSRF-Exploiting-URL-Parser-In-Trending-Programming-Languages.pdf)

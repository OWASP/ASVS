# V7 Session Management

## هدف

مکانیزم‌های مدیریت نشست (Session Management Mechanisms) به برنامه‌ها این امکان را می‌دهند که تعاملات کاربر و دستگاه را در طول زمان، حتی هنگام استفاده از پروتکل‌های stateless  (مانند HTTP)، با یکدیگر مرتبط کنند. برنامه‌های مدرن ممکن است از چندین توکن نشست (Session Token) با ویژگی‌ها و اهداف متفاوت استفاده کنند. یک سیستم مدیریت نشست ایمن، سیستمی است که از به‌دست آوردن، استفاده یا سوءاستفاده مهاجم از نشست قربانی جلوگیری می‌کند. برنامه‌هایی که نشست‌ها را نگهداری می‌کنند باید اطمینان حاصل کنند که الزامات سطح‌بالای زیر در مدیریت نشست رعایت شده‌اند:

* نشست‌ها برای هر کاربر(شخص) منحصر به فرد هستند و نمی‌توان آن‌ها را حدس زد یا به اشتراک گذاشت.
* نشست‌ها زمانی که دیگر مورد نیاز نیستند، باطل می‌شوند و در دوره‌های عدم فعالیت، منقضی می‌گردند.

بسیاری از الزامات مطرح‌شده در این فصل به کنترل‌های انتخاب‌شده از [دستورالعمل‌های هویت دیجیتال NIST SP 800-63](https://pages.nist.gov/800-63-4/) مربوط می‌شوند و بر تهدیدات رایج و ضعف‌های متداول در احراز هویت که معمولاً مورد سوءاستفاده قرار می‌گیرند، تمرکز دارند.

توجه داشته باشید که الزامات مربوط به جزئیات پیاده‌سازی خاصِ برخی از مکانیزم‌های مدیریت نشست را می‌توان در منابع دیگری یافت:

* HTTP Cookie‌ها یک مکانیزم مشترک برای امن سازی توکن‌های نشست هستند. الزامات امنیتی خاصی برای کوکی‌ها در بخش "Web Frontend Security" قرار داده شده است.
* توکن های Self-contained  به عنوان روشی برای نگهداری نشست‌ها بطور مکرر مورد استفاده قرار می‌گیرند. الزامات امنیتی خاصی در بخش "Self-contained Tokens" قرار داده شده است.

## V7.1 Session Management Documentation

 هیچ الگوی واحدی که برای تمامی برنامه‌های کاربردی مناسب باشد، وجود ندارد. بنابراین، تعریف مرزها و محدودیت‌های عمومی که برای تمامی موارد مناسب باشد غیر ممکن است. یک تحلیل ریسک با تصمیمات امنیتی مستند شده مرتبط با مدیریت نشست باید به عنوان یک پیش نیاز برای پیاده سازی و ارزیابی انجام شود. این امر تضمین می‌کند که سیستم مدیریت نشست با الزامات خاص آن برنامه کاربردی طراحی  شده است.

فارغ از اینکه از مکانیزم نشست stateful یا stateless استفاده شود، تحلیل باید به‌صورت کامل و مستند انجام شود تا نشان دهد راه‌حل انتخاب‌شده توانایی برآورده‌کردن تمامی الزامات امنیتی مرتبط را دارد. همچنین باید تعامل با هرگونه مکانیزم ورود یکپارچه (Single Sign-On یا SSO) که در حال استفاده است، مورد توجه قرار گیرد.

| #         | شرح الزام                                                                                                                                                                                                                                                          | سطح |
|:---------:|:-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |:-----:|
| **7.1.1** | بازه عدم فعالیت نشست کاربر و بیشینه طول عمر نشست قبل از احراز هویت مجدد، در ترکیب با سایر کنترل‌ها مستند و متناسب سازی شود. مستند سازی انجام شده باید شامل توجیه برای هر انحراف(نقض) از الزامات احراز هویت مجدد NIST SP 800-63B باشد.                                | 2     |
| **7.1.2** | در مستند باید تعداد نشست همزمان مجاز برای یک کاربر و همچنین رفتار و اعمال مناسب برای زمانی که این تعداد به حداکثر رسید مشخص شود.                                                                                                                                     | 2     |
| **7.1.3** | تمام سیستم‌هایی که نشست‌های کاربر را به عنوان بخشی از یک اکوسیستم مدیریت هویت فدرال(مانند سیستم‌های (SSO ایجاد و مدیریت می‌کنند، باید در کنار سایر کنترل‌های مربوط به طول عمر نشست‌ها، خاتمه آن‌ها و هرگونه شرایط دیگری که نیاز به احراز هویت مجدد دارد، مستند شوند. | 2     |

## V7.2 Fundamental Session Management Security

این بخش الزامات موردنیاز نشست‌های امن را از طریق بررسی امنیت تولید و اعتبارسنجی توکن‌ها احصا می‌نماید.

| #         | شرح الزام                                                                                                                                                                                                             | سطح |
|:---------:|:----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |:-----:|
| **7.2.1** | برنامه کاربردی باید تمام بررسی‌های توکن نشست‌ را با استفاده از یک سرویس backend مطمئن انجام دهد.                                                                                                                        | 1     |
| **7.2.2** | برنامه کاربردی که از هر یک از توکن‌های Self-Contained یا reference که به صورت پویا برای مدیریت نشست تولید شده‌اند استفاده کند اما از از کلیدهای API ثابت و کلید‌ها استفاده نکند.                                        | 1     |
| **7.2.3** | در صورتی که برای نمایش نشست کاربر از توکن‌های reference استفاده می شود، این توکن‌ها منحصر به فرد بوده و با استفاده از یک تولید کننده عدد شبه تصادفی امن رمزنگاری(CSPRNG) که دارای انتروپی حداقل128 بیتی است تولید شوند. | 1     |
| **7.2.4** | برنامه کاربردی در هنگام احراز هویت کاربر یک توکن نشست جدید تولید نماید که شامل احراز هویت مجدد و ابطال توکن نشست کنونی است.                                                                                             | 1     |

## V7.3 Session Timeout

مکانیزم های انقضای نشست به منظور به حداقل رساندن فرصت برای session hijacking و سایر روش‌های سواستفاده از نشست‌ها بکار می‌روند.

| #         | شرح الزام                                                                                                              | سطح |
|:---------:|:------------------------------------------------------------------------------------------------------------------------ |:-----:|
| **7.3.1** | بر اساس تحلیل ریسک و تصمیمات امنیتی مستند شده، پس از گذشت مهلت زمانی عدم فعالیت، کاربر مجبور به احراز هویت مجدد گردد.    | 2     |
| **7.3.2** | بر اساس تحلیل ریسک و تصمیمات امنیتی مستند شده، پس از گذشت بیشینه زمان مطلق طول عمر، کاربر مجبور به احراز هویت مجدد گردد. | 2     |

## V7.4 Session Termination

ابطال نشست ممکن است توسط خود برنامه کاربردی و یا در صورتی که مکانیزم SSO برای مدیریت نشست مورد استفاده قرار گرفته است، توسط SSO به جای برنامه صورت پذیرد. ممکن است لازم باشد هنگام بررسی الزامات این بخش، تصمیم گرفته شود که آیا ارائه‌دهنده‌ی SSO  در محدوده‌ی این الزامات قرار گیرد یا خیر، زیرا برخی از این SSOها ممکن است توسط ارائه‌دهنده کنترل شوند.

ابطال نشست باید منجر به الزام کاربر به احراز هویت مجدد گردد و در سراسر برنامه، ورود یکپارچه (Federated Login) و سایر بخش ها اثربخش باشد.

برای مکانیزم های نشست stateful، ابطال عموما شامل نامعتبرسازی نشست در  backendاست. در مواردی که توکن‌ها self-contained هستند، معیار‌های بیشتری به منظور ابطال یا بلاک کردن این توکن‌ها مورد نیاز هستند‌؛ در غیر این صورت این توکن‌ها تا زمان منقضی شدن بصورت معتبر باقی می‌مانند.

| #         | شرح الزام                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        | سطح |
|:---------:|:-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |:-----:|
| **7.4.1** | در مواقعی که فرآیند خاتمه نشست کاربر فعال می‌شود (مانند خروج کاربر یا انقضای نشست)، برنامه اجازه هیچ فعالیتی را به آن نشست نمی‌دهد. برای Reference tokens یا stateful session، این به معنی نامعتبرسازی اطلاعات نشست در برنامه Backend می‌باشد. برنامه‌هایی که از توکن‌های Self-contained استفاده می‌کنند نیاز به راه حل‌هایی نظیر نگهداری فهرستی از توکن‌های خاتمه‌یافته، عدم پذیرش توکن‌هایی که پیش از یک تاریخ و زمان مشخص برای هر کاربر تولید شده‌اند، یا چرخش کلید امضای مخصوص هر کاربر دارند. | 1     |
| **7.4.2** | برنامه کاربردی تمامی نشست‌های فعال را در زمانی که حساب کاربری غیرفعال یا حذف می‌شود را ابطال نماید. (مانند کارمندی که شرکت را ترک می‌کند)                                                                                                                                                                                                                                                                                                                                                          | 1     |
| **7.4.3** | برنامه کاربردی قابلیت ارائه گزینه ابطال تمامی نشست های فعال دیگر را پس از یک تغییر موفقیت آمیز یا حذف هریک از عوامل احراز هویت (نظیر تغییر پسورد از طریق ریست یا بازنشانی و در صورت وجود به روزرسانی تنظیمات MFA ) را داشته باشد.                                                                                                                                                                                                                                                                  | 2     |
| **7.4.4** | تمامی صفحاتی که نیازمند احراز هویت هستند دارای دسترسی آسان و مشخص به فرآیند خروج باشند.                                                                                                                                                                                                                                                                                                                                                                                                            | 2     |
| **7.4.5** | مدیران برنامه کاربردی قادر به ابطال نشست‌های فعال برای یک شخص یا تمامی کاربران باشند.                                                                                                                                                                                                                                                                                                                                                                                                              | 2     |

## V7.5 Defenses Against Session Abuse

این بخش الزاماتی را برای کاهش ریسک‌های ناشی از نشست‌های فعال که می‌توانند از طریق وکتورهایی که متکی بر وجود نشست‌های کاربر فعال و قابلیت‌‌های آن‌ها هستند مورد سرقت و یا سوء استفاده قرار گیرند را ارایه می‌دهد. بطور مثال، با استفاده از اجرای محتوا‌های آلوده مرورگر احراز هویت شده قربانی را مجبور کنیم که یک عملی را با استفاده از نشست کاربر قربانی انجام دهد.

توجه داشته باشید که راهنمای سطح‌محور موجود در فصل «احراز هویت» باید هنگام در نظر گرفتن الزامات این بخش مدنظر قرار گیرد.

| #         | شرح الزام                                                                                                                                                                                                                                           | سطح |
|:---------:|:----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |:-----:|
| **7.5.1** | برنامه کاربردی قبل از اعطای مجوز تغییر ویژگی‌های حساس حساب کاربری که بر روی احراز هویت تاثیر دارد نظیر آدرس ایمیل، شماره تلفن، تنظیمات MFA یا اطلاعات دیگر که در بازگردانی حساب کاربری مورد استفاده قرار می‌گیرند، به احراز هویت مجدد کامل نیاز دارد. | 2     |
| **7.5.2** | حساب‌های کاربری قادر به دیدن(پس از احراز هویت مجدد با حداقل یک عامل) و ابطال یک یا همه نشست‌های فعال باشد.                                                                                                                                            | 2     |
| **7.5.3** | برنامه کاربردی قبل از اجرای تراکنش‌ها یا عملیات‌های حساس نیازمند احراز هویت مجدد با حداقل یک عامل یا صحت سنجی ثانویه باشد.                                                                                                                            | 3     |

## V7.6 Federated Re-authentication

این بخش مربوط به کسانی است که کد طرف اتکا (RP) یا ارائه دهنده هویت (IdP) را می‌نویسند. این الزامات از [NIST SP 800-63C](https://pages.nist.gov/800-63-4/sp800-63c.html)  برای هویت اشتراکی و ادعاها گرفته شده است.

| #         | شرح الزام                                                                                                                                                               | سطح |
|:---------:|:------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |:-----:|
| **7.6.1** | طول عمر و ابطال نشست بین RP و idp طبق سند- که نیازمند احرازهویت مجدد در زمان مورد نیاز مانند وقتی که بیشینه زمان بین رخداد احراز هویت idp رسیده باشد- انجام شود.          | 2     |
| **7.6.2** | ساخت نشست‌ها نیاز به رضایت کاربر یا یک اقدام صریح دارد که بدین صورت از ایجاد نشست‌های جدید برنامه بدون تعامل کاربر جلوگیری می‌شود. | 2     |

## References

برای اطلاعات بیشتر، همچنین به منابع زیر مراجعه کنید:

* [OWASP Web Security Testing Guide: Session Management Testing](https://owasp.org/www-project-web-security-testing-guide/stable/4-Web_Application_Security_Testing/06-Session_Management_Testing)
* [OWASP Session Management Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/Session_Management_Cheat_Sheet.html)

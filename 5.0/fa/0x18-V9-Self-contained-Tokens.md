# V9 Self-contained Tokens

## هدف

مفهوم توکن self-contained در RFC 6749 Oauth2 اصلی مربوط به سال 2012 ذکر شده است. این مفهوم به توکنی اشاره دارد که شامل داده یا Claim است که یک سرویس گیرنده برای تصمیم‌گیری‌های امنیتی به آنها متکی خواهد بود. از این رو باید آن‌ها را از  توکن‌های ساده‌ای که فقط حاوی یک شناسه هستند که سرویس گیرنده از آن‌ها برای جستجوی داده بصورت محلی استفاده می‌کند متمایز دانست. رایج ترین مثال‌ها از توکن‌های self-contained ها، JSON Web Tokens (JWTs) وSAML assertion هستند.

کاربرد توکن‌های self-contained حتی خارج از حوزه OAuth و OIDC بسیار فراگیر شده است. در همین زمان امنیت این مکانیزم بر قابلیت اعتبارسنجی یکپارچگی توکن و تضمین این مساله که این توکن برای یک زمینه خاص معتبر است استوار است. موانع زیادی(چالش‌ها) در این فرآیند وجود دارد و این بخش جزئیات ویژه‌ای از این مکانیزم‌ها را ارائه می‌دهد که برنامه‌ها باید به منظور جلوگیری از این چالش‌ها، ارائه دهند.

## V9.1 Token source and integrity

این بخش شامل الزاماتی است که تضمین می‌کند که توکن توسط بخش مطمئن(مورد اعتماد) تولید شده است و مورد دستکاری قرار نگرفته است.

| #         | Description                                                                                                                                                                                                                                                                                                                                                                                                | Level |
|:---------:|:---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |:-----:|
| **9.1.1** | قبل از پذیرش محتوای توکن‌ها، آن‌ها را با استفاده از امضای دیجیتال یا MAC به منظور حفاظت در مقابل دستکاری‌ها مورد اعتبارسنجی قرار داده شود.                                                                                                                                                                                                                                                                 | 1     |
| **9.1.2** | فقط الگوریتم‌های موجود در لیست مجاز قادر به استفاده در ساخت و صحت سنجی توکن‌های self-contained در یک زمینه مشخص باشند. این لیست مجاز باید در حالت ایده آل شامل هم الگوریتم‌های متقارن و هم نامتقارن‌ها باشد و نباید شامل الگوریتم‌های NONE باشد. در صورتی که هر دو الگوریتم‌های متقارن و نانتقارن مورد نیاز باشند کنترل‌های بیشتری باید به منظور جلوگیری از سردرگمی کلید‌ها(key Confusion) بکار گرفته شود. | 1     |
| **9.1.3** | به منظور جلوگیری از مشخص نمودن منابع غیر مطمئن و کلید‌ها توسط مهاجمین، موارد کلیدی که در اعتبارسنجی توکن‌های self-contained مورد استفاده قرار می‌گیرند، از منابع از پیش پیکربندی شده مطمئنی که برای صادر کننده توکن است تعیین شود. برای JWTs و سایر ساختارهای  JWS ، هدرهایی نظیر ‘jku’, ‘x5u’ و ‘jwk’ باید با یک لیست مجاز از منابع مطمئن مورد اعتبارسنجی قرار گیرند.                                     | 1     |

## V9.2 Token content

قبل از اتخاذ تصمیمات امنیتی براساس محتوای توکن self-contained، ضروری است ابتدا بررسی شود که آیا توکن در دوره معتبر خود و برای هدفی که توسط سرویس گیرنده در جهت کاربرد آن در نظر گرفته و ارائه شده است. این موضوع به منظور جلوگیری از استفاده متقابل نا امن بین سرویس‌های مختلف یا با انواع توکن‌های مختلف از صادرکننده مشابه است.

الزامات خاص برای OAuth و OIDC در این بخش مورد پوشش قرار گرفته شده‌اند.

| #         | Description                                                                                                                                                                                                                                                                                                                                                                                                                                                    | Level |
|:---------:|:-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |:-----:|
| **9.2.1** | اگر یک بازه زمانی معتبر در داده‌های توکن وجود داشته باشد، توکن و محتوای آن تنها در صورتی پذیرفته می‌شوند که زمان بررسی در این بازه زمانی معتبر باشد. به عنوان مثال، برای JWTها، ادعاهای 'nbf' و 'exp' باید تایید شوند.                                                                                                                                                                                                                                         | 1     |
| **9.2.2** | سرویسی که یک توکن دریافت می‌کند قبل از پذیرش محتوای آن، از لحاظ درستی نوع بررسی نموده و برای هدف مشخص شده در نظر گیرد. بطور مثال، فقط توکن‌های access می‌توانند به منظور تصمیمات مجوزی و فقط توکن های ID می‌توانند به منظور اثبات هویت کاربر مورد پذیرش قرار گیرند.                                                                                                                                                                                            | 2     |
| **9.2.3** | یک سرویس فقط توکن‌هایی را بپذیرد که به منظور استفاده توسط آن سرویس هستند(audience).برای JWT ها،این امر می‌تواند از طریق اعتبارسنجی ادعای 'aud' با یک لیست مجاز تعریف شده در سرویس صورت پذیرد.                                                                                                                                                                                                                                                                  | 2     |
| **9.2.4** | Verify that, if a token issuer uses the same private key for issuing tokens to different audiences, the issued tokens contain an audience restriction that uniquely identifies the intended audiences. This will prevent a token from being reused with an unintended audience. If the audience identifier is dynamically provisioned, the token issuer must validate these audiences in order to make sure that they do not result in audience impersonation. | 2     |

## References

برای اطلاعات بیشتر، همچنین به منابع زیر مراجعه کنید:

* [OWASP JSON Web Token Cheat Sheet for Java Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/JSON_Web_Token_for_Java_Cheat_Sheet.html) (but has useful general guidance)

# V11 Cryptography

## هدف

هدف این فصل تعریف بهترین رویه‌ها برای استفاده عمومی از رمزنگاری است. همچنین به دنبال آن است که درک بنیادی از اصول رمزنگاری ایجاد کرده و تغییری به سمت رویکردهای مقاوم‌تر و مدرن‌تر را ترغیب کند. این فصل این موارد را تشویق(پیشنهاد) می‌کند:

* پیاده‌سازی سیستم‌های رمزنگاری مقاوم که به‌طور ایمن دچار خطا شوند، با تهدیدات در حال تکامل سازگار شوند و آینده‌نگر باشند. 
* به‌کارگیری سازوکارهای رمزنگاری که هم ایمن باشند و هم با بهترین رویه‌های صنعت همسو باشند.
* حفظ یک سیستم مدیریت کلیدهای رمزنگاری امن، همراه با کنترل‌های دسترسی مناسب و قابلیت ممیزی.
* ارزیابی منظم چشم‌انداز رمزنگاری به‌منظور شناسایی خطرات جدید و تطبیق الگوریتم‌ها بر اساس آن‌ها.
* •    کشف و مدیریت موارد استفاده‌ی رمزنگاری در طول چرخه‌ی عمر برنامه، به‌منظور اطمینان از ثبت و حفاظت تمامی دارایی‌های رمزنگاری.

علاوه بر تشریح اصول عمومی و بهترین شیوه‌ها، این سند اطلاعات فنی عمیق‌تری درباره الزامات در پیوست C  استانداردهای رمزنگاری ارائه می‌دهد. شامل الگوریتم‌ها و حالت‌هایی که برای اهداف الزامات این فصل «تأییدشده» محسوب می‌شوند.

الزامات استفاده‌کننده از رمزنگاری برای حل مسائل دیگر، مانند مدیریت secrets یا امنیت ارتباطات ، در بخش‌های دیگر استاندارد بررسی خواهند شد.

## V11.1 Cryptographic Inventory and Documentation

برنامه‌ها باید با معماری رمزنگاری قدرتمند طراحی شوند تا از دارایی‌های داده مطابق با طبقه‌بندی آن‌ها محافظت شود. رمزگذاری همه‌چیز کاری پرهزینه و بیهوده است؛ در حالی‌که رمزگذاری نکردن هیچ‌چیز، از نظر قانونی سهل‌انگاری محسوب می‌شود. باید تعادلی برقرار شود، معمولاً در مرحله معماری یا طراحی سطح بالا، اسپرینت‌های طراحی یا آزمایش‌های معماری (architectural spikes). طراحی رمزنگاری به صورت لحظه‌ای یا اضافه کردن آن به سیستم پس از طراحی، به مراتب پرهزینه‌تر و دشوارتر از لحاظ امنیتی خواهد بود نسبت به حالتی که از ابتدا در طراحی لحاظ شده باشد.

مهم است که اطمینان حاصل شود تمامی دارایی‌های رمزنگاری به‌طور منظم شناسایی، فهرست‌بندی و ارزیابی شوند. لطفاً برای کسب اطلاعات بیشتر درباره نحوه انجام این کار به پیوست مراجعه کنید.

نیاز به آینده‌نگری در برابر ظهور اجتناب‌ناپذیر رایانش کوانتومی برای مقاوم‌سازی سیستم‌های رمزنگاری نیز حیاتی است. رمزنگاری پساکوانتومی (Post-Quantum Cryptography یا PQC) به الگوریتم‌های رمزنگاری‌ای اشاره دارد که برای مقاومت در برابر حملات رایانه‌های کوانتومی طراحی شده‌اند؛ رایانه‌هایی که انتظار می‌رود الگوریتم‌های پرکاربردی همچون RSA و رمزنگاری منحنی بیضوی (ECC) را بشکنند.

لطفاً برای دریافت راهنمایی‌های کنونی درباره ابتداییات و استانداردهای تأییدشده در زمینه رمزنگاری پساکوانتومی (PQC)، به ضمیمه مراجعه کنید.

| #          | شرح الزام                                                                                                                                                                                                                                                                                                                                                       | سطح |
|:----------:|:----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |:-----:|
| **11.1.1** | اطمینان حاصل کنید که یک سیاست مستند برای مدیریت کلیدهای رمزنگاری و چرخه‌عمر کلیدهای رمزنگاری وجود دارد که از یک استاندارد مدیریت کلید مانند NIST SP 800-57 پیروی می‌کند. این باید شامل اطمینان از این موضوع باشد که کلیدها بیش از حد به اشتراک گذاشته نشوند (برای مثال، در مورد Secrets مشترک با بیش از دو موجودیت و در مورد کلیدهای خصوصی با بیش از یک موجودیت). | 2     |
| **11.1.2** | فهرست اجزاء رمزنگاری باید تهیه و نگهداری ‌شود و به‌صورت منظم به‌روزرسانی گردد و شامل تمام کلیدهای رمزنگاری، الگوریتم‌ها و گواهی‌های دیجیتال مورد استفاده در برنامه باشد. این فهرست همچنین باید مشخص کند که کلیدها در کدام بخش‌های سیستم مجاز یا غیرمجاز به استفاده هستند و چه نوع داده‌هایی می‌توانند یا نمی‌توانند با این کلیدها محافظت شوند.                    | 2     |
| **11.1.3** | مکانیزم‌های کشف رمزنگاری برای شناسایی تمام موارد استفاده از رمزنگاری در سیستم باید استفاده ‌شود؛ از جمله رمزنگاری (encryption)، هش‌کردن (hashing) و عملیات امضای دیجیتال (signing).                                                                                                                                                                               | 3     |
| **11.1.4** | فهرست اجزاء رمزنگاری باید تهیه ‌شود. این فهرست باید شامل یک برنامه مستند باشد که مسیر مهاجرت به استانداردهای جدید رمزنگاری (مانند رمزنگاری پساکوانتومی) را مشخص می‌کند تا امکان واکنش مناسب به تهدیدات آینده فراهم شود.                                                                                                                                           | 3     |

## V11.2 Secure Cryptography Implementation

این بخش الزامات مربوط به انتخاب، پیاده‌سازی و مدیریت مستمر الگوریتم‌های اصلی رمزنگاری برای یک برنامه را تعریف می‌کند. هدف این است که تنها ابتداییات رمزنگاری (primitives) قدرتمند و مورد پذیرش صنعت، مطابق با استانداردهای فعلی (مانند NIST و ISO/IEC) و بهترین رویه‌ها به کار گرفته شوند. سازمان‌ها باید اطمینان حاصل کنند که هر جزء رمزنگاری بر اساس شواهد داوری‌شده توسط متخصصان (peer-reviewed) و آزمایش‌های عملی امنیتی انتخاب شده است.

| #          | شرح الزام                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         | سطح |
|:----------:|:--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |:-----:|
| **11.2.1** | برای عملیات رمزنگاری باید از پیاده‌سازی‌های مورد تأیید (شامل کتابخانه‌ها و پیاده‌سازی‌های سخت‌افزاری) استفاده شود.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | 2     |
| **11.2.2** | برنامه با انعطاف‌پذیری رمزنگاری (crypto agility) باید طراحی شده باشد، به‌طوری که الگوریتم‌های تولید اعداد تصادفی، رمزنگاری احراز هویت‌شده، MAC یا هش، طول کلیدها، تعداد دورها، رمزها و حالت‌ها بتوانند در هر زمان مجدداً پیکربندی، ارتقاء یا تعویض شوند تا در برابر شکست‌های رمزنگاری محافظت شوند. به همین ترتیب، باید امکان جایگزینی کلیدها و رمزهای عبور و رمزگذاری مجدد داده‌ها نیز وجود داشته باشد. این امکان ارتقاء بدون وقفه به رمزنگاری پساکوانتومی (PQC) را فراهم می‌کند، زمانی که پیاده‌سازی‌های با اطمینان بالا از طرح‌ها یا استانداردهای تأییدشده PQC به‌طور گسترده در دسترس قرار گیرند. | 2     |
| **11.2.3** | تمام بدویات رمزنگاری (cryptographic primitives) بر اساس الگوریتم، اندازه کلید و پیکربندی، حداقل ۱۲۸ بیت سطح امنیتی را فراهم می‌کنند(2128)، برای مثال، یک کلید ECC  با طول ۲۵۶ بیت تقریباً ۱۲۸ بیت امنیت ارائه می‌دهد، در حالی که برای رسیدن به همین سطح امنیت، الگوریتم RSA  به کلید ۳۰۷۲ بیتی نیاز دارد.                                                                                                                                                                                                                                                                                           | 2     |
| **11.2.4** | تأیید کنید که تمامی عملیات رمزنگاری زمان ثابت (constant-time) باشند و هیچ عملیات «کوتاه‌شده» (short-circuit) در مقایسه‌ها، محاسبات یا بازگشت‌ها وجود نداشته باشد تا از نشت اطلاعات جلوگیری شود.( مهاجم می‌تواند از همین تفاوت‌های زمانی، از طریق Timing Side-Channel Attack، اطلاعات حساس را استخراج کند.)                                                                                                                                                                                                                                                                                          | 3     |
| **11.2.5** | تأیید کنید که تمامی ماژول‌های رمزنگاری به‌صورت امن دچار خطا (fail securely) شوند و خطاها به گونه‌ای مدیریت شوند که ایجاد آسیب‌پذیری‌هایی مانند حملات Padding Oracle را ممکن نکنند.                                                                                                                                                                                                                                                                                                                                                                                                                  | 3     |

## V11.3 Encryption Algorithms

الگوریتم‌های رمزنگاری احراز هویت‌شده (Authenticated Encryption) مبتنی بر AES و CHACHA20، زیربنای عملکردهای رمزنگاری مدرن را تشکیل می‌دهند.

| #          | شرح الزام                                                                                                                                                                                     | سطح |
|:----------:|:----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |:-----:|
| **11.3.1** | از مد‌های بلاک ناامن (مانند ECB) و روش‌های Padding ضعیف (مانند PKCS#1 v1.5) نباید استفاده شود.                                                                                                  | 1     |
| **11.3.2** | تنها رمزها و مد‌های تأییدشده، مانند AES با GCM باید استفاده شوند.                                                                                                                               | 1     |
| **11.3.3** | داده‌های رمزنگاری‌شده باید با استفاده از ترجیحاً یک روش رمزنگاری احراز هویت‌شده تأییدشده یا با ترکیب یک روش رمزنگاری تأییدشده با یک الگوریتم MAC تأییدشده در برابر تغییرات غیرمجاز محافظت شوند. | 2     |
| **11.3.4** | تأیید کنید که Nonceها، Initialization Vectorها و سایر اعداد یک‌بار مصرف برای بیش از یک جفت کلید رمزنگاری و عنصر داده استفاده نشوند. روش تولید آن‌ها باید متناسب با الگوریتم مورد استفاده باشد.  | 3     |
| **11.3.5** | تأیید کنید که هر ترکیبی از یک الگوریتم رمزنگاری و یک الگوریتم MAC در حالت Encrypt-then-MAC عمل کند.                                                                                             | 3     |

## V11.4 Hashing and Hash-based Functions

توابع هش در انواع گسترده‌ای از پروتکل‌های رمزنگاری استفاده می‌شوند، مانند امضای دیجیتال، HMAC، توابع مشتق‌سازی کلید (KDF)، تولید بیت تصادفی و ذخیره‌سازی پسورد. امنیت سیستم رمزنگاری تنها به اندازه‌ی امنیت توابع هش پایه‌ای است که استفاده می‌شوند. این بخش الزامات استفاده از توابع هش امن در عملیات رمزنگاری را بیان می‌کند.

برای ذخیره‌سازی رمزعبور، علاوه بر پیوست رمزنگاری، [OWASP Password Storage Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/Password_Storage_Cheat_Sheet.html#password-hashing-algorithms) نیز زمینه و راهنمایی مفیدی ارائه می‌دهد.

| #          | شرح الزام                                                                                                                                                                                                                                                                                                                            | سطح |
|:----------:|:-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |:-----:|
| **11.4.1** | تأیید کنید که تنها توابع هش تأییدشده برای موارد استفاده عمومی رمزنگاری، از جمله امضاهای دیجیتال، HMAC، KDF و تولید بیت تصادفی استفاده شوند. توابع هش غیرمجاز، مانند MD5، نباید برای هیچ هدف رمزنگاری به‌کار گرفته شوند.                                                                                                                | 1     |
| **11.4.2** | رمزعبورها با استفاده از یک تابع مشتق‌سازی کلید تأییدشده و پرهزینه محاسباتی (که به آن «تابع هش رمزعبور» نیز گفته می‌شود) ذخیره شوند، و تنظیمات پارامترها بر اساس راهنمایی‌های کنونی پیکربندی شده باشد. این تنظیمات باید تعادل بین امنیت و عملکرد برقرار کنند تا حملات Brute-force برای سطح امنیت مورد نیاز به‌طور کافی دشوار باشد.      | 2     |
| **11.4.3** | توابع هش استفاده‌شده در امضاهای دیجیتال، باید به‌عنوان بخشی از احراز هویت داده یا یکپارچگی داده، در برابر collision مقاوم بوده و طول بیت مناسب داشته باشند. اگر مقاومت در برابر collision  لازم باشد، طول خروجی باید حداقل 256 بیت باشد. اگر تنها مقاومت در برابر حملات Second Pre-image لازم باشد، طول خروجی باید حداقل 128 بیت باشد. | 2     |
| **11.4.4** | برنامه باید هنگام استخراج کلیدهای مخفی از پسوردها از توابع مشتق‌سازی کلید (KDF) تاییدشده با پارامترهای Key Stretching  استفاده می‌کند. پارامترهای مورد استفاده باید تعادلی بین امنیت و عملکرد برقرار کنند تا از نفوذ حملات brute-force و به خطر افتادن کلید رمزنگاری تولیدشده جلوگیری شود.                                             | 2     |

## V11.5 Random Values

تولید اعداد شبه‌تصادفی امن از نظر رمزنگاری (CSPRNG) بسیار دشوار است. به‌طور کلی، منابع خوب انتروپی در یک سیستم اگر بیش از حد استفاده شوند، سریعاً تخلیه می‌شوند، اما منابع با تصادفی‌بودن کمتر می‌توانند منجر به ایجاد کلیدها و secrets قابل پیش‌بینی شوند.

| #          | شرح الزام                                                                                                                                                                                                                            | سطح |
|:----------:|:-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |:-----:|
| **11.5.1** | اعداد و رشته‌های تصادفی که قرار است قابل حدس نباشند، باید با استفاده از یک تولیدکننده اعداد شبه‌تصادفی امن رمزنگاری‌شده (CSPRNG) تولید شوند و حداقل 128 بیت انتروپی داشته باشند. توجه داشته باشید که UUIDها این شرط را رعایت نمی‌کنند. | 2     |
| **11.5.2** | مکانیزم تولید اعداد تصادفی مورد استفاده به‌گونه‌ای طراحی شده باشد که حتی تحت بار سنگین نیز به‌طور امن عمل کند.                                                                                                                         | 3     |

## V11.6 Public Key Cryptography

رمزنگاری کلید عمومی (Public Key Cryptography) زمانی استفاده می‌شود که امکان یا تمایل به اشتراک‌گذاری کلید مخفی (secret key) بین چندین طرف وجود نداشته باشد.

به‌عنوان بخشی از این موضوع، نیاز به مکانیزم‌های تبادل کلید تأییدشده وجود دارد، مانند Diffie-Hellman و Elliptic Curve Diffie-Hellman (ECDH)، تا اطمینان حاصل شود که سیستم رمزنگاری در برابر تهدیدات مدرن امن باقی می‌ماند. فصل "ارتباط امن" الزامات مربوط به TLS را ارائه می‌دهد، بنابراین الزامات این بخش برای مواقعی در نظر گرفته شده است که رمزنگاری کلید عمومی در موارد استفاده‌ای به غیر از TLS به‌کار گرفته شود.

| #          | شرح الزام                                                                                                                                                                                                                                                                                                                               | سطح |
|:----------:|:----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |:-----:|
| **11.6.1** | فقط الگوریتم‌های رمزنگاری و مدهای عملیاتی تأیید شده برای تولید کلید و مقداردهی اولیه، و همچنین برای تولید و تأیید امضاهای دیجیتال باید استفاده می‌شوند. الگوریتم‌های تولید کلید نباید کلیدهای ناامن تولید کنند که در برابر حملات شناخته شده آسیب‌پذیر باشند؛ به‌عنوان مثال، کلیدهای RSA که در برابر Fermat factorization آسیب‌پذیر هستند. | 2     |
| **11.6.2** | برای تبادل کلید از الگوریتم‌های رمزنگاری تأیید شده (مانند Diffie-Hellman) استفاده می‌شود و تمرکز بر این است که مکانیزم‌های تبادل کلید از پارامترهای امن بهره ببرند. این کار از حملات بر فرآیند برقراری کلید جلوگیری می‌کند و مانع حملات مرد میانی (MITM) یا شکست‌های رمزنگاری می‌شود.                                                     | 3     |

## V11.7 In-Use Data Cryptography

حفاظت از داده‌ها در حین پردازش اهمیت بالایی دارد. توصیه می‌شود از تکنیک‌هایی مانند رمزنگاری کامل حافظه، رمزنگاری داده‌ها در حال انتقال و اطمینان از رمزنگاری سریع داده‌ها پس از استفاده بهره گرفته شود.

| #          | شرح الزام                                                                                                                                                                         | سطح |
|:----------:|:----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |:-----:|
| **11.7.1** | رمزنگاری کامل حافظه (Full Memory Encryption) باید فعال باشد تا داده‌های حساس هنگام استفاده محافظت شوند و دسترسی کاربران یا فرآیندهای غیرمجاز به آن‌ها جلوگیری شود.                  | 3     |
| **11.7.2** | کاهش داده‌ها (data minimization) تضمین می‌کند که حداقل مقدار داده در حین پردازش افشا شود، و اطمینان حاصل شود که داده‌ها بلافاصله پس از استفاده یا در اولین فرصت ممکن رمزنگاری شوند. | 3     |

## References

برای اطلاعات بیشتر، همچنین به منابع زیر مراجعه کنید:

* [OWASP Web Security Testing Guide: Testing for Weak Cryptography](https://owasp.org/www-project-web-security-testing-guide/stable/4-Web_Application_Security_Testing/09-Testing_for_Weak_Cryptography)
* [OWASP Cryptographic Storage Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/Cryptographic_Storage_Cheat_Sheet.html)
* [FIPS 140-3](https://csrc.nist.gov/pubs/fips/140-3/final)
* [NIST SP 800-57](https://csrc.nist.gov/publications/detail/sp/800-57-part-1/rev-5/final)

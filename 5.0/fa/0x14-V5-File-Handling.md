# V5 File Handling

## هدف

استفاده از فایل‌ها می‌تواند انواع مختلفی از ریسک‌ها را برای برنامه ایجاد کند، از جمله حملات انکار سرویس  (DOS)، دسترسی غیرمجاز به اطلاعات، پر شدن فضای ذخیره‌سازی. این فصل شامل مجموعه‌ای از الزامات امنیتی برای مقابله با این تهدیدات است.

## V5.1 File Handling Documentation

این بخش شامل الزاماتی است که بیان می‌کند ویژگی‌های مورد انتظار برای فایل‌هایی که توسط برنامه پذیرفته می‌شوند باید مستندسازی شوند. این مستندسازی پیش‌نیازی ضروری برای طراحی و بررسی کنترل‌های امنیتی مرتبط با بارگذاری فایل‌ها است.

| #         | شرح الزام                                                                                                                                                                                                                                                                                                                  | سطح |
|:---------:|:-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |:---:|
| **5.1.1** | مستندات نوع فایل‌های مجاز، پسوندهای مورد انتظار، و حداکثر اندازه هر فایل (شامل اندازه پس از استخراج) را برای هر قابلیت بارگذاری مشخص کرده باشد. همچنین، مستندات توضیح می‌دهند چگونه فایل‌ها برای دانلود و پردازش توسط کاربران نهایی ایمن‌سازی می‌شوند؛ برای مثال، رفتار برنامه هنگام شناسایی یک فایل مخرب چگونه خواهد بود. | 2   |

## V5.2 File Upload and Content

قابلیت بارگذاری فایل یکی از منابع اصلی ورود فایل‌های غیرقابل اعتماد به سامانه می‌باشد. این بخش الزامات لازم را برای اطمینان از این‌که وجود، حجم یا محتوای این فایل‌ها نمی‌تواند به برنامه آسیب برساند، تشریح می‌کند.

| #         | شرح الزام                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              | سطح |
|:---------:|:-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |:---:|
| **5.2.1** | برنامه تنها فایل‌هایی با حجم مشخص، که قادر به پردازش آن است را می‌پذیرد تا از کاهش عملکرد یا حملات انکار سرویس (DoS) جلوگیری شود.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      | 1   |
| **5.2.2** | هنگام پذیرش فایل توسط برنامه، چه به صورت مستقیم و چه به صورت یک آرشیو مانند فایلzip پسوند فایل با پسوند مورد انتظار مطابقت داشته باشد و اعتبارسنجی محتوای فایل صورت گیرد تا تایید شود محتوای فایل با نوع تعریف‌شده توسط پسوند هم‌خوانی دارد. این فرآیند می تواند شامل موارد بررسی بایت‌های ابتدایی (magic bytes) فایل، انجام بازنویسی تصاویر برای حذف ساختارها و اطلاعات ناخواسته و استفاده از کتابخانه‌های تخصصی برای اعتبارسنجی کامل محتوای فایل باشد اما محدود به آنها نیست. در سطح L1، کافی است این بررسی‌ها  فقط بر روی فایل‌هایی که در فرآیندهای تجاری یا امنیتی خاص استفاده می‌شوند متمرکز باشد. در سطح L2 و بالاتر، این فرآیند باید برای تمامی فایل‌های ورودی برنامه اجرا شود. | 1   |
| **5.2.3** | برنامه باید پیش از استخراج محتوای فایل‌های فشرده (مانند zip، gz، docx، odt)، آن‌ها را از نظر حداکثر اندازه مجاز پس از استخراج و همچنین حداکثر تعداد فایل‌های درون آن بررسی می‌کند.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     | 2   |
| **5.2.4** | برنامه فضای مشخصی برای اندازه فایل و تعداد فایل‌های مجاز برای هر کاربر اعمال می‌کند تا از این طریق، یک کاربر نتواند با بارگذاری تعداد زیادی فایل یا فایل‌های بیش از حد بزرگ، فضای ذخیره‌سازی را پر کند.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                | 3   |
| **5.2.5** | برنامه اجازه بارگذاری فایل‌های فشرده‌ که حاوی لینک های نمادین (symlinks) هستند را نمی‌دهد، مگر اینکه این رفتار به طور مشخص مورد نیاز باشد. در چنین شرایطی  باید یک فهرست مجاز (allowlist) از مسیرها یا فایل‌هایی که می تواند برای آنها لینک نمادین ایجاد شود، اعمال و اعتبارسنجی گردد.                                                                                                                                                                                                                                                                                                                                                                                                 | 3   |
| **5.2.6** | برنامه تصاویر بارگذاری‌شده با اندازه پیکسلی بزرگ‌تر از حد مجاز را رد کند تا از حملات pixel flood attacks جلوگیری شود.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | 3   |

## V5.3 File Storage

این بخش شامل الزامات جلوگیری از اجرای غیرمجاز فایل‌ها پس از بارگذاری، شناسایی محتوای خطرناک و جلوگیری از استفاده از داده‌های غیرمعتبر برای کنترل مکان ذخیره‌سازی فایل‌ها است.

| #         | شرح الزام                                                                                                                                                                                                                                                                                                                                                                                                                              | سطح |
|:---------:|:-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |:---:|
| **5.3.1** | فایل هایی که از ورودی های غیرمعتبر بارگذاری‌ یا تولید می شوند و در پوشه های عمومی قرار می گیرند، هنگام دسترسی مستقیم از طریق یک درخواست HTTP، به عنوان کداجرایی سمت سرور اجرا نشوند.                                                                                                                                                                                                                                                   | 1   |
| **5.3.2** | هنگام ایجاد مسیرهای فایل برای عملیات مختلف، به جای استفاده از نام فایل‌های ارسال شده توسط کاربر، از داده‌های تولید شده داخلی یا منابع مورد اعتماد استفاده شود. و در صورتی که استفاده از نام فایل‌ها یا متادیتای ارسالی توسط کاربر ضروری باشد، می بایست validation و Sanitization اعمال شود. این کار برای جلوگیری از حملاتی مانند Path Traversal، Local or Remote File Inclusion(LFI, RFI) و Server-Side Request Forgery(SSRF) می‌باشد. | 1   |
| **5.3.3** | پردازش فایل‌های سمت سرور، مانند استخراج فایل‌های فشرده، اطلاعات مسیر ارائه شده توسط کاربر را نادیده می‌گیرد تا از آسیب‌پذیری‌هایی مانند zip slip جلوگیری شود.                                                                                                                                                                                                                                                                          | 3   |

## V5.4 File Download

این بخش شامل الزامات برای کاهش ریسک‌ها هنگام ارائه فایل‌ها برای دانلود است، از جمله حملاتPath Traversal  و حملات Injection  می باشد. همچنین اطمینان حاصل می‌شود که فایل‌ها حاوی محتوای خطرناک نباشند.

| #         | شرح الزام                                                                                                                                                                                                   | سطح |
|:---------:|:----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |:---:|
| **5.4.1** | برنامه نام فایل ارسال‌شده توسط کاربر را  چه در قالب JSON، JSONP یا پارامتر URL، اعتبارسنجی می‌کند یا نادیده می‌گیرد، و در پاسخ HTTP، نام فایل را به‌طور صریح در فیلد Content-Disposition هدر مشخص می‌نماید. | 2   |
| **5.4.2** | نام‌های فایل‌های ارائه شده (مانند فیلدهای هدر پاسخ HTTP یا پیوست‌های ایمیل)، به‌درستی encoded یا sanitized شده‌اند (مطابق RFC 6266)، تا ساختار سند حفظ شده و از حملات تزریق جلوگیری شود.                    | 2   |
| **5.4.3** | Verify that files obtained from untrusted sources are scanned by antivirus scanners to prevent serving of known malicious content.                                                                          | 2   |

## References

برای اطلاعات بیشتر، همچنین به منابع زیر مراجعه کنید:

* [OWASP File Upload Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/File_Upload_Cheat_Sheet.html)
* [Example of using symlinks for arbitrary file read](https://hackerone.com/reports/1439593)
* [Explanation of "Magic Bytes" from Wikipedia](https://en.wikipedia.org/wiki/List_of_file_signatures)

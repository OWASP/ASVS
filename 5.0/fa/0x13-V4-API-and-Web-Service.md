# V4 API and Web Service

## هدف

برخی ملاحظات امنیتی صرفا برای برنامه‌هایی که APIهایی را برای استفاده توسط مرورگرهای وب یا مصارف دیگر (معمولاً مبتنی بر   GraphQl JSON ,XML, می باشند(ارائه می‌دهند، مطرح می‌شوند. این فصل شامل پیکربندی‌ها و مکانیزم‌های امنیتی مرتبطی است که باید به این نوع برنامه‌ها اعمال شوند.

توجه کنید نگرانی‌های عمومی امنیتی مانند احراز هویت، مدیریت نشست و اعتبارسنجی ورودی‌ها که در فصل‌های دیگر مطرح شده‌اند، در مورد  APIها نیز صدق می‌کنند. بنابراین این فصل نباید به ‌صورت جداگانه یا خارج از زمینه کلی استاندارد، بررسی یا آزموده شود.

## V4.1 Generic Web Service Security

این بخش به ملاحظات کلی امنیت سرویس‌های وب می‌پردازد و در نتیجه بر رعایت استانداردهای اولیه و اصول بهداشتی امنیتی در طراحی و پیاده‌سازی سرویس‌های وب تأکید دارد.

| #         | شرح الزام                                                                                                                                                                                                                                                                                                                                                                                                                                                                               | سطح |
|:---------:|:--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |:---:|
| **4.1.1** | اطمینان حاصل شود که در هر پاسخ HTTP که شامل Body می باشد، هدر  Content-Type  وجود داشته باشد که نوع آن،  با محتوای پاسخ دریافتی از سرور مطابقت داشته باشد. این هدر باید شامل پارامتر charset نیز باشد تا رمزگذاری کاراکتر ایمن (مانند UTF-8 یا ISO-8859-1) را مشخص کند. این مقادیر باید مطابق با استاندارد IANA Media Types باشند؛ برای مثال، انواعی مانند "text/، /+xml" و "/xml" را در بر می‌گیرند.                                                                                   | 1   |
| **4.1.2** | اطمینان حاصل شود که تنها نقاط پایانی که برای استفاده کاربر نهایی از طریق مرورگر طراحی شده‌اند  (User-Facing Endpoints) به‌صورت خودکار از HTTP  به HTTPS هدایت ‌شوند، سایر سرویس‌ها یا نقاط پایانی نباید (ریدایرکت شفاف، Transparent Redirect) داشته باشند. این اقدام برای جلوگیری از وضعیتی است که در آن یک کلاینت به اشتباه درخواست‌های رمزنگاری‌نشده (HTTP) ارسال می‌کند، اما چون این درخواست‌ها به‌طور خودکار به HTTPS ریدایرکت می‌شوند، نشت احتمالی داده‌های حساس پنهان خواهد ماند. | 2   |
| **4.1.3** | اطمینان حاصل شود که هدرهای HTTP که در برنامه استفاده می شود و  توسط یک لایه واسطه، مانند یکload balancer ، یک پروکسی وب یا یک سرویس backend-for-frontend تنظیم شده است نمی‌تواند توسط کاربر نهایی بازنویسی شود. هدرهای نمونه ممکن است شامل X-Real-IP، X-Forwarded-* یا X-User-ID باشند.                                                                                                                                                                                                 | 2   |
| **4.1.4** | اطمینان حاصل شود که فقط متدهای HTTP که صریحاً توسط برنامه یا API آن پشتیبانی می‌شوند (از جمله OPTIONS در درخواست‌های preflight) می‌توانند مورد استفاده قرار گیرند و متدهای استفاده نشده مسدود شوند.                                                                                                                                                                                                                                                                                     | 3   |
| **4.1.5** | اطمینان حاصل شود که برای درخواست‌ها یا تراکنش‌هایی که بسیار حساس هستند یا از چندین سامانه عبور می‌کنند، از امضاهای دیجیتال در سطح پیام استفاده شود تا اطمینان امنیتی بیشتری علاوه بر محافظت‌های سطح انتقال (مانند TLS) فراهم گردد.                                                                                                                                                                                                                                                      | 3   |

## V4.2 HTTP Message Structure Validation

این بخش به‌صورت دقیق مشخص می‌کند که ساختار و هدرهای درخواست HTTP باید چگونه اعتبارسنجی شوند تا از حملاتی مانند HTTP Request Smuggling، response splitting، header injection و denial of service از طریق یک پیام طولانی HTTP جلوگیری شود. 

این الزامات برای پردازش و تولید کلی پیام‌های HTTP اهمیت دارند، اما به‌ویژه هنگام تبدیل پیام‌های HTTP بین نسخه‌های مختلف HTTP مهم هستند.

| #         | شرح الزام                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              | سطح |
|:---------:|:------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |:---:|
| **4.2.1** | اطمینان حاصل شود که تمامی اجزای برنامه )از جمله لود بالانسرها، فایروال‌ها و سرورهای اپلیکیشن( مرزهای پیام‌های HTTP ورودی را با استفاده از مکانیزم مناسب نسخه های HTTP تعیین می‌کنند تا از  حملات HTTP request smuggling جلوگیری شود.  در HTTP/1.x اگر هدر Transfer-Encoding وجود داشته باشد، هدر Content-Length باید مطابق RFC 2616 نادیده گرفته شود. در مقابل، هنگام استفاده از HTTP/2 یا HTTP/3، اگر هدر Content-Length وجود داشته باشد، گیرنده باید اطمینان حاصل کند که این مقادیر با طول فریم‌های DATA سازگار می‌باشد.                                                                                                                             | 2   |
| **4.2.2** | اطمینان حاصل شود که هنگام تولید پیام‌های HTTP، هدر Content-Length  با طول محتوایی که توسط چارچوب‌بندی پروتکل HTTP تعیین می‌شود، تداخل نداشته باشد تا از حملات request smuggling  جلوگیری شود.                                                                                                                                                                                                                                                                                                                                                                                                                                                          | 3   |
| **4.2.3** | اطمینان حاصل شود برنامه، پیام‌های HTTP/2 یا HTTP/3 با هدرهای connection-specific مانند Transfer-Encoding را به منظور جلوگیری از حملات response splitting یا header injection  ارسال یا قبول نمی کند.                                                                                                                                                                                                                                                                                                                                                                                                                                                   | 3   |
| **4.2.4** | اطمینان حاصل شود برنامه تنها درخواست های HTTP/2 and HTTP/3 که هدرها و مقادیر آن شامل هیچ توالی CR (\r), LF (\n), CRLF (\r\n)  نباشد را می پذیرد تا از حملات header injection جلوگیری کند.                                                                                                                                                                                                                                                                                                                                                                                                                                                              | 3   |
| **4.2.5** | اطمینان حاصل کنید که اگر برنامه (Frontend or Backend)  اقدام به ساخت و ارسال درخواست‌های HTTP  می کند از مکانیزم های  validation ، sanitization یا سایر مکانیزم‌ها استفاده کند تا از ایجاد URIها (مانند فراخوانیAPI ) یا فیلدهای هدر درخواست HTTP  (مانند Authorization یا( Cookie که بیش از حد مجاز، طولانی هستند، جلوگیری شود که منجر به عدم پذیرش درخواست توسط مولفه دریافت کننده(هر بخشی از زیرساخت یا سامانه که درخواست HTTP را دریافت و پردازش می‌کند) شود. عدم رعایت این موضوع می تواند باعث وقوع حمله Danial of Service شود، ارسال یک درخواست بیش از حد طولانی (مانند یک فیلد هدر کوکی طولانی) باعث می شود سرور همواره  با وضعیت خطا پاسخ دهد. | 3   |

## V4.3 GraphQL

GraphQL  به‌طور فزاینده‌ای در حال تبدیل شدن به روشی رایج برای توسعه‌ی کلاینت‌های داده‌محور است، که به‌صورت مستقیم به چندین سرویس مختلف در backend وابسته نیستند. این بخش به ملاحظات امنیتی ویژه مربوط به استفاده از GraphQL می‌پردازد.

| #         | شرح الزام                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             | سطح |
|:---------:|:----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |:---:|
| **4.3.1** | اطمینان حاصل شود یکی از مکانیزم ها برای جلوگیری از حملات انکار سرویس (DoS) درلایه GraphQL  یا لایه داده استفاده شده است. این مکانیزم‌ها عبارتند از استفاده از فهرست مجاز کوئری‌ها ( Query Allowlist)، محدودسازی عمق کوئری‌ها (Depth Limiting)،محدودسازی تعداد یا حجم داده(Amount Limiting) و تحلیل هزینه کوئری (Query Cost Analysis). این اقدامات، به منظور مقابله با درخواست های پیچیده، تو در تو  یا کوئری‌های پرهزینه که می توانند موجب مصرف بیش از حد منابع و اختلال در سرویس دهی شوند ضروری است. | 2   |
| **4.3.2** | اطمینان حاصل شود که قابلیت  Introspection در GraphQL  در محیط تولید (Production)  غیرفعال شده‌است، مگرAPI مبتنی بر GraphQL به‌صورت صریح برای استفاده توسط اشخاص یا سامانه های ثالث (Third Parties)  طراحی شده باشد.                                                                                                                                                                                                                                                                                   | 2   |

## V4.4 WebSocket

WebSocket یک پروتکل ارتباطی است که امکان ارتباط دوطرفه هم‌زمان را از طریق یک اتصال TCP فراهم می‌کند.
این پروتکل در سال ۲۰۱۱ توسط IETF  در قالب RFC 6455 استانداردسازی شد. اگرچه WebSocket برای کار کردن از طریق پورت‌های رایج HTTP یعنی پورت 443 (HTTPS) و پورت 80 (HTTP) طراحی شده، اما پروتکلی مجزا از HTTP محسوب می‌شود.

این بخش به الزامات کلیدی امنیتی می‌پردازد که برای جلوگیری از حملاتی طراحی شده‌اند که از طریق این کانال ارتباطی بلادرنگ، به‌ویژه در حوزه‌های امنیت ارتباطات و مدیریت نشست انجام می‌گیرند.

| #         | شرح الزام                                                                                                                                                                                                                                     | سطح |
|:---------:|:--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |:---:|
| **4.4.1** | اطمینان حاصل شود که تمامی ارتباطات WebSocket از طریق پروتکل TLS( WSS)  برقرار می‌شوند.                                                                                                                                                        | 1   |
| **4.4.2** | اطمینان حاصل شود که در هنگام Handshake اولیه‌ی HTTP برای WebSocket، مقدار هدر Origin بررسی ‌شود و در صورتی که با لیستی از مبداهای مجاز (allowed origins) برای برنامه مطابقت داشته باشد، اتصال پذیرفته می‌شود.                                 | 2   |
| **4.4.3** | اطمینان حاصل شود که در صورتی که امکان استفاده از مکانیزم استاندارد مدیریت نشست برنامه وجود نداشته باشد، از توکن‌های اختصاصی (Duplicated Tokens)   برای این منظور استفاده شود که با الزامات امنیتی مدیریت نشست به طور کامل مطابقت داشته باشند. | 2   |
| **4.4.4** | اطمینان حاصل شود که توکن‌های اختصاصی مدیریت نشست WebSocket در هنگام انتقال از یک نشست  HTTPS  موجود به کانالWebSocket، از طریق نشست HTTPS احراز هویت‌شده قبلی، دریافت یا اعتبارسنجی می‌شوند.                                                  | 2   |

## References

برای اطلاعات بیشتر، همچنین به منابع زیر مراجعه کنید:

* [OWASP REST Security Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/REST_Security_Cheat_Sheet.html)
* Resources on GraphQL Authorization from [graphql.org](https://graphql.org/learn/authorization/) and [Apollo](https://www.apollographql.com/docs/apollo-server/security/authentication/#authorization-methods).
* [OWASP Web Security Testing Guide: GraphQL Testing](https://owasp.org/www-project-web-security-testing-guide/stable/4-Web_Application_Security_Testing/12-API_Testing/01-Testing_GraphQL)
* [OWASP Web Security Testing Guide: Testing WebSockets](https://owasp.org/www-project-web-security-testing-guide/stable/4-Web_Application_Security_Testing/11-Client-side_Testing/10-Testing_WebSockets)

# V16 Security Logging and Error Handling

## هدف

لاگ‌های امنیتی با لاگ‌های خطا یا لاگ‌های عملکرد متفاوت هستند و برای ثبت رویدادهای مرتبط با امنیت استفاده می‌شوند؛ مانند تصمیم‌های مربوط به احراز هویت، کنترل دسترسی، و تلاش‌ها برای دور زدن کنترل‌های امنیتی (مانند اعتبارسنجی ورودی یا اعتبارسنجی منطق تجاری).هدف آن‌ها پشتیبانی از تشخیص، پاسخ و بررسی است، از طریق ارائه داده‌های ساختاریافته و باکیفیت بالا برای ابزارهای تحلیلی مانند SIEM.

لاگ‌ها نباید شامل داده‌های شخصی حساس باشند مگر در مواردی که قانون الزام کند. هر داده‌ای که لاگ می‌شود باید به‌عنوان یک دارایی بسیار باارزش محافظت شود. لاگ‌برداری نباید باعث به خطر افتادن حریم خصوصی یا امنیت سیستم شود. همچنین برنامه باید در شرایط خطا به‌صورت ایمن عمل کند و از افشای غیرضروری اطلاعات یا ایجاد اختلال جلوگیری کند.

برای راهنمایی دقیق در مورد پیاده‌سازی، به OWASP Cheat Sheets در بخش منابع مراجعه کنید.

## V16.1 Security Logging Documentation

این بخش تضمین می‌کند که یک دارایی (Inventory) شفاف و کامل از لاگ‌گیری در سراسر stack برنامه وجود داشته باشد. این کار برای نظارت امنیتی مؤثر، پاسخ به حوادث و انطباق (Compliance) ضروری است.

| #          | شرح الزام                                                                                                                                                                                                                                | سطح |
|:----------:| ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------:|:---:|
| **16.1.1** | فهرستی باید وجود داشته باشد که در آن ثبت وقایع (Logging) انجام‌شده در هر لایه از stack فناوری برنامه، رویدادهای ثبت‌شده، فرمت‌های لاگ، محل ذخیره‌سازی، نحوه استفاده، نحوه کنترل دسترسی به آن‌ها و مدت زمان نگهداری لاگ‌ها مستند شده است. | 2   |

## V16.2 General Logging

این بخش الزامات لازم را ارائه می‌دهد تا اطمینان حاصل شود که لاگ‌های امنیتی به‌صورت یکپارچه ساختاردهی شده‌اند و متادیتا مورد انتظار را در خود دارند. هدف این است که لاگ‌ها قابل‌خواندن توسط ماشین باشند و بتوان آن‌ها را در سیستم‌ها و ابزارهای توزیع‌شده تحلیل کرد.

به‌طور طبیعی، رویدادهای امنیتی اغلب شامل داده‌های حساس هستند. اگر چنین داده‌ای بدون ملاحظه در لاگ‌ها ثبت شود، خود لاگ‌ها به‌عنوان داده‌های طبقه‌بندی‌شده محسوب می‌شوند و بنابراین مشمول الزامات رمزنگاری، سیاست‌های سخت‌گیرانه‌تر نگهداری و همچنین احتمال افشا در طول ممیزی‌ها خواهند بود.

بنابراین، بسیار مهم است که فقط موارد ضروری در لاگ‌ها ثبت شوند و داده‌های لاگ با همان دقت و مراقبتی که برای سایر دارایی‌های حساس به‌کار می‌رود، مورد توجه قرار گیرند.

الزامات زیر، نیازمندی‌های پایه‌ای مربوط به متادیتا در لاگ‌ها، همگام‌سازی، فرمت و کنترل را مشخص می‌کنند.

| #          | شرح الزام                                                                                                                                                                                                                                                                                                                             | سطح |
|:----------:| -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------:|:---:|
| **16.2.1** | هر ورودی لاگ باید شامل متادیتای لازم (مانند زمان، مکان، چه کسی و چه چیزی) باشد تا امکان بررسی دقیق خط زمانی هنگام وقوع یک رویداد فراهم شود.                                                                                                                                                                                           | 2   |
| **16.2.2** | منابع زمانی برای تمام مؤلفه‌های لاگ با هم همگام‌سازی شده‌اند و مهر زمان (timestamp)‌ در متادیتای رویدادهای امنیتی از UTC استفاده ‌کند یا شامل یک اختلاف‌زمان (time zone offset) صریح باشد. استفاده از UTC توصیه می‌شود تا یکپارچگی در سراسر سیستم‌های توزیع‌شده تضمین شود و از بروز سردرگمی در زمان تغییر ساعت تابستانی جلوگیری گردد. | 2   |
| **16.2.3** | برنامه تنها لاگ‌ها را در فایل‌ها و سرویس‌هایی ذخیره یا ارسال می‌کند که در فهرست مستند لاگ‌ها ثبت شده‌اند.                                                                                                                                                                                                                             | 2   |
| **16.2.4** | لاگ‌ها باید  توسط پردازشگر لاگی که در حال استفاده است خوانده و همبسته شوند، و ترجیحاً با استفاده از یک فرمت لاگ مشترک این کار انجام گیرد.                                                                                                                                                                                             | 2   |
| **16.2.5** | هنگام لاگ‌گیری از داده‌های حساس، برنامه باید لاگ گیری را بر اساس سطح حفاظت داده اعمال کند. برای مثال، ممکن است لاگ‌کردن برخی داده‌ها مانند اطلاعات ورود یا جزئیات پرداخت مجاز نباشد. داده‌های دیگر، مانند session token، تنها در صورتی باید لاگ شوند که به‌صورت hash یا masked، چه به‌طور کامل یا جزئی، ثبت شوند.                     | 2   |

## V16.3 Security Events

این بخش الزامات مربوط به لاگ‌برداری از رویدادهای مرتبط با امنیت در داخل برنامه را تعریف می‌کند. ثبت این رویدادها برای شناسایی رفتارهای مشکوک، پشتیبانی از تحقیقات، و انجام تعهدات مربوط به انطباق است.

این بخش انواع رویدادهایی که باید لاگ شوند را مشخص می‌کند، اما سعی ندارد جزئیات کامل و جامعی ارائه دهد. هر برنامه دارای عوامل ریسک و زمینه عملیاتی منحصربه‌فرد خود است.

توجه داشته باشید ASVS در حالی شامل لاگ‌گیری رویدادهای امنیتی در محدوده خود می‌شود که Alerting و Correlation (مثلاً قوانین SIEM یا زیرساخت‌های مانیتورینگ) خارج از محدوده در نظر گرفته شده و توسط سیستم‌های عملیاتی و نظارتی مدیریت می‌شوند.

| #          | شرح الزام                                                                                                                                                                                                                             | سطح |
|:----------:| -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------:|:---:|
| **16.3.1** | تمام عملیات احراز هویت باید لاگ‌گیری ‌شوند، از جمله تلاش‌های موفق و ناموفق. همچنین باید متادیتای اضافی، مانند نوع احراز هویت یا عوامل استفاده‌شده، جمع‌آوری شود.                                                                      | 2   |
| **16.3.2** | تلاش‌های ناموفق برای مجوزدهی (authorization) باید لاگ‌گیری ‌شوند. برای برنامه‌های L3، این باید شامل لاگ‌گیری تمام تصمیمات مجوزدهی باشد، از جمله ثبت زمانی که داده‌های حساس دسترسی پیدا می‌کنند، بدون آنکه خود داده‌های حساس ثبت شوند. | 2   |
| **16.3.3** | برنامه باید رویدادهای امنیتی تعریف‌شده در مستندات (ابتدای بخش) را لاگ‌ نماید و همچنین تلاش‌ها برای دور زدن کنترل‌های امنیتی، مانند اعتبارسنجی ورودی، منطق کسب‌وکار و ضد‌خودکارسازی، را نیز ثبت ‌کند.                                  | 2   |
| **16.3.4** | برنامه باید خطاهای غیرمنتظره و شکست‌های کنترل‌های امنیتی، مانند شکست‌های TLS در بک اند را لاگ ‌کند.                                                                                                                                   | 2   |

## V16.4 Log Protection

لاگ‌ها به عنوان آثار ارزشمند forensic محسوب می‌شوند و باید محافظت شوند. اگر لاگ‌ها به‌سادگی قابل تغییر یا حذف باشند، یکپارچگی خود را از دست می‌دهند و برای تحقیقات حادثه یا پرونده‌های حقوقی غیرقابل اعتماد می‌شوند. همچنین، لاگ‌ها ممکن است رفتار داخلی برنامه یا متادیتای حساس را فاش کنند و این موضوع آن‌ها را به هدف جذابی برای مهاجمان تبدیل می‌کند.

این بخش الزامات را برای اطمینان از حفاظت لاگ‌ها در برابر دسترسی غیرمجاز، دستکاری و افشا تعریف می‌کند و همچنین تضمین می‌کند که لاگ‌ها به‌صورت ایمن منتقل و در سیستم‌های امن و ایزوله ذخیره شوند.

| #          | شرح الزام                                                                                                                                                   | سطح |
|:----------:| -----------------------------------------------------------------------------------------------------------------------------------------------------------:|:---:|
| **16.4.1** | تمام مؤلفه‌های لاگ‌گیری باید داده‌ها را به‌طور مناسب رمزگذاری ‌کنند تا از حملات log injection جلوگیری شود.                                                  | 2   |
| **16.4.2** | لاگ‌ها باید در برابر دسترسی غیرمجاز محافظت شده و امکان تغییر آن‌ها وجود نداشته باشد.                                                                        | 2   |
| **16.4.3** | لاگ‌ها به‌صورت امن باید به یک سیستم منطقی جداگانه برای تحلیل، تشخیص، هشدار و ارجاع منتقل شوند. هدف این است که در صورت نفوذ به برنامه، لاگ‌ها به خطر نیفتند. | 2   |

## V16.5 Error Handling

این بخش الزامات لازم را برای اطمینان از این که برنامه‌ها به‌صورت امن و بدون افشای جزئیات حساس داخلی دچار خطا می‌شوند، تعریف می‌کند.

| #          | شرح الزام                                                                                                                                                                                                                                                                                   | سطح |
|:----------:| -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------:|:---:|
| **16.5.1** | هنگام بروز خطاهای غیرمنتظره یا حساس به امنیت، پیامی عمومی به کاربر باید بازگردانده ‌شود، به‌گونه‌ای که هیچ‌گونه اطلاعات حساس داخلی سیستم مانند stack trace، کوئری‌ها، کلیدها و توکن‌های محرمانه افشا نشود.                                                                                  | 2   |
| **16.5.2** | برنامه باید هنگام بروز خطا در دسترسی به منابع خارجی همچنان به‌صورت امن عمل نماید، برای مثال با استفاده از الگوهایی مانند circuit breaker یا کاهش تدریجی عملکرد (graceful degradation).                                                                                                      | 2   |
| **16.5.3** | برنامه باید به‌صورت امن و کنترل‌شده دچار خطا ‌شود، حتی هنگام وقوع استثنا، و از شرایط fail-open جلوگیری نماید؛ برای مثال، از پردازش تراکنش در صورت بروز خطا در منطق اعتبارسنجی جلوگیری شود.                                                                                                  | 2   |
| **16.5.4** | یک « last resort» باید تعریف شده باشد که تمامی unhandled exception را مدیریت کند. این کار هم برای جلوگیری از از دست رفتن جزئیات خطا که باید در فایل‌های لاگ ثبت شوند و هم برای اطمینان از این است که خطا باعث از کار افتادن کل فرآیند برنامه و در نتیجه از دست رفتن دسترسی نشود، ضروری است. | 3   |

توجه: برخی زبان‌ها (از جمله Swift و Go و همچنین بسیاری از زبان‌های تابعی بر اساس رویه‌های متداول طراحی) از exceptions یا last resort پشتیبانی نمی‌کنند. در این موارد، معماران و توسعه‌دهندگان باید از یک الگو، زبان، یا روش سازگار با چارچوب کاری استفاده کنند تا اطمینان حاصل شود که برنامه‌ها می‌توانند رویدادهای استثنائی، غیرمنتظره یا مرتبط با امنیت را به‌صورت امن مدیریت کنند.

## References

برای اطلاعات بیشتر، همچنین به منابع زیر مراجعه کنید:

* [OWASP Web Security Testing Guide: Testing for Error Handling](https://owasp.org/www-project-web-security-testing-guide/stable/4-Web_Application_Security_Testing/08-Testing_for_Error_Handling/README)
* [OWASP Authentication Cheat Sheet section about error messages](https://cheatsheetseries.owasp.org/cheatsheets/Authentication_Cheat_Sheet.html#authentication-and-error-messages)
* [OWASP Logging Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/Logging_Cheat_Sheet.html)
* [OWASP Application Logging Vocabulary Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/Logging_Vocabulary_Cheat_Sheet.html)

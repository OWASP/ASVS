# V15 Secure Coding and Architecture

## Control Objective

بسیاری از الزامات ASVS یا به یک حوزه خاص امنیتی مانند احراز هویت یا مجوزدهی و یا به یک نوع خاص از کارکردهای نرم‌افزار مانند ثبت رخدادها یا مدیریت فایل مرتبط می‌باشند.

این فصل الزامات کلی امنیتی که باید هنگام طراحی و توسعه نرم‌افزارها در نظر گرفته شوند را ارائه می‌دهد. این الزامات نه تنها بر معماری تمیز و کیفیت کد تمرکز دارند، بلکه شامل شیوه‌های خاص معماری و کدنویسی نیز می‌شوند که برای امنیت نرم‌افزار ضروری هستند.

## V15.1 Secure Coding and Architecture Documentation

بسیاری از الزامات مربوط به ایجاد یک معماری امن و قابل دفاع، به مستندسازی شفاف تصمیماتی بستگی دارند که در مورد پیاده‌سازی کنترل‌های امنیتی مشخص و مؤلفه‌های استفاده‌شده در نرم‌افزار اتخاذ می‌شوند.

این بخش، الزامات مستندسازی را شرح می‌دهد، از جمله شناسایی مؤلفه‌هایی که دارای «عملکرد خطرناک» در نظر گرفته می‌شوند یا به عنوان «مؤلفه‌های پرریسک» شناخته می‌شوند.

یک مؤلفه با «عملکرد خطرناک» ممکن است یک مؤلفه توسعه‌یافته داخلی یا شخص ثالث باشد که عملیات‌هایی مانند deserialization داده‌های غیرقابل‌اعتماد، پردازش داده‌های خام یا باینری، اجرای کد به‌صورت پویا، یا دستکاری مستقیم حافظه را انجام می‌دهد. آسیب‌پذیری‌ها در این نوع عملیات‌ها ریسک بالایی برای به خطر انداختن برنامه و احتمالاً افشای زیرساخت زیربنایی آن ایجاد می‌کنند.

یک «مؤلفه پرریسک» یک کتابخانه شخص ثالث است (یعنی توسعه‌یافته داخلی نیست) که کنترل‌های امنیتی در فرآیند توسعه یا عملکرد آن وجود ندارد یا ضعیف پیاده‌سازی شده‌اند. نمونه‌ها شامل مؤلفه‌هایی هستند که به‌خوبی نگهداری نمی‌شوند، پشتیبانی نمی‌شوند، در مرحله end-of-life  قرار دارند، یا سابقه‌ای از آسیب‌پذیری‌های جدی دارند.

 این بخش همچنین بر اهمیت تعیین بازه‌های زمانی مناسب برای رسیدگی به آسیب‌پذیری‌ها در مؤلفه‌های شخص ثالث تأکید می‌کند.

| #          | شرح الزام                                                                                                                                                                                                                                                                                                                                                                                                                 | سطح |
|:----------:| -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------:|:---:|
| **15.1.1** | مستندات برنامه باید بازه‌های زمانی جهت برطرف سازی آسیب‌پذیری‌ نسخه‌های مؤلفه‌ شخص ثالث (بر اساس ریسک) و همچنین به‌روزرسانی کتابخانه‌ها را به طور کلی تعریف کرده باشد تا ریسک ناشی از این مؤلفه‌ها به حداقل برسد.                                                                                                                                                                                                          | 1   |
| **15.1.2** | یک کاتالوگ دارایی مانند Software Bill of Materials (SBOM) باید برای تمامی کتابخانه‌های شخص ثالث مورد استفاده نگهداری شود. شامل تایید این که مؤلفه‌ها از مخازن از پیش تعیین‌شده، قابل اعتماد و به‌طور مستمر نگهداری‌شده تهیه شده‌اند.                                                                                                                                                                                      | 2   |
| **15.1.3** | مستندات برنامه باید شامل عملکردهایی که زمان‌بر یا پرمصرف(منابع سیستمی) هستند نیز باشد. این مورد باید شامل روش‌هایی برای جلوگیری از دست‌رفتن دسترس‌پذیری به دلیل استفاده بیش از حد از این عملکردها و همچنین جلوگیری از وضعیتی باشد که پردازش یک پاسخ طولانی‌تر از زمان انتظار مصرف‌کننده شود. تدابیر احتمالی می‌تواند شامل پردازش غیرهمزمان، استفاده از صف‌ها و محدود کردن فرآیندهای موازی برای هر کاربر و هر برنامه باشد. | 2   |
| **15.1.4** | مستندات برنامه باید کتابخانه‌های شخص ثالثی را که به‌عنوان «کامپوننت‌های پرخطر» شناخته می‌شوند، مشخص کرده باشد.                                                                                                                                                                                                                                                                                                            | 3   |
| **15.1.5** | مستندات برنامه باید بخش‌هایی از برنامه را که به‌عنوان «عملکرد خطرناک» استفاده می‌شود، مشخص کرده باشد.                                                                                                                                                                                                                                                                                                                     | 3   |

## V15.2 Security Architecture and Dependencies

این بخش شامل الزامات مربوط به مدیریت وابستگی‌ها و کامپوننت‌ها می‌باشد تا اجزای پرخطر، قدیمی یا ناامن به‌طور مؤثر شناسایی، کنترل و اداره شوند.

 همچنین شامل استفاده از تکنیک‌های سطح معماری مانند sandboxing، encapsulation، containerization و ایزوله‌سازی شبکه می‌باشد تا تأثیر استفاده از «عملیات خطرناک» (Dangerous operations) یا «کامپوننت‌های پرخطر» (dangerous operations) (همان‌طور که در بخش قبلی تعریف شد) کاهش یابد و از کاهش دسترسی به دلیل استفاده بیش از حد از عملکردهای پرمصرف منابع جلوگیری شود.

| #          | شرح الزام                                                                                                                                                                                                                                                                                                                                                                                                                                         | سطح |
|:----------:| -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------:|:---:|
| **15.2.1** | برنامه باید تنها شامل کامپوننت‌هایی باشد که چارچوب‌های زمانی مستند‌شده برای به‌روزرسانی و رفع آسیب‌پذیری‌ها را نقض نکرده‌باشند.                                                                                                                                                                                                                                                                                                                   | 1   |
| **15.2.2** | برنامه باید  بر اساس تصمیمات و استراتژی‌های امنیتی مستندسازی‌شده، تدابیری برای جلوگیری از کاهش دسترس‌پذیری ناشی از عملکردهایی که زمان‌بر یا پرمصرف منابع هستند، پیاده‌سازی کرده باشد.                                                                                                                                                                                                                                                             | 2   |
| **15.2.3** | محیط production تنها شامل عملکردهایی می‌باشد که برای اجرای برنامه ضروری هستند و هیچ قابلیت اضافی مانند کدهای تست، نمونه‌کدها و عملکردهای توسعه‌ای در دسترس نمی‌باشد.                                                                                                                                                                                                                                                                              | 2   |
| **15.2.4** | کامپوننت‌های شخص ثالث و تمام وابستگی‌های انتقالی آن‌ها از مخزن مورد انتظار باید دریافت ‌شوند، چه داخلی و چه منبع خارجی، و ریسک حمله‌ی dependency confusion مدیریت شود.                                                                                                                                                                                                                                                                            | 3   |
| **15.2.5** | برنامه باید محافظت‌های اضافی را در بخش‌هایی از برنامه که به‌عنوان «عملکرد خطرناک» مستند شده‌اند یا از کتابخانه‌های شخص ثالثی که به‌عنوان «کامپوننت‌های پرریسک» شناخته می‌شوند، پیاده‌سازی می‌کند. این می‌تواند شامل تکنیک‌هایی مانند sandboxing، encapsulation، containerization یا جداسازی در سطح شبکه باشد تا حمله‌کنندگان پس از نفوذ به یک بخش از برنامه، نتوانند به بخش‌های دیگر برنامه منتقل شوند و زمان لازم برای پیشروی آن‌ها افزایش یابد. | 3   |

## V15.3 Defensive Coding

این بخش انواع آسیب‌پذیری‌ها را پوشش می‌دهد، از جمله type juggling، prototype pollution و سایر مواردی که ناشی استفاده از الگوهای ناامن برنامه‌نویسی در یک زبان خاص هستند. برخی از این آسیب‌پذیری‌ها ممکن است برای همه زبان‌ها مرتبط نباشند، در حالی که برخی دیگر راه‌حل‌های خاص زبان دارند یا به نحوه مدیریت ویژگی‌هایی مانند پارامترهای HTTP توسط یک زبان یا فریم‌ورک خاص مربوط می‌شوند. همچنین، این بخش به خطر عدم اعتبارسنجی )رمزنگاری شده( به‌روزرسانی‌های برنامه نیز می‌پردازد.

این بخش همچنین خطرات مرتبط با استفاده از Objects برای نمایش داده‌ها و پذیرش و بازگرداندن آن‌ها از طریق APIهای خارجی را مورد بررسی قرار می‌دهد. در این حالت، برنامه باید اطمینان حاصل کند که فیلدهای داده‌ای که نباید قابل ویرایش باشند توسط ورودی کاربر تغییر نمی‌کنند (mass assignment) و API به‌صورت انتخابی مشخص کند که کدام فیلدهای داده بازگردانده شوند. هر جایی که دسترسی به فیلدها به مجوزهای کاربر وابسته باشد، این موضوع باید در چارچوب الزامات کنترل دسترسی در سطح فیلدها در فصل Authorization در نظر گرفته شود.

| #          | شرح الزام                                                                                                                                                                                                                                                                                                                                                                                  | سطح |
|:----------:| ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------:|:---:|
| **15.3.1** | برنامه باید تنها زیرمجموعه‌ای از فیلدهای مورد نیاز از یک data object را بازگرداند. به‌عنوان مثال، نباید کل data object بازگردانده شود، زیرا برخی فیلدهای منفرد نباید برای کاربران قابل دسترسی باشند.                                                                                                                                                                                       | 1   |
| **15.3.2** | در جایی که بک‌اند برنامه به URLهای خارجی فراخوانی می‌فرستد، طوری باید پیکربندی شده باشد که تنها در صورت نیاز و منظور مشخص، از تغییر مسیرها (redirects) پیروی کند.                                                                                                                                                                                                                          | 2   |
| **15.3.3** | برنامه باید دارای تدابیر مقابله‌ای برای محافظت در برابر حملات mass assignment باشد، به‌طوری که فیلدهای مجاز برای هر کنترلر و اکشن محدود شده باشند؛ به عنوان مثال، نباید بتوان مقداری برای فیلدی وارد یا به‌روزرسانی کرد که قرار نبوده بخشی از آن اکشن باشد.                                                                                                                                | 2   |
| **15.3.4** | تمام اجزای proxying و middleware باید آدرس IP اصلی کاربر را به‌درستی منتقل کنند، با استفاده از فیلدهای داده معتبر که توسط کاربر نهایی قابل دستکاری نباشند، و برنامه و وب‌سرور از این مقدار صحیح برای ثبت لاگ و تصمیم‌گیری‌های امنیتی مانند rate limiting استفاده کنند، با در نظر گرفتن اینکه حتی آدرس IP اصلی ممکن است به دلیل IPهای پویا، VPNها یا فایروال‌های سازمانی قابل اعتماد نباشد. | 2   |
| **15.3.5** | برنامه باید به‌طور صریح اطمینان حاصل کند که variables از نوع صحیح هستند و عملیات‌های مقایسه و comparator به‌صورت دقیق (strict) انجام می‌شوند. این اقدام برای جلوگیری از آسیب‌پذیری‌های type juggling یا type confusion است که ممکن است به دلیل فرضیات نادرست برنامه درباره نوع یک متغیر ایجاد شود.                                                                                         | 2   |
| **15.3.6** | کد JavaScript باید به‌گونه‌ای نوشته شده باشد که از prototype pollution جلوگیری کند، برای مثال با استفاده از Set() یا Map() به جای object literals.                                                                                                                                                                                                                                         | 2   |
| **15.3.7** | برنامه باید دارای تدابیر محافظتی در برابر HTTP parameter pollution باشد، به‌ویژه اگر چارچوب برنامه تفاوتی بین منابع پارامترهای درخواست (رشته‌های query، پارامترهای body، کوکی‌ها یا فیلدهای هدر) قائل نشود.                                                                                                                                                                                | 2   |

## V15.4 Safe Concurrency

مسائل همزمانی مانند race condition، آسیب‌پذیری‌های time-of-check to time-of-use (TOCTOU)، deadlock، livelock، thread starvation و همگام‌سازی نادرست می‌توانند منجر به رفتار غیرقابل پیش‌بینی و خطرات امنیتی شوند. این بخش شامل تکنیک‌ها و استراتژی‌های مختلفی است که به کاهش این ریسک‌ها کمک می‌کنند.

| #          | شرح الزام                                                                                                                                                                                                                                                                                                                                     | سطح |
|:----------:| ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------:|:---:|
| **15.4.1** | shared objects در کد multi-threaded (مانند cacheها، فایل‌ها، یا اشیائی که توسط multiple threads دسترسی پیدا می‌کنند) باید به‌صورت ایمن مورد استفاده قرار بگیرند، با استفاده از نوع‌های thread-safe و مکانیزم‌های همگام‌سازی مانند lock یا semaphore تا از race condition و تخریب داده جلوگیری شود.                                            | 3   |
| **15.4.2** | بررسی وضعیت یک resource، مانند وجود آن یا دسترسی‌ها،و اقداماتی که به این وضعیت وابسته‌اند، به‌صورت یک عملیات واحد انجام شوند تا از race condition نوع time-of-check to time-of-use (TOCTOU) جلوگیری شود. برای مثال، بررسی اینکه یک فایل وجود دارد قبل از باز کردن آن، یا تأیید دسترسی یک کاربر قبل از اعطای آن.                               | 3   |
| **15.4.3** | باید  از قفل‌ها (Locks) به طور یکنواخت استفاده شود تا از گیر کردن (Threads) جلوگیری شود، چه با انتظار برای یکدیگر و چه با تلاش بی‌پایان، و همچنین منطق قفل‌گذاری باید در همان کدی باقی بماند که مسئول مدیریت منبع است؛ این کار تضمین می‌کند که قفل‌ها نمی‌توانند به‌صورت ناخواسته یا خرابکارانه توسط کلاس‌ها یا کدهای بیرونی تغییر داده شوند. | 3   |
| **15.4.4** | تأیید کنید که سیاست‌های تخصیص resource از thread starvation جلوگیری می‌کنند، با اطمینان از دسترسی عادلانه به منابع، مانند استفاده از thread pools و اجازه دادن به threads با اولویت پایین‌تر تا در بازه زمانی منطقی پیشرفت کنند.                                                                                                              | 3   |

## References

برای اطلاعات بیشتر، همچنین به منابع زیر مراجعه کنید:

* [OWASP Prototype Pollution Prevention Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/Prototype_Pollution_Prevention_Cheat_Sheet.html)
* [OWASP Mass Assignment Prevention Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/Mass_Assignment_Cheat_Sheet.html)
* [OWASP CycloneDX Bill of Materials Specification](https://owasp.org/www-project-cyclonedx/)
* [OWASP Web Security Testing Guide: Testing for HTTP Parameter Pollution](https://owasp.org/www-project-web-security-testing-guide/stable/4-Web_Application_Security_Testing/07-Input_Validation_Testing/04-Testing_for_HTTP_Parameter_Pollution)

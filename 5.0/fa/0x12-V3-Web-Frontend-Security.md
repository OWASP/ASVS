# V3 امنیت رابط کاربری وب (Web Frontend Security)

## هدف کنترلی

این دسته از الزامات بر روی محافظت در برابر حملاتی تمرکز دارد که از طریق رابط وب (Web Frontend) برنامه اجرا می‌شوند. این الزامات برای راهکارهایی از نوع ماشین-به-ماشین (Machine-to-Machine) کاربردی ندارند.

## V3.1 مستندسازی امنیت رابط کاربری وب ( Web Frontend Security Documentation)

این بخش ویژگی‌های امنیتی مرورگر را که باید در مستندات برنامه مشخص شوند، توضیح می‌دهد.

| #         | Description                                                                                                                                                                                                                                                                                                                                                                                                                   | Level |
|:---------:|:----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |:-----:|
| **3.1.1** | در مستندات برنامه باید ویژگی‌های امنیتی مربوط به مرورگری که برنامه را اجرا میکند مشخص شده باشد (نظیر استفاده از HTTPS، پشتیبانی از HTTP Strict Transport Security (HSTS)، اجرای Content Security Policy (CSP) و سایر مکانیزم‌های امنیتی مرتبط با HTTP). همچنین در مستندات باید مشخص شود مرورگر در صورت عدم دسترسی به این ویژگی‌ها چه رفتاری باید داشته باشد. (برای مثال: نمایش هشدار به کاربر یا ممانعت از دسترسی به برنامه). | 3     |

## V3.2 تفسیر ناخواسته محتوا (Unintended Content Interpretation)

پردازش محتوا یا عملکرد مربوط به آن در یک شرایط زمینه‌‌ای نادرست می‌تواند منجر به اجرای یا نمایش محتوای مخرب برای کاربر شود. 

| #         | Description                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       | Level |
|:---------:|:----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |:-----:|
| **3.2.1** | کنترل‌های امنیتی متناسب با مرورگر‌ها در هنگام پردازش پاسخ‌های HTTP  به منظور جلوگیری از پردازش محتوا یا عملکرد مربوط به آن در شرایط زمینه‌‌ای نادرست باید بکار‌گرفته شود. (برای مثال، زمانی که یک APIیا یک فایل بارگذاری‌شده توسط کاربر یا هر منبع دیگری به‌طور مستقیم درخواست می‌شود).کنترل‌های ممکن می‌توانند شامل این موارد باشند: عدم پردازش محتوا مگر در صورت وجود هدرهای متناسب با درخواست‌های HTTP  (مانند ‎Sec-Fetch-*) به منظور اطمیان از صحیح بودن پردازش محتوا یا عملکرد مربوط به . استفاده از عبارت sandbox  در هدر Content-Security-Policy یا استفاده از نوعattachment  در هدر Content-Disposition . | 1     |
| **3.2.2** | اطمینان حاصل شود که محتوایی که برای نمایش به‌صورت متن طراحی شده نه برای پردازش به صورتHTML ،  با استفاده از توابع امن نظیر  CreateTextNode یا textContent به منظور جلوگیری از اجرای ناخواسته محتوایی مانند  HTML یا JavaScript پردازش ‌شود.                                                                                                                                                                                                                                                                                                                                                                       | 1     |
| **3.2.3** | برنامه هنگام استفاده از جاوااسکریپت سمت کاربر (Client-Side JavaScript)، با استفاده از اعلام متغیرها به‌صورت صریح، انجام بررسی نوع به‌صورت سخت‌گیرانه، اجتناب از ذخیره‌سازی متغیرهای سراسری بر روی شیء document، و پیاده‌سازی ایزولاسیون فضای نام (namespace isolation)، از وقوع DOM Clobbering  جلوگیری می‌کند.                                                                                                                                                                                                                                                                                                   | 3     |

## V3.3 پیکربندی کوکی (Cookie Setup)

این بخش الزامات مربوط به پیکربندی ایمن کوکی‌های حساس را تشریح می‌کند تا سطح بالاتری از اطمینان نسبت به این‌که آن‌ها توسط خود برنامه ایجاد شده‌اند فراهم شود و همچنین از نشت محتوای آن‌ها یا تغییر نامناسبشان جلوگیری گردد.

| #         | Description                                                                                                                                                                                                                                                                           | Level |
|:---------:|:------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |:-----:|
| **3.3.1** | اطمینان حاصل شود که کوکی‌ها دارای ویژگی  ‘Secure’ هستند. در صورتی که از پیشوند ‘__Host-’  برای نام کوکی استفاده نمی‌شود، باید پیشوند __Secure- در نام کوکی لحاظ شده باشد.                                                                                                             | 1     |
| **3.3.2** | اطمینان حاصل شود که مقدار ویژگی SameSite  برای هر کوکی، متناسب با هدف آن کوکی تنظیم شده باشد تا میزان آسیب‌پذیری در برابر حملات فریب سمت کلاینت نظیر CSRF  کاهش یابد.                                                                                                                 | 2     |
| **3.3.3** | اطمینان حاصل شود که کوکی‌ها از پیشوند __Host- در نام خود استفاده می‌کنند، مگر در مواردی که کوکی به‌طور مشخص برای اشتراک‌گذاری بین چند دامنه (Hosts) طراحی شده باشد.                                                                                                                   | 2     |
| **3.3.4** | اطمینان حاصل شود که اگر مقدار کوکی (مثلاً توکن نشست) نباید برای اسکریپت‌های سمت کلاینت در دسترس باشد، ویژگی  HttpOnly باید برای آن کوکی فعال شده باشد، و همچنین مقدار کوکی (مثلاً همان توکن نشست) تنها از طریق هدر  Set-Cookie به کلاینت ارسال شود.                                   | 2     |
| **3.3.5** | اطمینان حاصل شود که حداکثر مجموع نام و مقدار کوکی از ۴۰۹۶ بایت تجاوز نکند.کوکی‌هایی که بیش از این مقدار باشند توسط مرورگر ذخیره نخواهند شد، و بنابراین در درخواست‌ها ارسال نمی‌شوند؛ موضوعی که ممکن است باعث شود عملکردهایی از برنامه که به آن کوکی وابسته‌اند، غیرفعال یا مختل شوند. | 3     |

## V3.4 هدرهای مکانیزم‌های امنیتی مرورگر (Browser Security Mechanism Headers)

این بخش مشخص می‌کند که کدام هدرهای امنیتی باید در پاسخ‌های HTTP تنظیم شوند، تا هنگام پردازش پاسخ توسط مرورگر، ویژگی‌ها و محدودیت‌های امنیتی مرورگر فعال گردند.

| #         | Description                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | Level |
|:---------:|:---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |:-----:|
| **3.4.1** | اطمینان حاصل شود که در تمامی پاسخ‌های HTTP، هدر Strict-Transport-Security  وجود دارد تا سیاست HSTS (HTTP Strict Transport Security) اعمال شود. حداقل مقدار  max-age باید برابر با یک سال باشد. برای برنامه‌های سطح 2 (L2) و بالاتر، این سیاست باید برای تمام زیردامنه‌ها (subdomains)  نیز اعمال شود.                                                                                                                                                                                                                                                                                                                        | 1     |
| **3.4.2** | اطمینان حاصل شود که هدرAccess-Control-Allow-Origin  مربوط به (CORS)، دارای یک مقدار ثابت و مشخص توسط برنامه باشد یا اگر هدر Origin  در درخواست مورد استفاده قرار می گیرد  باید با فهرستی از مبدأهای مورد اعتماد (Allowlist) اعتبارسنجی شود. در صورتی که استفاده از مقدار *  در Access-Control-Allow-Origin  تنظیم شده باشد، اطمینان حاصل شود که هیچ اطلاعات حساسی در پاسخ قرار ندارد.                                                                                                                                                                                                                                        | 1     |
| **3.4.3** | اطمینان حاصل شود که تمامی پاسخ‌های HTTP شامل هدر Content-Security-Policy  باشند تا ریسک اجرای اسکریپت‌های مخرب (مانند (JavaScript مخرب کاهش یابد. دستورهای object-src 'none'  و  base-uri 'none'  الزامی هستند .برای برنامه‌های سطح 3 (L3)، باید سیاست CSP به‌صورت اختصاصی برای هر پاسخ(Per-response Policy)  و مبتنی بر  nonce یا hash تعریف شده باشد.                                                                                                                                                                                                                                                                      | 2     |
| **3.4.4** | اطمینان حاصل شود که تمامی پاسخ‌ها شامل هدر X-Content-Type-Options: nosniff  باشند، این (هدر) به مرورگرها دستور می‌دهد که برای پاسخ دریافتی از  Content Sniffing یا حدس‌زدن نوع محتوا  (MIME Type Guessing) استفاده نکنند و آن‌ها را ملزم می‌کند که نوع محتوای واقعی را دقیقاً مطابق مقدار هدر Content-Type در درخواست/پاسخ در نظر بگیرند.برای مثال، پاسخ به یک درخواست برای یک فایل استایل (CSS) تنها در صورتی پذیرفته می‌شود که مقدار Content-Type در پاسخ 'text/css' باشد.این کار همچنین امکان استفاده از قابلیت مسدودسازی خواندن منابع از مبدا متفاوت Cross-Origin Read Blocking  یا (CORB) توسط مرورگر را فراهم می‌سازد. | 2     |
| **3.4.5** | برنامه باید (وب‌سایت یا اپلیکیشن) یک "Referrer Policy" (سیاست ارجاع) تنظیم کرده باشد تا از نشت اطلاعات حساس از طریق هدر HTTP به نام Referer به سرویس‌های شخص ثالث جلوگیری شود. این کار را می‌توان از طریق هدر پاسخ HTTP به نام Referrer-Policy یا با استفاده از ویژگی‌هایی در عناصر HTML انجام داد.اطلاعات حساس ممکن است شامل مسیر (Path) و داده‌های کوئری (Query) در آدرس URL باشد، و در مورد برنامه‌های داخلی و غیرعمومی، حتی نام میزبان (hostname) نیز می‌تواند جزو اطلاعات حساس محسوب شود.                                                                                                                               | 2     |
| **3.4.6** | برنامه باید  از frame-ancestors در هدر Content-Security-Policy (CSP) برای تمام پاسخ‌های HTTP استفاده کند،تا به‌صورت پیش‌فرض، اجازه‌ی نمایش سایت در قالب iframe داده نشود، و فقط در صورت نیاز، نمایش منابع خاص (specific resources) در iframe مجاز باشد.به این نکته توجه کنید که هدر X-Frame-Options  با اینکه هنوز توسط برخی مرورگرها پشتیبانی می‌شود، اما قدیمی (obsolete) است و نباید به آن تکیه کرد.                                                                                                                                                                                                                      | 2     |
| **3.4.7** | هدر  Content-Security-Policy (CSP)  باید شامل یک آدرس برای گزارش (Report violation)  باشد.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   | 3     |
| **3.4.8** | تمام پاسخ‌های HTTP که باعث رندر (نمایش) یک سند می‌شوند مانند (پاسخ‌هایی با نوع محتوا (text/html باید شامل هدر Cross-Origin-Opener-Policy با دستور same-origin  یا same-origin-allow-popups باشند (بنا به نیاز). این کار از حملاتی جلوگیری می‌کند که از دسترسی مشترک به اشیای Window سوءاستفاده می‌کنند، مانند حملات tabnabbing و frame counting.                                                                                                                                                                                                                                                                             | 3     |

## V3.5 تفکیک مبدا توسط مرورگر (Browser Origin Separation)

وقتی یک درخواست برای انجام عملکرد حساس در سمت سرور پذیرفته می‌شود، برنامه باید اطمینان حاصل کند که این درخواست واقعاً از طرف خود برنامه یا یک منبع مورد اعتماد ارسال شده و توسط مهاجم جعل نشده است.

عملکرد حساس در این زمینه می‌تواند شامل مواردی مانند ارسال فرم‌ها برای کاربران تأییدشده یا تأییدنشده (مثلاً درخواست احراز هویت)، عملیات تغییر وضعیت (state-changing operations)، یا عملکردهایی که منابع زیادی مصرف می‌کنند (مانند خروجی گرفتن از داده‌ها) باشد.

مکانیزم‌های کلیدی برای محافظت در برابر چنین حملاتی شامل سیاست‌های امنیتی مرورگرها مانند Same Origin Policy برای جاوااسکریپت و همچنین منطق SameSite  برای کوکی‌ها هستند.
یکی دیگر از روش‌های رایج برای محافظت، مکانیزم CORS preflight  است. این مکانیزم به‌ویژه برای اندپوینت‌هایی که قرار است از یک مبدأ متفاوت فراخوانی شوند حیاتی است، اما حتی برای اندپوینت‌هایی که نباید از مبدأهای دیگر فراخوانی شوند نیز می‌تواند به‌عنوان یک لایه محافظتی مؤثر در برابر جعل درخواست Request Forgery عمل کند.

| #         | Description                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           | Level |
|:---------:|:------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |:-----:|
| **3.5.1** | برنامه باید از مکانیزم Preflight در CORS برای جلوگیری از درخواست‌های cross-origin به عملکردهای حساس استفاده نمی‌کند، این درخواست‌ها به‌گونه‌ای اعتبارسنجی شوند که فقط از مبدأ اصلی برنامه ارسال شده باشند. این اعتبارسنجی می‌تواند با استفاده از توکن‌های (anti- forgery tokens)   یا الزام به ارسال هدرهای HTTP اضافی انجام شود که در لیست هدرهای مجاز CORS (CORS-safelisted)  قرار ندارند. این اقدام برای محافظت در برابر حملات جعل درخواست از طریق مرورگر، که با نام CSRF (Cross-Site Request Forgery)  شناخته می‌شوند، ضروری است. | 1     |
| **3.5.2** | اگر برنامه برای جلوگیری از استفاده غیرمجاز cross-origin از عملکردهای حساس، به مکانیزم Preflight در CORS متکی است، باید امکان فراخوانی این عملکردها با درخواست‌هایی که باعث ایجاد Preflight نمی‌شوند، وجود نداشته باشد. برای تحقق این هدف ممکن است لازم باشد مقدار هدرهای Origin و Content-Type  بررسی شوند یا از هدر اضافی استفاده شود که در لیست هدرهای مجاز CORS  قرار ندارد.                                                                                                                                                       | 1     |
| **3.5.3** | برنامه باید درخواست‌های HTTP که به عملکردهای حساس از متدهای مناسب مانند POST، PUT، PATCH یا DELETE استفاده می‌کنند، و نه از متدهایی که در استاندارد HTTP به‌عنوان "ایمن" تعریف شده‌اند، مانند GET، HEAD  یا .OPTIONS  به عنوان جایگزین یا مکمل، می‌توان از بررسی سخت‌گیرانه هدرهای  Sec-Fetch-* استفاده کرد تا اطمینان حاصل شود که درخواست از منبع نامناسبی مثل بارگذاری تصویر، ناوبری صفحه یا فراخوانی cross-origin ارسال نشده است.                                                                                                  | 1     |
| **3.5.4** | برنامه‌های مجزا باید روی نام‌های دامنه (hostname) متفاوت میزبانی شده‌اند تا از محدودیت‌های ارائه‌شده توسط  (Same-Origin Policy) بهره‌مند شوند. این شامل کنترل تعامل اسناد یا اسکریپت‌های بارگذاری‌شده از یک مبدأ با منابع مبدأ دیگر و اعمال محدودیت بر اساس دامنه برای کوکی‌ها می‌شود.                                                                                                                                                                                                                                                | 2     |
| **3.5.5** | برنامه باید پیام‌های دریافت‌شده از طریق رابط postMessage  در صورتی که مبدأ پیام مورد اعتماد نباشد یا ساختار پیام نامعتبر باشد، نادیده گرفته می‌شوند.                                                                                                                                                                                                                                                                                                                                                                                  | 2     |
| **3.5.6** | هیچ‌کجای برنامه از قابلیت JSONP استفاده نشود تا از حملات Cross-Site Script Inclusion (XSSI) جلوگیری شود.                                                                                                                                                                                                                                                                                                                                                                                                                              | 3     |
| **3.5.7** | داده‌هایی که نیاز به احراز هویت دارند، در پاسخ‌های مربوط به منابع اسکریپتی(مانند فایل‌های (JavaScript  نباید قرار بگیرند تا از حملات XSSI جلوگیری شود.                                                                                                                                                                                                                                                                                                                                                                                | 3     |
| **3.5.8** | اطمینان حاصل کنید که منابع احراز هویت‌شده (مانند تصاویر، ویدیوها، اسکریپت‌ها و سایر اسناد) فقط در مواقعی که هدف آن است، قابل بارگذاری یا جاسازی توسط کاربر باشند. این کار را می‌توان با اعتبارسنجی دقیق هدرهای HTTP مانند Sec-Fetch-*  انجام داد تا اطمینان حاصل شود که درخواست از یک منبع غیرمجاز ارسال نشده است، یا با تنظیم هدر Cross-Origin-Resource-Policy  برای محدود کردن دسترسی مرورگر به محتوا.                                                                                                                              | 3     |

## V3.6 یکپارچگی منابع خارجی (External Resource Integrity)

این بخش، راهنمایی‌هایی برای میزبانی ایمن محتوا در سایت‌های شخص ثالث (Third-party) ارائه می‌دهد.

| #         | Description                                                                                                                                                                                                                                                                                                                                                                                                                                                   | Level |
|:---------:|:------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |:-----:|
| **3.6.1** | منابع سمت کلاینت مانند کتابخانه‌های جاوااسکریپت، فایل‌های CSS، یا فونت‌های وب، تنها در صورتی به‌صورت خارجی (مثلاً از طریق شبکه تحویل محتوا - CDN) میزبانی شوند که آن منابع: استاتیک (تغییرناپذیر) باشند، نسخه‌گذاری‌شده (versioned) باشند و یکپارچگی آن‌ها با استفاده از Subresource Integrity (SRI) بررسی شود. اگر این موارد امکان‌پذیر نیست، باید برای هر منبع، یک تصمیم امنیتی مستند وجود داشته باشد که توجیه کند چرا این منبع به این شکل بارگذاری می‌شود. | 3     |

## V3.7 سایر ملاحظات امنیتی مرورگر (Other Browser Security Considerations)

این بخش شامل مجموعه‌ای از کنترل‌های امنیتی و ویژگی‌های امنیتی مدرن مرورگر است که برای افزایش امنیت در سمت کلاینت (مرورگر کاربر) توصیه می‌شوند.

| #         | Description                                                                                                                                                                                                                                                                      | Level |
|:---------:|:-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |:-----:|
| **3.7.1** | برنامه صرفا باید از فناوری‌های سمت کلاینتی استفاده ‌کند که همچنان پشتیبانی می‌شوند و از نظر امنیتی قابل اعتماد هستند.مثال‌هایی از فناوری‌هایی که این الزام را برآورده نمی‌کنند عبارتند از  NSAPI Plugins،Flash،Shockwave،ActiveX،Silverlight،NACL و Appletهای جاوا در سمت کلاینت | 2     |
| **3.7.2** | 2-    برنامه فقط زمانی کاربر را به دامنه‌ها یا hostnameهای دیگر (که تحت کنترل برنامه نیستند) به صورت خودکار هدایت می‌کند، که آن مقصد در یک فهرست مجاز (allowlist) قرار داشته باشد.                                                                                               | 2     |
| **3.7.3** | 3-    برنامه باید هنگام ریدایرکت کاربر به یک URL که خارج از کنترل برنامه است، یک پیام هشدار نشان می‌دهد و امکان لغو آن را به کاربر می‌دهد.                                                                                                                                       | 3     |
| **3.7.4** | 4-    باید دامنه اصلی برنامه،  مثلاً (site.tld) به فهرست preload  عمومی HSTS اضافه شده باشد. این کار اطمینان می‌دهد که استفاده از TLS برای برنامه، به‌صورت پیش‌فرض در مرورگرهای اصلی تعبیه شده است و صرفاً به هدر پاسخ Strict-Transport-Security وابسته نیست.                    | 3     |
| **3.7.5** | Verify that the application behaves as documented (such as warning the user or blocking access) if the browser used to access the application does not support the expected security features.                                                                                   | 3     |

## References

برای اطلاعات بیشتر، همچنین به منابع زیر مراجعه کنید:

* [Set-Cookie __Host- prefix details](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Set-Cookie#cookie_prefixes)
* [OWASP Content Security Policy Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/Content_Security_Policy_Cheat_Sheet.html)
* [OWASP Secure Headers Project](https://owasp.org/www-project-secure-headers/)
* [OWASP Cross-Site Request Forgery Prevention Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/Cross-Site_Request_Forgery_Prevention_Cheat_Sheet.html)
* [HSTS Browser Preload List submission form](https://hstspreload.org/)
* [OWASP DOM Clobbering Prevention Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/DOM_Clobbering_Prevention_Cheat_Sheet.html)

# V2 Validation and Business Logic

## هدف

یک برنامه مورد تائید باید الزامات سطح بالا را به شرح زیر برآورده سازد:

* داده‌های دریافتی برنامه با الزامات تجاری یا عملکردی مطابقت داشته باشد.
* منطق تجاری (Business Logic) دارای جریان ترتیبی بوده، به‌صورت گام‌به‌گام پردازش ‌شود و قابل دور زدن نباشد.
* منطق تجاری شامل محدودیت‌ها و کنترل‌هایی برای شناسایی و جلوگیری از حملات خودکار است؛ مانند انتقال‌های مکرر با مبالغ کم یا اضافه‌کردن میلیون‌ها دوست به‌صورت تک‌تک.
* در طراحی و پیاده‌سازی جریان‌های منطق تجاری با ارزش بالا، سناریوهای سوءاستفاده و کاربران مخرب در نظر گرفته‌ شود و تدابیری نظیر محافظت در برابر جعل هویت (Spoofing)، دستکاری (Tampering)، افشای اطلاعات و ارتقای سطح دسترسی (Privilege Escalation) اتخاذ شده باشد.

## V2.1 مستندات اعتبارسنجی و منطق کسب‌وکار ( Validation and Business Logic Documentation)

مستندات اعتبارسنجی و منطق تجاری باید به‌روشنی محدودیت‌های منطق کسب و کار، قوانین اعتبارسنجی و سازگاری مناسب بین داده‌‌های ترکیب شده (از نظر مفهومی و متنی) را تعریف کنند، تا مشخص باشد چه مواردی باید در برنامه پیاده‌سازی شوند.

| #         | Description                                                                                                                                                                                                                                                         | Level |
|:---------:|:------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |:-----:|
| **2.1.1** | قوانین اعتبارسنجی ورودی‌های برنامه (مندرج در مستندات برنامه)  ‌باید چگونگی بررسی صحت داده‌ها را مطابق با ساختار مورد انتظار مشخص نماید. این ساختار می‌تواند شامل فرمت‌های رایج داده مانند شماره کارت اعتباری، آدرس ایمیل، شماره تلفن یا یک قالب داده‌ای داخلی باشد. | 1     |
| **2.1.2** | قوانین اعتبارسنجی ورودی‌های برنامه (مندرج در مستندات برنامه) باید چگونگی بررسی سازگاری مناسب بین داده‌‌های ترکیب شده (از نظر مفهومی و متنی) را مشخص نماید؛ مانند تطبیق کدپستی با نام محله.                                                                          | 2     |
| **2.1.3** | انتظارات مربوط به محدودیت‌ها و اعتبارسنجی‌های منطق کسب و کار مستند شده باشند؛ این مستندات باید شامل محدودیت‌ها در سطح هر کاربر و محدودیت‌های عمومی در سطح برنامه باشند.                                                                                             | 2     |

## V2.2 اعتبارسنجی ورودی (Input Validation)

کنترل‌های مؤثر در اعتبارسنجی ورودی، انتظارات کسب و کار یا عملکردی مرتبط با نوع داده‌ای که برنامه باید دریافت کند را اعمال می‌کنند. این کار منجر به کیفیت بهتر داده‌ها و کاهش دامنه حمله (Attack Surface) می‌شود. با این حال، اعتبارسنجی ورودی جایگزین استفاده از encoding ، پارامتری‌سازی یا پاک‌سازی داده‌ها هنگام استفاده از داده در سایر بخش‌های برنامه یا هنگام نمایش درخروجی نمی‌باشد.

در این زمینه، «ورودی» می‌تواند از منابع متنوعی دریافت شود، از جمله: فیلدهای فرم HTML، درخواست‌های REST، پارامترهای URL، فیلدهای هدر HTTP،کوکی‌ها، فایل‌های ذخیره‌شده در دیسک، پایگاه‌های داده، APIهای خارجی.

یک کنترل منطق کسب و کاری ممکن است بررسی کند که مقدار ورودی، عددی کمتر از 100 است.یک انتظار عملکردی ممکن است بررسی کند که یک عدد (که تعیین می‌کند یک حلقه چند بار اجرا شود تا پردازش بیش از حد و در نتیجه وضعیت انکار سرویس(DoS)  اتفاق نیافتد)  از یک آستانه‌ی خاص کمتر باشد.

با اینکه اعتبارسنجی بر پایه  Schema  الزام صریح ندارد، ولی این روش می‌تواند مؤثرترین راهکار برای پوشش کامل اعتبارسنجی در APIهای HTTP یا سایر واسط‌هایی که از JSON یا XML استفاده می‌کنند باشد.

نکات مهم درباره اعتبارسنجی بر اساس Schema:

* "نسخه منتشرشده" از مشخصات JSON Schema Validation، برای استفاده در محیط تولید مناسب تلقی می‌شود، نه لزوما پایدار(Stable). هنگام استفاده از این نوع اعتبارسنجی، باید اطمینان حاصل شود که هیچ مغایرتی با الزامات زیر وجود ندارد.

| #                                                                                                                      | Description                                                                                                                                                                                                                                                             | Level |
|:----------------------------------------------------------------------------------------------------------------------:|:----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |:-----:|
| **2.2.1**                                                                                                              | ورودی‌ها باید به‌منظور اعمال انتظارات کسب و کار یا عملکردی مرتبط با آن‌ها اعتبارسنجی ‌شوند.این اعتبارسنجی باید یکی از دو روش زیر را داشته باشد:                                                                                                                         |       |
| <br/>•    استفاده از اعتبارسنجی مثبت (Positive Validation) مبتنی بر فهرست مجاز از مقادیر، الگوها یا بازه‌های قابل قبول |                                                                                                                                                                                                                                                                         |       |
| <br/>•    تطبیق با ساختار مورد انتظار و محدودیت‌های منطقی، بر اساس قوانین از پیش تعریف‌شده.                            |                                                                                                                                                                                                                                                                         |       |
| <br/>برای سطح 1 (L1)، تمرکز می‌تواند بر ورودی‌هایی باشد که در تصمیم‌گیری‌های خاص تجاری یا امنیتی استفاده می‌شوند.      |                                                                                                                                                                                                                                                                         |       |
| <br/>برای سطح 2 و بالاتر، این اعتبارسنجی باید شامل تمام ورودی‌ها باشد.                                                 | 1                                                                                                                                                                                                                                                                       |       |
| **2.2.2**                                                                                                              | برنامه به‌گونه‌ای طراحی شود که اعتبارسنجی ورودی را در لایه‌ قابل اعتمادی از سرویس (Trusted Service Layer)  اعمال کند. هرچند اعتبارسنجی سمت کلاینت (Client-side Validation) باعث بهبود تجربه کاربری می‌شود و توصیه می‌گردد، اما نباید به‌عنوان یک کنترل امنیتی اتکا شود. | 1     |
| **2.2.3**                                                                                                              | برنامه باید اطمینان حاصل نماید که ترکیب داده‌های مربوطه با توجه به قوانین از پیش تعریف‌شده معقول و منطقی باشد.                                                                                                                                                          | 2     |

## V2.3 امنیت منطق کسب‌وکار (Business Logic Security)

این بخش به الزامات کلیدی می‌پردازد که هدف آن‌ها اطمینان از پیاده سازی صحیح منطق کسب و کاری برنامه است و برنامه در برابر حملات مربوط به کسب و کار، مصون است.

| #         | Description                                                                                                                                                                                                                                                                                                                               | Level |
|:---------:|:----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |:-----:|
| **2.3.1** | اطمینان حاصل شود که برنامه فقط جریان‌های منطق تجاری را برای همان کاربر و طبق ترتیب گام‌به‌گام از پیش تعیین شده و مورد انتظار پردازش می‌کند و امکان رد کردن مراحل (Skipping Steps) وجود ندارد.                                                                                                                                             | 1     |
| **2.3.2** | اطمینان حاصل شود که محدودیت‌های منطق تجاری مطابق با مستندات برنامه پیاده‌سازی شده‌اند، تا از سوء‌استفاده از نقص‌های منطقی جلوگیری شود.                                                                                                                                                                                                    | 2     |
| **2.3.3** | تراکنش‌های سطح منطق کسب‌وکار (business logic) باید به‌گونه‌ای استفاده شوند که یا یک عملیات منطق کسب‌وکار به‌طور کامل با موفقیت انجام شود، یا در صورت بروز خطا، به حالت صحیح قبلی بازگردد(rollback) شود.                                                                                                                                   | 2     |
| **2.3.4** | در منطق کسب‌وکار (business logic)باید از مکانیزم‌های قفل‌گذاری (locking) استفاده شده باشد تا اطمینان حاصل شود که منابع محدود (مانند صندلی‌های سینما یا بازه‌های زمانی تحویل)، قابل رزرو دوباره (double-booked) از طریق دستکاری منطق برنامه نباشند.                                                                                        | 2     |
| **2.3.5** | اطمینان حاصل شود که جریان‌های منطق کسب و کاری با ارزش بالا نیازمند تایید چند کاربره (Multi-user Approval) هستند تا از اقدامات غیرمجاز یا تصادفی جلوگیری شود. این موارد می‌تواند شامل – اما نه محدود به – انتقال‌های مالی بزرگ، تایید قرارداد‌ها، دسترسی به اطلاعات طبقه‌بنده شده، یا غیرفعال‌سازی‌های ایمنی در محیط‌های تولید صنعتی باشد. | 3     |

## V2.4 مقابله با خودکارسازی (Anti-automation)

This section includes anti-automation controls to ensure that human-like interactions are required and excessive automated requests are prevented.

| #         | Description                                                                                                                                                                                                                                                                                                                                                               | Level |
|:---------:|:------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |:-----:|
| **2.4.1** | کنترل‌های ضد خودکارسازی (Anti-Automation) در سیستم پیاده‌سازی شده باشند تا از سوءاستفاده‌هایی مانند فراخوانی بیش از حد توابع برنامه جلوگیری شود؛ چرا که این نوع حملات می‌توانند منجر به استخراج غیرمجاز داده‌ها، تولید داده‌های زائد، مصرف کامل سهمیه‌ها، عبور از محدودیت‌های نرخ (Rate Limit)، ایجاد اختلال در سرویس (DoS) یا استفاده بیش از حد از منابع گران‌قیمت شوند. | 2     |
| **2.4.2** | بررسی کنید که جریان‌های منطق کسب‌وکار (Business Logic Flows) به گونه‌ای طراحی شده باشند که نیازمند زمان‌بندی واقعی انسان باشند، و از ارسال سریع و غیرطبیعی تراکنش‌ها (Transaction Submissions) جلوگیری کنند.                                                                                                                                                              | 3     |

## References

برای اطلاعات بیشتر، همچنین به منابع زیر مراجعه کنید:

* [OWASP Web Security Testing Guide: Input Validation Testing](https://owasp.org/www-project-web-security-testing-guide/v42/4-Web_Application_Security_Testing/07-Input_Validation_Testing/README.html)
* [OWASP Web Security Testing Guide: Business Logic Testing](https://owasp.org/www-project-web-security-testing-guide/v42/4-Web_Application_Security_Testing/10-Business_Logic_Testing/README)
* جلوگیری از خودکارسازی (Anti-automation) را می‌توان به روش‌های مختلفی انجام داد، از جمله با استفاده از [OWASP Automated Threats to Web Applications](https://owasp.org/www-project-automated-threats-to-web-applications/)
* [OWASP Input Validation Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/Input_Validation_Cheat_Sheet.html)
* [JSON Schema](https://json-schema.org/specification.html)

# V5 파일 처리

## 제어 목표

파일을 사용하는 것은 서비스 거부, 무단 접근 및 저장 공간 고갈을 포함하여 애플리케이션에 다양한 위험을 초래할 수 있다. 이 장은 이러한 위험을 해결하기 위한 요구사항을 포함한다.

## V5.1 파일 처리 문서화

이 섹션은 관련 보안 검사를 개발하고 검증하기 위한 필수 전제 조건으로 애플리케이션이 허용하는 파일의 예상 특성을 문서화하는 요구사항을 포함한다.

| # | Description | Level |
| :---: | :--- | :---: |
| **5.1.1** | 업로드 기능별로 허용되는 파일 형식, 예상되는 파일 확장자, 그리고 최대 크기(압축 해제된 크기 포함)가 문서에 정의되어 있는지 검증해야 한다. 또한, 악성 파일이 탐지될 때 애플리케이션이 어떻게 동작하는지와 같이, 최종 사용자가 파일을 안전하게 다운로드하고 처리할 수 있도록 하는 방법이 문서에 명시되어 있는지 확인해야 한다. | 2 |

## V5.2 파일 업로드 및 콘텐츠

파일 업로드 기능은 신뢰할 수 없는 파일의 주요 소스이다. 이 섹션은 이러한 파일의 존재, 볼륨 또는 내용이 애플리케이션에 해를 끼치지 않도록 보장하기 위한 요구사항을 설명한다.

| # | Description | Level |
| :---: | :--- | :---: |
| **5.2.1** | 애플리케이션이 성능 저하나 서비스 거부 공격(Denial of Service; DoS)을 유발하지 않고 처리할 수 있는 크기의 파일만 허용하는지 검증해야 한다. | 1 |
| **5.2.2** | 애플리케이션이 파일 자체 또는 zip 파일과 같은 아카이브 내에서 파일을 허용할 때, 파일 확장자가 예상 파일 확장자와 일치하는지 확인하고 내용이 확장자로 표현된 유형과 일치하는지 확인하는지 검증해야 한다. 여기에는 초기 '매직 바이트(magic bytes)' 확인, 이미지 재작성 수행, 파일 내용 유효성 검사를 위한 전문 라이브러리 사용이 포함되지만 이에 국한되지 않는다. L1의 경우, 특정 비즈니스 또는 보안 결정을 내리는 데 사용되는 파일에만 집중할 수 있다. L2 이상에서는 허용되는 모든 파일에 적용되어야 한다 | 1 |
| **5.2.3** | 애플리케이션이 압축 파일(예: zip, gz, docx, odt)을 압축 해제하기 전에 허용되는 최대 압축 해제 크기와 최대 파일 수를 확인하는지 검증해야 한다. | 2 |
| **5.2.4** | 단일 사용자가 너무 많은 파일이나 과도하게 큰 파일로 저장 공간을 채우지 않도록 사용자별 파일 크기 할당량(quota) 및 최대 파일 수가 적용되는지 검증해야 한다. | 3 |
| **5.2.5** | 애플리케이션이 심볼릭 링크(symlink)를 포함하는 압축 파일 업로드를 허용하지 않는지 검증해야 한다. 단, 이러한 기능이 특별히 요구되는 경우에는 심볼릭 링크할 수 있는 파일의 허용 목록(allowlist)을 강제하는 것이 필요히다. | 3 |
| **5.2.6** | 픽셀 플러드 공격(Pixel Flood Attack)을 방지하기 위해, 애플리케이션이 업로드된 이미지의 픽셀 크기가 허용된 최대값보다 큰 경우 해당 이미지를 거부하는지 검증해야 한다. | 3 |

## V5.3 파일 저장

이 섹션은 업로드 후 파일이 부적절하게 실행되는 것을 방지하고, 위험한 콘텐츠를 탐지하며, 신뢰할 수 없는 데이터가 파일 저장 위치를 제어하는 데 사용되지 않도록 하기 위한 요구사항을 포함한다.

| # | Description | Level |
| :---: | :--- | :---: |
| **5.3.1** | 신뢰할 수 없는 입력으로 업로드되거나 생성되어 공개 폴더에 저장된 파일이 HTTP 요청으로 직접 접근될 때 서버 측 프로그램 코드로 실행되지 않는지 검증해야 한다. | 1 |
| **5.3.2** | 애플리케이션이 파일 작업을 위한 파일 경로를 생성할 때, 사용자 제출 파일명 대신 내부적으로 생성되거나 신뢰할 수 있는 데이터를 사용하는지 검증해야 한다. 만약 사용자 제출 파일명 또는 파일 메타데이터를 반드시 사용해야 한다면, 경로 탐색(path traversal), 로컬 또는 원격 파일 포함(LFI, RFI), 그리고 서버 측 요청 위조SSRF) 공격으로부터 보호하기 위해 엄격한 유효성 검사 및 정제(Sanitization)가 적용되는지 확인해야 한다. {{#원문 문장 구조를 유지한 직역 시 어색하여 일부 의역함, Sanitization의 적절한 번역은 상황에 따라 다르게 해석될 수 있다. 해당 챕터에서는 입력값 검증에 준하는 의미이므로 '정제'라고 번역함}} | 1 |
| **5.3.3** | 파일 압축 해제와 같은 서버 측 파일 처리가 zip slip과 같은 취약점을 방지하기 위해 사용자 제공 경로 정보를 무시하는지 검증해야 한다. | 3 |

## V5.4 파일 다운로드

이 섹션은 경로 탐색 및 삽입 공격을 포함하여 파일을 다운로드할 때 위험을 완화하기 위한 요구사항을 포함한다. 또한 위험한 콘텐츠를 포함하지 않도록 하는 것도 포함된다.

| # | Description | Level |
| :---: | :--- | :---: |
| **5.4.1** | 애플리케이션이 JSON, JSONP 또는 URL 파라미터를 포함한 사용자 제출 파일명을 검증하거나 무시하는지 검증해야 하고, 응답의 Content-Disposition 헤더 필드에 파일명을 명시하는지 검증해야 한다. {{#직역 시 2개 문장이 하나의 동사에 영향을 미쳐 가독성에 문제가 있어 두 문장을 and로 구성하도록 의역함}} | 2 |
| **5.4.2** | 제공되는 파일 이름(예: HTTP 응답 헤더 필드 또는 이메일 첨부 파일)이 문서 구조를 보존하고 삽입 공격(Injection Attack)을 방지하기 위해 인코딩되거나 정제(Sanitization)되는지 검증해야 한다. (예: RFC 6266 준수) {{#Sanitization의 적절한 번역은 상황에 따라 다르게 해석될 수 있다. 해당 챕터에서는 입력값 검증에 준하는 의미이므로 '정제'라고 번역함}}| 2 |
| **5.4.3** | 신뢰할 수 없는 소스에서 얻은 파일이 알려진 악성 콘텐츠 제공을 방지하기 위해 안티바이러스 스캐너에 의해 검사되는지 검증해야 한다. | 2 |

## References
## 참조

For more information, see also:
더 많은 정보는 다음을 참조한다:

* [OWASP File Upload Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/File_Upload_Cheat_Sheet.html)
* [Example of using symlinks for arbitrary file read](https://hackerone.com/reports/1439593)
* [Explanation of "Magic Bytes" from Wikipedia](https://en.wikipedia.org/wiki/List_of_file_signatures)

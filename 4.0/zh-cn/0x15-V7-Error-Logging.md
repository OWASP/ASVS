# V7 错误处理和日志记录

## 控制目标

错误处理和记录的主要目标，是为用户、管理员和事件响应团队提供有用的信息。目标不是创建大量日志，而是创建高质量的日志，信息多于丢弃的噪声。

高质量的日志往往包含敏感数据，必须按照当地的数据隐私法或指令进行保护。这应该包括：

* 除非特别要求，否则不收集或记录敏感信息。
* 确保所有记录的信息被安全地处理，并根据其数据分类进行保护。
* 确保日志不会被永久存储，而是有一个尽可能短的生命周期。

如果日志包含私人或敏感数据（各国对这些数据的定义各不相同），则日志将成为应用程序所持有的最敏感信息之一，因此对攻击者本身来说非常有吸引力。

同样重要的是，要确保应用程序安全地故障，而且错误不会泄露不必要的信息。

## V7.1 日志内容

记录敏感信息是很危险的——日志本身就成了机密，这意味着它们需要被加密，成为保留政策的对象，并且必须在安全审计中被披露。确保只有必要的信息被保存在日志中，当然没有支付、凭证（包括会话令牌）、敏感或个人身份信息。

V7.1 涵盖了 OWASP Top 10 2017:A10. 由于 2017:A10 和本节不可通过渗透测试来验证，重要的是：

* 开发人员要确保完全遵守本节，就像所有项目都被标记为L1一样。
* 渗透测试人员通过访谈，屏幕截图或断言来验证 V7.1 中所有项目的完全合规性。

| # | 描述 | L1 | L2 | L3 | CWE |
| :---: | :--- | :---: | :---: | :---: | :---: |
| **7.1.1** | 验证应用程序不记录凭证或支付细节。会话令牌应该只以不可逆的散列形式存储在日志中。 ([C9, C10](https://owasp.org/www-project-proactive-controls/#div-numbering)) | ✓ | ✓ | ✓ | 532 |
| **7.1.2** | 验证应用程序不会记录当地隐私法或相关安全政策规定的其他敏感数据。 ([C9](https://owasp.org/www-project-proactive-controls/#div-numbering)) | ✓ | ✓ | ✓ | 532 |
| **7.1.3** | 验证应用程序是否记录安全相关事件，例如成功和失败的认证事件、访问控制失败、反序列化失败和输入验证失败的事件。 ([C5, C7](https://owasp.org/www-project-proactive-controls/#div-numbering)) | | ✓ | ✓ | 778 |
| **7.1.4** | 验证每个日志事件都包含必要的信息，以便在事件发生后详细调查时间轴。 ([C9](https://owasp.org/www-project-proactive-controls/#div-numbering)) | | ✓ | ✓ | 778 |

## V7.2 日志处理

及时的日志记录对于事件的审计、研判和升级是至关重要的。确保应用程序的日志是清晰的，可以很容易地在本地监测和分析，或将日志发送到远程监控系统。

V7.2 涵盖了 OWASP Top 10 2017:A10. 由于 2017:A10 和本节不可通过渗透测试来验证，重要的是：

* 开发人员要确保完全遵守本节，就像所有项目都被标记为L1一样。
* 渗透测试人员通过访谈，屏幕截图或断言来验证 V7.2 中所有项目的完全合规性。

| # | 描述 | L1 | L2 | L3 | CWE |
| :---: | :--- | :---: | :---: | :---: | :---: |
| **7.2.1** | 验证所有的认证决策都被记录下来，不存储敏感的会话令牌或密码。这应该包括安全调查所需的具有相关元数据的请求。 | | ✓ | ✓ | 778 |
| **7.2.2** | 验证是否可以记录所有访问控制决策并记录所有失败的决策。这应包括安全调查所需的具有相关元数据的请求。 | | ✓ | ✓ | 285 |

## V7.3 日志保护

可以轻易修改或删除的日志，对于调查和起诉毫无用处。日志的披露可能会暴露有关应用程序或其包含的数据的内部细节。在保护日志免遭未经授权的披露、修改或删除时，必须小心谨慎。

| # | 描述 | L1 | L2 | L3 | CWE |
| :---: | :--- | :---: | :---: | :---: | :---: |
| **7.3.1** | 验证所有日志组件是否对数据进行了适当的编码，以防止日志注入。 ([C9](https://owasp.org/www-project-proactive-controls/#div-numbering)) | | ✓ | ✓ | 117 |
| **7.3.2** | [已删除，与 7.3.1 重复] | | | | |
| **7.3.3** | 验证安全日志是否受到保护，防止未授权的访问或修改。 ([C9](https://owasp.org/www-project-proactive-controls/#div-numbering)) | | ✓ | ✓ | 200 |
| **7.3.4** | 验证时间源是否同步到正确的时间和时区。如果系统是全球性的，强烈考虑只用UTC来记录，以协助事件后的取证分析。 ([C9](https://owasp.org/www-project-proactive-controls/#div-numbering)) | | ✓ | ✓ | |

注意：日志编码（7.3.1）很难使用自动化工具和渗透测试进行测试和审查，但架构师、开发人员和源代码审查人员应将其视为 L1 要求。


## V7.4 错误处理

错误处理的目的，是允许应用程序提供与安全有关的事件，用于监控、研判和升级。目的不是为了创建日志。当记录安全相关的事件时，要确保日志有其目的，并且可以被SIEM或分析软件识别。

| # | 描述 | L1 | L2 | L3 | CWE |
| :---: | :--- | :---: | :---: | :---: | :---: |
| **7.4.1** | 验证在发生意外或安全敏感错误时，是否显示通用信息，可能带有支持人员可以用于调查的唯一ID。 ([C10](https://owasp.org/www-project-proactive-controls/#div-numbering)) | ✓ | ✓ | ✓ | 210 |
| **7.4.2** | 验证整个代码库是否使用了异常处理（或类似功能），以说明预期和非预期的错误情况。 ([C10](https://owasp.org/www-project-proactive-controls/#div-numbering)) | | ✓ | ✓ | 544 |
| **7.4.3** | 验证是否定义了“最后手段”的错误处理程序，以捕获所有未处理的异常。 ([C10](https://owasp.org/www-project-proactive-controls/#div-numbering)) | | ✓ | ✓ | 431 |

注意：某些语言，例如 Swift 和 Go ——以及通过常见的设计实践——许多函数式语言，不支持异常或最后的事件处理程序。在这种情况下，架构师和开发人员应该使用一种模式、语言或框架友好的方式，来确保应用程序能够安全地处理异常、意外或安全相关的事件。

## 参考文献

有关更多信息，请参阅：

* [OWASP Testing Guide 4.0 content: Testing for Error Handling](https://owasp.org/www-project-web-security-testing-guide/v41/4-Web_Application_Security_Testing/08-Testing_for_Error_Handling/README.html)
* [OWASP Authentication Cheat Sheet section about error messages](https://cheatsheetseries.owasp.org/cheatsheets/Authentication_Cheat_Sheet.html#authentication-and-error-messages)

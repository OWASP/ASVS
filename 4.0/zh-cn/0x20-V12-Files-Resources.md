# V12 文件和资源

## 控制目标

确保经过验证的应用程序满足以下高级要求：

* 不受信任的文件数据应以安全的方式进行相应处理。
* 从不可信任的来源获得的不可信任的文件数据被存储在Web目录之外，并具有有限的权限。

## V12.1 文件上传

尽管zip炸弹很容易使用渗透测试技术进行测试，但它们被认为是L2及以上级别，以鼓励设计和开发时考虑仔细的人工测试，并避免对拒绝服务场景进行自动化或不熟练的手动渗透测试。

| # | 描述 | L1 | L2 | L3 | CWE |
| :---: | :--- | :---: | :---:| :---: | :---: |
| **12.1.1** | 确认应用程序不会接受可能会填满存储空间或导致拒绝服务的大文件。 | ✓ | ✓ | ✓ | 400 |
| **12.1.2** | 验证应用程序在解压缩文件前，根据允许的最大解压缩尺寸和最大文件数检查压缩文件（如zip，gz，docx，odt）。 | | ✓ | ✓ | 409 |
| **12.1.3** | 验证文件大小配额和每个用户的最大文件数是否被强制执行，以确保单个用户不能用过多的文件或过大的文件填满存储。 | | ✓ | ✓ | 770 |

## V12.2 文件完整性

| # | 描述 | L1 | L2 | L3 | CWE |
| :---: | :--- | :---: | :---:| :---: | :---: |
| **12.2.1** | 验证从不可信任的来源获得的文件，根据文件的内容，验证其是否为预期类型。 | | ✓ | ✓ | 434 |

## V12.3 文件执行

| # | 描述 | L1 | L2 | L3 | CWE |
| :---: | :--- | :---: | :---:| :---: | :---: |
| **12.3.1** | 验证系统或框架文件系统不直接使用用户提交的文件名元数据，并且使用 URL API 来防止路径遍历。 | ✓ | ✓ | ✓ | 22 |
| **12.3.2** | 验证用户提交的文件名元数据是否经过验证或忽略，以防止通过本地文件包含（LFI） 泄露、创建、更新或删除本地文件。 | ✓ | ✓ | ✓ | 73 |
| **12.3.3** | 验证用户提交的文件名元数据是否经过验证或忽略，以防止通过远程文件包含（Remote File Inclusion，RFI）或服务器端请求伪造攻击（server - Server Side Request Forgery，SSRF）泄露或执行远程文件。 | ✓ | ✓ | ✓ | 98 |
| **12.3.4** | 验证应用程序通过验证或忽略用户提交的JSON、JSONP或URL参数中的文件名来防止反射文件下载（RFD），响应的Content-Type头应该设置为 text/plain，而Content-Disposition头应该有一个固定的文件名。 | ✓ | ✓ | ✓ | 641 |
| **12.3.5** | 验证未受信任的文件元数据不直接用于系统API或库，以防止操作系统命令注入。 | ✓ | ✓ | ✓ | 78 |
| **12.3.6** | 验证应用程序不包含或执行不可信任来源的功能，如未经验证的内容分发网络、JavaScript 库、node npm 库或服务器端 DLL。 | | ✓ | ✓ | 829 |

## V12.4 文件存储

| # | 描述 | L1 | L2 | L3 | CWE |
| :---: | :--- | :---: | :---:| :---: | :---: |
| **12.4.1** | 验证从不受信任的来源获得的文件是否存储在 Web 根目录之外，并具有有限的权限。 | ✓ | ✓ | ✓ | 552 |
| **12.4.2** | 验证从不受信任的来源获得的文件是否已被防病毒扫描程序扫描，以防止上传和提供已知的恶意内容。 | ✓ | ✓ | ✓ | 509 |

## V12.5 文件下载

| # | 描述 | L1 | L2 | L3 | CWE |
| :---: | :--- | :---: | :---:| :---: | :---: |
| **12.5.1** | 验证网络层是否被配置为只提供具有特定文件扩展名的文件，以防止意外信息和源代码泄漏。例如，除非有需要，应阻止提供备份文件（如.bak）、临时工作文件（如.swp）、压缩文件（.zip、.tar.gz等）以及其他编辑人员常用的扩展名。 | ✓ | ✓ | ✓ | 552 |
| **12.5.2** | 验证对上传文件的直接请求永远不会作为 HTML/JavaScript 内容执行。 | ✓ | ✓ | ✓ | 434 |

## V12.6 SSRF保护

| # | 说明 | L1 | L2 | L3 | CWE |
| :---: | :--- | :---: | :---:| :---: | :---: |
| **12.6.1** | 验证 Web 或应用程序服务器是否配置了资源或系统的白名单列表，服务器可以向其发送请求或加载数据/文件。 | ✓ | ✓ | ✓ | 918 |

## 参考文献

有关更多信息，请参阅：

* [File Extension Handling for Sensitive Information](https://owasp.org/www-community/vulnerabilities/Unrestricted_File_Upload)
* [Reflective file download by Oren Hafif](https://www.trustwave.com/Resources/SpiderLabs-Blog/Reflected-File-Download---A-New-Web-Attack-Vector/)
* [OWASP Third Party JavaScript Management Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/Third_Party_Javascript_Management_Cheat_Sheet.html)

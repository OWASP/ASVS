# V1 架构、设计和威胁建模

## 控制目标

在许多组织中，安全架构几乎已成为一门失传的艺术。 在DevSecOps时代，企业架构师的日子已经过去。应用安全领域必须迎头赶上，采用敏捷安全原则，同时将领先的安全架构原则重新介绍给软件从业者。 A架构不是一种实施，而是一种思考问题的方式，它可能有许多不同的答案，而没有一个单一的“正确”答案。 很多时候，安全被视为不灵活的，要求开发人员以特定方式修复代码，而开发人员可能知道解决问题的更好方法。 对于架构来说，没有单一的、简单的解决方案，尝试寻找这种方案，是对软件工程领域的一种损害。

一个Web应用程序的具体实现，很可能在其生命周期中不断被修改，但整体架构可能很少改变，而是缓慢发展。 安全架构也是一样的，身份验证——我们今天需要、明天需要、五年后也需要。 如果我们今天做出合理的决定，选择和复用符合架构的解决方案，那么就可以节省大量的精力、时间和金钱。 例如，十年前，多因素认证很少被实施。

如果开发人员已经在单一的“安全标识提供程序模型”上有所投入（例如SAML联邦认证），身份提供者可以更新以纳入新的要求（例如NIST 800-63标准），同时不改变原始应用程序的接口。 如果许多应用程序共享相同的安全架构和组件，那么它们都将同时从这次升级中受益。 然而，SAML 并不总是最好或最合适的身份验证解决方案——随着需求的变化，可能需要替换为其他解决方案。 像这样的更改要么很复杂，成本高到需要完全重写，要么在没有安全架构的情况下完全不可能。

在本章中，ASVS涵盖了任何良好安全架构的主要方面：可用性、保密性、完整性、不可抵赖性和隐私。 这些安全原则中的每一条，都必须适用并内置于所有应用程序中。 “左移”至关重要，从安全编码Checklists、指导和培训、编码和测试、构建、部署、配置和操作开始，到后续的独立测试，确保所有安全控制存在且功能正常。 这最后一步，曾经是我们作为一个行业所做的一切，但当开发人员每天数十次或数百次地推送代码时，就已经不够了。 应用安全专业人员必须跟上敏捷技术的步伐，这意味着要适应开发人员的工具，学习编码，并与开发人员一起工作，而不是在其他人离开的几个月后再批评项目。

## V1.1 安全软件开发生命周期

| # | 说明 | L1 | L2 | L3 | CWE |
| :---: | :--- | :---: | :---: | :---: | :---: |
| **1.1.1** | 验证使用安全的软件开发生命周期，在开发的各个阶段解决安全问题。 ([C1](https://owasp.org/www-project-proactive-controls/#div-numbering)) | | ✓ | ✓ | |
| **1.1.2** | 验证在每次设计变更或sprint计划中使用威胁建模，以识别威胁、计划对策、促进适当的风险响应，并指导安全测试。 | | ✓ | ✓ | 1053 |
| **1.1.3** | 验证所有用户信息和功能是否包含功能安全约束，例如 “作为一个用户，我应该能够查看和编辑我的个人资料。我不应该能够查看或编辑其他人的资料” | | ✓ | ✓ | 1110 |
| **1.1.4** | 验证应用程序所有的信任边界、组件和重要数据流的文档，判断其合理性。 | | ✓ | ✓ | 1059 |
| **1.1.5** | 验证应用程序的高级架构及远程连接服务涉及的定义和安全分析。 ([C1](https://owasp.org/www-project-proactive-controls/#div-numbering)) | | ✓ | ✓ | 1059 |
| **1.1.6** | 验证集中、简单（设计）、安全、经过审查、和可重复使用的安全控制措施的实施情况，以避免重复、缺失、无效或不安全的控制措施。 ([C10](https://owasp.org/www-project-proactive-controls/#div-numbering)) | | ✓ | ✓ | 637 |
| **1.1.7** | 向所有开发人员和测试人员，验证安全编码Checklist、安全需求、指南或策略的可用性。 | | ✓ | ✓ | 637 |

## V1.2 认证架构

在设计身份验证时，如果攻击者可以通过拨打客服电话，回答常见的问题来重置帐户，那么是否具有强大硬件支持的多因素身份验证（MFA）并不重要。 在证明身份时，所有的认证途径必须具有相同的强度。

| # | 说明 | L1 | L2 | L3 | CWE |
| :---: | :--- | :---: | :---: | :---: | :---: |
| **1.2.1** | 验证应用程序所有的组件、服务和服务器，是否使用了唯一或特殊的低权限操作系统帐户。 ([C3](https://owasp.org/www-project-proactive-controls/#div-numbering)) | | ✓ | ✓ | 250 |
| **1.2.2** | 验证应用组件之间（包括 API、中间件和数据层）的通信是否经过验证。组件只具有最低的必要权限。 ([C3](https://owasp.org/www-project-proactive-controls/#div-numbering)) | | ✓ | ✓ | 306 |
| **1.2.3** | 验证应用程序是否使用已知安全的单一认证机制，可以扩展到强身份验证，并有足够的日志记录和监控，来检测帐户滥用或违规行为。 | | ✓ | ✓ | 306 |
| **1.2.4** | 验证所有的认证途径和身份管理 API ，都实现了一致的认证安全控制强度， 以便收敛应用程序的风险。 | | ✓ | ✓ | 306 |

## V1.3 会话管理架构

这是未来架构需求的占位符。

## V1.4 访问控制架构

| # | 说明 | L1 | L2 | L3 | CWE |
| :---: | :--- | :---: | :---: | :---: | :---: |
| **1.4.1** | 验证受信任的实施点（如访问控制网关、服务器和Serverless函数）是否实施了访问控制。切勿在客户端实施访问控制。 | | ✓ | ✓ | 602 |
| **1.4.2** | [已删除，不可操作] | | | | |
| **1.4.3** | [已删除，与 4.1.3 重复] | | | | |
| **1.4.4** | 验证应用程序使用单一的、经过严格审查的访问控制机制，来访问受保护的数据和资源。 所有请求都必须通过这个单一机制，以避免复制、粘贴或不安全的替代路径。 ([C7](https://owasp.org/www-project-proactive-controls/#div-numbering)) | | ✓ | ✓ | 284 |
| **1.4.5** | 验证是否使用基于属性/特征的访问控制，即代码应检查用户对某一特征/数据项的授权，而不仅仅是他们的角色。 权限仍应依照不同角色进行分配。 ([C7](https://owasp.org/www-project-proactive-controls/#div-numbering)) | | ✓ | ✓ | 275 |

## V1.5 输入和输出架构

在4.0中，我们已经不再把 “服务器端” 作为一个表示信任边界的术语。 信任边界仍然令人担忧——在不受信任的浏览器或客户端设备上做决定，很容易被绕过的。 然而，在今天的主流架构部署中，信任的执行点已经发生了巨大的变化。 因此，在 ASVS 中使用 “受信任的服务层” 这一术语时，我们描述的都是受信任的执行点，无论其位置如何，如微服务、Serverless API、服务器端、具有安全启动的客户端设备上的受信任的API、合作伙伴或外部API等等。

这里的“不受信任的客户端”一词，是指呈现表示层的客户端技术，通常称为“前端”技术。 这里的术语“序列化”不仅表示通过网络发送数据（如一个数组的值或获取 JSON 结构），还指传递可以包含逻辑的复杂对象。

| # | 说明 | L1 | L2 | L3 | CWE |
| :---: | :--- | :---: | :---: | :---: | :---: |
| **1.5.1** | 验证输入和输出要求，明确规定如何根据类型、内容以及适用的法律、法规和其他政策规定，来操作和处理数据。 | | ✓ | ✓ | 1029 |
| **1.5.2** | 验证在与不受信任的客户进行通信时，不使用序列化。 如果无法做到这一点，请确保执行足够的完整性控制（如果发送敏感数据，可能还要进行加密），以防止反序列化攻击，包括对象注入。 | | ✓ | ✓ | 502 |
| **1.5.3** | 验证输入验证是否在可信的服务层上执行。 ([C5](https://owasp.org/www-project-proactive-controls/#div-numbering)) | | ✓ | ✓ | 602 |
| **1.5.4** | 验证输出编码是否发生在其预期的解释器附近（或由解释器进行）。 ([C4](https://owasp.org/www-project-proactive-controls/#div-numbering)) | | ✓ | ✓ | 116 |

## V1.6 加密架构

应用程序需要设计强大的加密架构，以根据其分类保护数据资产。加密所有东西，是浪费；不加密任何东西，是法律上的疏忽。 在架构或顶层设计、设计冲刺（Design Sprint）或架构高峰期，通常需要取得一种平衡。 一边设计加密技术，一边进行开发迭代，这样的安全实施，其成本不可避免地要比一开始就做简单的构建要高得多。

架构要求是整个代码库的内在要求，因此很难进行单元或集成测试。架构需求需要在整个编码阶段的编码标准中加以考虑，并应在安全架构、代码审查或复盘会议中加以审查。

| # | 说明 | L1 | L2 | L3 | CWE |
| :---: | :--- | :---: | :---: | :---: | :---: |
| **1.6.1** | 验证是否有明确的加密密钥管理政策，以及加密密钥的生命周期是否遵循密钥管理标准，如NIST SP 800-57。 | | ✓ | ✓ | 320 |
| **1.6.2** | 验证密码服务的消费者是否通过使用密钥库或基于API的替代方案，来保护密钥材料和其他机密。 | | ✓ | ✓ | 320 |
| **1.6.3** | 验证所有的密钥和密码是否可替换的，并且是重新加密敏感数据的明确定义流程的一部分。 | | ✓ | ✓ | 320 |
| **1.6.4** | 验证架构是否将客户端机密（例如对称密钥、密码或 API 令牌）视为不安全的，并且从不使用它们来保护或访问敏感数据。 | | ✓ | ✓ | 320 |

## V1.7 错误、日志和审计架构

| # | 说明 | L1 | L2 | L3 | CWE |
| :---: | :--- | :---: | :---: | :---: | :---: |
| **1.7.1** | 验证整个系统是否使用了通用的日志记录格式和方法。 ([C9](https://owasp.org/www-project-proactive-controls/#div-numbering)) | | ✓ | ✓ | 1009 |
| **1.7.2** | 验证日志是否安全地传输到远程系统，以便进行分析、检测、报警和升级。 ([C9](https://owasp.org/www-project-proactive-controls/#div-numbering)) | | ✓ | ✓ | |

## V1.8 数据保护和隐私架构

| # | 说明 | L1 | L2 | L3 | CWE |
| :---: | :--- | :---: | :---: | :---: | :---: |
| **1.8.1** | 验证所有敏感数据都已识别并归入保护级别。 | | ✓ | ✓ | |
| **1.8.2** | 验证所有保护级别都具有一套相关的保护要求，如加密要求、完整性要求、保留、隐私和其他机密性要求，并在架构中应用这些要求。 | | ✓ | ✓ | |

## V1.9 通信架构

| # | 说明 | L1 | L2 | L3 | CWE |
| :---: | :--- | :---: | :---: | :---: | :---: |
| **1.9.1** | 验证应用程序对组件之间的通信进行加密，特别是当这些组件处于不同的容器、系统、站点或云提供商时。 ([C3](https://owasp.org/www-project-proactive-controls/#div-numbering)) | | ✓ | ✓ | 319 |
| **1.9.2** | 验证应用组件是否验证了通信链接中每一方的真实性，以防止中间人攻击。例如，应用程序组件应校验TLS证书链。 | | ✓ | ✓ | 295 |

## V1.10 恶意软件架构

| # | 说明 | L1 | L2 | L3 | CWE |
| :---: | :--- | :---: | :---: | :---: | :---: |
| **1.10.1** | 验证是否使用了源代码控制系统，以及有程序确保签入时附带问题或变更单。源代码控制系统应该具有访问控制和可识别的用户，以追溯任何的更改。 | | ✓ | ✓ | 284 |

## V1.11 业务逻辑架构

| # | 说明 | L1 | L2 | L3 | CWE |
| :---: | :--- | :---: | :---: | :---: | :---: |
| **1.11.1** | 验证所有应用组件在其提供的业务或安全功能方面的定义和文档。 | | ✓ | ✓ | 1059 |
| **1.11.2** | 验证所有高价值的业务逻辑流，包括认证、会话管理和访问控制，不共享不同步的状态。 | | ✓ | ✓ | 362 |
| **1.11.3** | 验证所有高价值的业务逻辑流，包括身份验证、会话管理和访问控制都是线程安全的，并能抵抗检查时间和使用时间不同步时的条件竞争。 | | | ✓ | 367 |

## V1.12 安全上传架构

| # | 说明 | L1 | L2 | L3 | CWE |
| :---: | :--- | :---: | :---: | :---: | :---: |
| **1.12.1** | [已删除，与 12.4.1 重复] | | | | |
| **1.12.2** | 验证用户上传的文件——如果需要显示或从应用中下载，是通过二进制流下载，或从无关的域（如云文件存储桶）提供。实施合适的内容安全策略（CSP），以减少来自上传文件的XSS向量或其他攻击的风险。 | | ✓ | ✓ | 646 |

## V1.13 API架构

这是未来架构需求的占位符。

## V1.14 配置架构

| # | 说明 | L1 | L2 | L3 | CWE |
| :---: | :--- | :---: | :---: | :---: | :---: |
| **1.14.1** | 通过明确的安全控制、防火墙规则、API 网关、反向代理、基于云的安全组或类似机制，验证不同信任级别的组件的隔离情况。 | | ✓ | ✓ | 923 |
| **1.14.2** | 验证二进制签名、可信连接和经过验证的接口，以将二进制文件部署到远程设备。 | | ✓ | ✓ | 494 |
| **1.14.3** | 验证构建管道是否对过期或不安全的组件发出警告并采取适当的行动。 | | ✓ | ✓ | 1104 |
| **1.14.4** | 验证构建管道是否包含自动构建和验证应用安全部署的构建步骤，特别是当应用基础设施是软件定义时，例如云环境构建脚本。 | | ✓ | ✓ | |
| **1.14.5** | 验证应用程序部署是否在网络级别进行了充分的沙盒化、容器化或隔离，以延迟和阻止攻击者攻击其他应用程序，尤其是当攻击者执行敏感或危险操作时（如反序列化）。 ([C5](https://owasp.org/www-project-proactive-controls/#div-numbering)) | | ✓ | ✓ | 265 |
| **1.14.6** | 验证应用程序未使用不受支持、不安全或不推荐的客户端技术，如NSAPI插件、Flash、Shockwave、ActiveX、Silverlight、NACL或客户端Java applets。 | | ✓ | ✓ | 477 |

## 参考文献

有关更多信息，请参阅：

* [OWASP Threat Modeling Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/Threat_Modeling_Cheat_Sheet.html)
* [OWASP Attack Surface Analysis Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/Attack_Surface_Analysis_Cheat_Sheet.html)
* [OWASP Threat modeling](https://owasp.org/www-community/Application_Threat_Modeling)
* [OWASP Software Assurance Maturity Model Project](https://owasp.org/www-project-samm/)
* [Microsoft SDL](https://www.microsoft.com/en-us/sdl/)
* [NIST SP 800-57](https://csrc.nist.gov/publications/detail/sp/800-57-part-1/rev-5/final)

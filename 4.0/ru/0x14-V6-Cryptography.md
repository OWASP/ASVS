# V6 Хранимая криптография

Убедитесь, что исследуемое приложение удовлетворяет следующим концептуальным требованиям:

* Криптографические модули выходят из строя безопасным образом, и ошибки корректно обрабатываются.
* Используется соответствующий генератор случайных чисел.
* Обеспечивается контроль доступа к ключам.

## V6.1 Категории информации

Самым важным активом является информация, обрабатываемая, хранимая или передаваемая приложением. Проводите оценку воздействия на ее конфиденциальность, чтобы правильно классифицировать потребности в защите информации при хранении.

| № | Описание | L1 | L2 | L3 | CWE |
| :---: | :--- | :---: | :---:| :---: | :---: |
| **6.1.1** | Убедитесь, что в зашифрованном виде хранятся регулируемые законом персональные данные, или данные, которые могут подпадать под действие ФЗ-152, GDPR и т.п. | | ✓ | ✓ | [311](https://cwe.mitre.org/data/definitions/311.html) |
| **6.1.2** | Убедитесь, что в зашифрованном виде хранятся регулируемые законом данные о здоровье, например медицинские карты, результаты анализов, диагностические данные с медицинского оборудования или необезличенные результаты клинических исследований. | | ✓ | ✓ | [311](https://cwe.mitre.org/data/definitions/311.html) |
| **6.1.3** | Убедитесь, что в зашифрованном виде хранится регулируемая законом финансовая информация, например, данные о банковских картах и счетах, о банкротстве, кредитная история, налоговые декларации, история платежей, выгодоприобретатели или необезличенные данные исследований рынка. | | ✓ | ✓ | [311](https://cwe.mitre.org/data/definitions/311.html) |

## V6.2 Алгоритмы

Недавние достижения в области криптографии означают, что ранее считавшиеся стойкими алгоритмы и достаточными длины ключей больше не являются таковыми для защиты данных. Следовательно, должна быть возможность поменять алгоритмы.

Хотя этот раздел нелегко протестировать на проникновение, разработчики должны рассматривать весь этот раздел как обязательный, даже если пометка в L1 отсутствует.

| № | Описание | L1 | L2 | L3 | CWE |
| :---: | :--- | :---: | :---:| :---: | :---: |
| **6.2.1** | Убедитесь, что криптографические модули при сбоях ведут себя безопасно, а ошибки обрабатываются таким образом, чтобы не допустить атаки Padding Oracle. | ✓ | ✓ | ✓ | [310](https://cwe.mitre.org/data/definitions/310.html) |
| **6.2.2** | Убедитесь, что используются утвержденные государственные или отраслевые стандарты на криптографические алгоритмы, режимы и библиотеки, а не криптография собственной / заказной разработки. ([C8](https://owasp.org/www-project-proactive-controls/v3/en/c8-protect-data-everywhere.html)) | | ✓ | ✓ | [327](https://cwe.mitre.org/data/definitions/327.html) |
| **6.2.3** | Убедитесь, что вектор инициализации, конфигурация шифра и блочные режимы настроены безопасно, используя актуальные рекомендации. | | ✓ | ✓ | [326](https://cwe.mitre.org/data/definitions/326.html) |
| **6.2.4** | Убедитесь, что для защиты от криптографических атак в любой момент можно перенастроить, обновить или изменить параметры алгоритмов (генерации случайных чисел, шифрования, хэширования), а также длины ключей, раунды, шифры или режимы. ([C8](https://owasp.org/www-project-proactive-controls/v3/en/c8-protect-data-everywhere.html)) | | ✓ | ✓ | [326](https://cwe.mitre.org/data/definitions/326.html) |
| **6.2.5** | Убедитесь, что не используются небезопасные блочные режимы (например, ECB и т.д.), режимы дополнения (например, PKCS#1 v1.5 и т.д.), шифры с небольшими размерами блоков (например, 3DES, Blowfish и т.д.) и нестойкие алгоритмы хеширования (например, MD5, SHA1 и т. д.), если это не требуется для обратной совместимости. | | ✓ | ✓ | [326](https://cwe.mitre.org/data/definitions/326.html) |
| **6.2.6** | Убедитесь, что значения nonce, векторов инициализации и других случайных одноразовых строк не должны использоваться более одного раза с данным ключом шифрования. Метод их генерации должен соответствовать используемому алгоритму. | | ✓ | ✓ | [326](https://cwe.mitre.org/data/definitions/326.html) |
| **6.2.7** | Убедитесь, что зашифрованные данные аутентифицированы с помощью подписей, аутентифицированных режимов шифрования или HMAC, чтобы гарантировать, что зашифрованный текст не будет изменен неуполномоченной на то стороной. | | | ✓ | [326](https://cwe.mitre.org/data/definitions/326.html) |
| **6.2.8** | Убедитесь, что все криптографические операции выполняются за постоянное время, без операций «короткого замыкания» при сравнении, вычислениях или возврате, чтобы избежать утечки информации по побочным каналам. | | | ✓ | [385](https://cwe.mitre.org/data/definitions/385.html) |

## V6.3 Случайные значения

Настоящий генератор псевдослучайных чисел (PRNG) невероятно сложно сделать правильно. Обычно, хорошие источники энтропии в системе быстро истощаются при чрезмерном использовании, но источники с меньшей случайностью могут привести к предсказуемым ключам и секретам.

| № | Описание | L1 | L2 | L3 | CWE |
| :---: | :--- | :---: | :---:| :---: | :---: |
| **6.3.1** | Убедитесь, что все случайные числа, случайные имена файлов, случайные идентификаторы GUID и случайные строки генерируются с помощью утвержденного криптографического генератора случайных чисел в криптографическом модуле. | | ✓ | ✓ | [338](https://cwe.mitre.org/data/definitions/338.html) |
| **6.3.2** | Убедитесь, что случайные идентификаторы GUID создаются с использованием алгоритма GUIDv4 и криптографического генератора псевдослучайных чисел (CSPRNG). GUID, созданные с помощью других генераторов псевдослучайных чисел, могут быть предсказуемыми.| | ✓ | ✓ | [338](https://cwe.mitre.org/data/definitions/338.html) |
| **6.3.3** | Убедитесь, что случайные числа создаются с надлежащей энтропией, даже когда приложение находится под большой нагрузкой, и что при сбоях оно ведет себя безопасно. | | | ✓ | [338](https://cwe.mitre.org/data/definitions/338.html) |

## V6.4 Управление секретами

Хотя этот раздел нелегко протестировать на проникновение, разработчики должны рассматривать весь этот раздел как обязательный, даже если пометка в L1 отсутствует.

| № | Описание | L1 | L2 | L3 | CWE |
| :---: | :--- | :---: | :---:| :---: | :---: |
| **6.4.1** | Убедитесь, что для безопасного создания, хранения, контроля доступа и уничтожения секретов используется решение для управления секретами, например, сейф — хранилище для ключей (key vault). ([C8](https://owasp.org/www-project-proactive-controls/v3/en/c8-protect-data-everywhere.html)) | | ✓ | ✓ | [798](https://cwe.mitre.org/data/definitions/798.html) |
| **6.4.2** | Убедитесь, что ключевой материал не доступен приложению, и для криптографических операций применяется изолированный модуль безопасности, например, сейф (vault). ([C8](https://owasp.org/www-project-proactive-controls/v3/en/c8-protect-data-everywhere.html)) | | ✓ | ✓ | [320](https://cwe.mitre.org/data/definitions/320.html) |

## Источники

Для дополнительной информации см. также:

* [OWASP Testing Guide 4.0: Testing for weak Cryptography](https://owasp.org/www-project-web-security-testing-guide/stable/4-Web_Application_Security_Testing/09-Testing_for_Weak_Cryptography/README.html)
* [OWASP Cheat Sheet: Cryptographic Storage](https://cheatsheetseries.owasp.org/cheatsheets/Cryptographic_Storage_Cheat_Sheet.html)
* [FIPS 140-2](https://csrc.nist.gov/publications/detail/fips/140/2/final)

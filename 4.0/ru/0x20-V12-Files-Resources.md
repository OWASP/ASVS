# V12 Файлы и ресурсы

## Задачи контроля

Убедитесь, что исследуемое приложение удовлетворяет следующим концептуальным требованиям:

* Недоверенные данные файлов должны обрабатываться соответствующим и безопасным образом.
* Недоверенные данные файлов, полученные из недоверенных источников, хранятся вне корневого каталога webroot и с ограниченными разрешениями.

## V12.1 Загрузка файлов на сервер

Хотя zip-бомбы хорошо поддаются тестированию методами пентеста, они относятся к уровню L2 и выше, чтобы поощрять проектирование и разработку с тщательным ручным тестированием и избегать автоматизированного или неквалифицированного ручного тестирования на выявление ситуации отказа в обслуживании.

| № | Описание | L1 | L2 | L3 | CWE |
| :---: | :--- | :---: | :---:| :---: | :---: |
| **12.1.1** | Убедитесь, что приложение не будет принимать файлы, размер которых превышает доступное место или вызывает отказ в обслуживании. | ✓ | ✓ | ✓ | 400 |
| **12.1.2** | Убедитесь, что приложение проверяет сжатые файлы (например, zip, gz, docx, odt) на соответствие максимально допустимому несжатому размеру и максимальному количеству файлов перед распаковкой файла. | | ✓ | ✓ | 409 |
| **12.1.3** | Убедитесь, что применяются квоты на размер файла и на максимальное количество файлов на одного пользователя, чтобы гарантировать, что пользователь не может заполнить все хранилище слишком большим количеством файлов или файлами чрезмерно большого размера. | | ✓ | ✓ | 770 |

## V12.2 Целостность файлов

| № | Описание | L1 | L2 | L3 | CWE |
| :---: | :--- | :---: | :---:| :---: | :---: |
| **12.2.1** | Убедитесь, что файлы, полученные из недоверенных источников, соответствуют ожидаемому типу на основе содержимого файла (а не только его наименования). | | ✓ | ✓ | 434 |

## V12.3 Исполнение файла

| № | Описание | L1 | L2 | L3 | CWE |
| :---: | :--- | :---: | :---:| :---: | :---: |
| **12.3.1** | Убедитесь, что метаданные имени файла, отправляемые пользователем, не используются напрямую файловыми системами ОС или платформы. Вместо этого для защиты от атак path traversal (перемещения по каталогам) используется API URL. | ✓ | ✓ | ✓ | 22 |
| **12.3.2** | Убедитесь, что передаваемые пользователем метаданные файла проверяются на предмет раскрытия, создания, изменения или удаления локальных файлов (LFI) или игнорируются. | ✓ | ✓ | ✓ | 73 |
| **12.3.3** | Убедитесь, что передаваемые пользователем метаданные файла проверяются на предмет раскрытия или исполнения файлов посредством удаленного включения (RFI) или подделки запросов на стороне сервера (SSRF), или игнорируются. | ✓ | ✓ | ✓ | 98 |
| **12.3.4** | Убедитесь, что приложение защищено от отраженной загрузки файлов (Reflected File Download, RFD), проверяя или игнорируя передаваемые пользователем в JSON, JSONP или в параметрах URL имена файлов. При этом заголовок ответа Content-Type должен быть установлен в text/plain, а заголовок Content-Disposition должно иметь фиксированное имя файла. | ✓ | ✓ | ✓ | 641 |
| **12.3.5** | Убедитесь, что недоверенные метаданные файла не используются напрямую с системными API или библиотеками для защиты от инъекции команд операционной системы. | ✓ | ✓ | ✓ | 78 |
| **12.3.6** | Убедитесь, что приложение не включает и не исполняет функции из недоверенных источников, таких как непроверенные сети доставки контента (CDN), библиотеки JavaScript, пакеты из npm в Node.js, или серверные библиотеки DLL. | | ✓ | ✓ | 829 |

## V12.4 Хранение файлов

| № | Описание | L1 | L2 | L3 | CWE |
| :---: | :--- | :---: | :---:| :---: | :---: |
| **12.4.1** | Убедитесь, что файлы, полученные из недоверенных источников, хранятся вне корневого каталога webroot и имеют ограниченные разрешения. | ✓ | ✓ | ✓ | 552 |
| **12.4.2** | Убедитесь, что файлы, полученные из недоверенных источников, проверяются антивирусными сканерами, чтобы предотвратить загрузку и распространение известного вредоносного кода. | ✓ | ✓ | ✓ | 509 |

## V12.5 Загрузка файлов клиентом

| № | Описание | L1 | L2 | L3 | CWE |
| :---: | :--- | :---: | :---:| :---: | :---: |
| **12.5.1** | Убедитесь, что уровень представления (web) обслуживает только файлы с заранее определенными расширениями, чтобы предотвратить непреднамеренную утечку информации и исходного кода. Например, файлы резервных копий (.bak), временные рабочие файлы (.swp), сжатые файлы (.zip, .tar.gz и т. д.) и другие расширения, обычно используемые редакторами, должны быть заблокированы, если в них нет необходимости. | ✓ | ✓ | ✓ | 552 |
| **12.5.2** | Убедитесь, что прямые запросы к загруженным файлам никогда не будут интерпретироваться как содержимое HTML/JavaScript. | ✓ | ✓ | ✓ | 434 |

## V12.6 Защита от SSRF

| № | Описание | L1 | L2 | L3 | CWE |
| :---: | :--- | :---: | :---:| :---: | :---: |
| **12.6.1** | Убедитесь, что на web-сервере или сервере приложений настроен список разрешенных ресурсов или систем, к которым сервер может отправлять запросы или с которых он может загружать данные/файлы. | ✓ | ✓ | ✓ | 918 |

## Ссылки

Для дополнительной информации см. также:

* [Unrestricted File Upload](https://owasp.org/www-community/vulnerabilities/Unrestricted_File_Upload)
* [Reflective file download by Oren Hafif](https://www.trustwave.com/Resources/SpiderLabs-Blog/Reflected-File-Download---A-New-Web-Attack-Vector/)
* [OWASP Third Party JavaScript Management Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/Third_Party_Javascript_Management_Cheat_Sheet.html)

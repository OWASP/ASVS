# V3 Управление сессиями

## Задачи контроля

Одним из основных компонентов любого web-приложения или API с отслеживанием состояния является механизм, с помощью которого оно контролирует и поддерживает состояние пользователя или устройства, взаимодействующего с ним. Управление сессиями превращает протокол без сохранения состояния в протокол с его сохранением, что имеет решающее значение для разграничения пользователей или устройств.

Убедитесь, что проверяемое приложение удовлетворяет следующим концептуальным требованиям к управлению сессиями:

* Сессии уникальны для каждого пользователя, их идентификаторы нельзя угадать, и ими нельзя «поделиться» с другими.
* Сессии становятся недействительными, когда они больше не нужны, т.е. при бездействии пользователя срок действия сессии истекает.

Как отмечалось ранее, эти требования были адаптированы для соответствия подмножеству мер в [NIST 800-63b](https://pages.nist.gov/800-63-3/sp800-63b.html), ориентированных на наиболее распространенные угрозы и часто эксплуатируемые недостатки аутентификации. Из предыдущих требований были исключены дубли.

## Верификация требований к безопасности

## V3.1 Базовые требования

| № | Описание | L1 | L2 | L3 | CWE | NIST |
| :---: | :--- | :---: | :---:| :---: | :---: | :---: |
| **3.1.1** | Убедитесь, что приложение не указывает сессионные токены в параметрах URL. | ✓ | ✓ | ✓ | 598 | |

## V3.2 Создание сессии

| № | Описание | L1 | L2 | L3 | CWE | NIST |
| :---: | :--- | :---: | :---:| :---: | :---: | :---: |
| **3.2.1** | Убедитесь, что при аутентификации пользователя приложение каждый раз создает новый сессионный токен. ([C6](https://owasp.org/www-project-proactive-controls/#div-numbering)) | ✓ | ✓ | ✓ | 384 | 7.1 |
| **3.2.2** | Убедитесь, что сессионные токены обладают энтропией как минимум в 64-бит. ([C6](https://owasp.org/www-project-proactive-controls/#div-numbering)) | ✓ | ✓ | ✓ | 331 | 7.1 |
| **3.2.3** | Убедитесь, что приложение хранит сессионные токены в браузере безопасно, например, в защищенных файлах cookie (см. раздел V.3.4) или в хранилище сессий HTML5. | ✓ | ✓ | ✓ | 539 | 7.1 |
| **3.2.4** | Убедитесь, что сессионные токены генерируются с использованием утвержденных криптографических алгоритмов. ([C6](https://owasp.org/www-project-proactive-controls/#div-numbering)) | | ✓ | ✓ | 331 | 7.1 |

TLS или другой безопасный канал передачи является обязательным для управления сессиями. Об этом говорится в главе «Передача данных».

## V3.3 Завершение сессии

Период ожидания сессии приведен в соответствие со стандартом NIST 800-63, который допускает гораздо более продолжительные значения, чем в других стандартах по безопасности. Организации должны проанализировать приведенную ниже таблицу, и если желателен более длительный период ожидания в зависимости от риска приложения, значение NIST должно быть верхним пределом времени простоя.

L1 в этом контексте — это IAL1/AAL1, L2 — это IAL2/AAL3, L3 — это IAL3/AAL3. Для IAL2/AAL2 и IAL3/AAL3 более короткий период ожидания является нижней границей времени для выхода из системы или повторной аутентификации для возобновления сессии.

| № | Описание | L1 | L2 | L3 | CWE | NIST |
| :---: | :--- | :---: | :---:| :---: | :---: | :---: |
| **3.3.1** | Убедитесь, что при выходе из системы и по истечению срока действия сессионный токен становится недействительным, таким образом, чтобы кнопка «Назад» или нижестоящая проверяющая сторона не возобновляли аутентифицированную сессию, в том числе между проверяющими сторонами. ([C6](https://owasp.org/www-project-proactive-controls/#div-numbering)) | ✓ | ✓ | ✓ | 613 | 7.1 |
| **3.3.2** | Если механизмы аутентификации позволяют пользователям оставаться в системе, убедитесь, что как при активном использовании, так и после периода простоя, периодически проводится повторная аутентификация. ([C6](https://owasp.org/www-project-proactive-controls/#div-numbering)) | 30 дней | 12 часов или 30 минут бездействия, МФА как опция | 12 часов или 15 минут бездействия, МФА обязательна | 613 | 7.2 |
| **3.3.3** | Убедитесь, что после успешного изменения пароля (в т.ч. после его сброса/восстановления) приложение дает возможность завершить все активные сессии, и что это действие распространяется на приложения при федеративном входе в систему (при его наличии) и на проверяющие стороны. | | ✓ | ✓ | 613 | |
| **3.3.4** | Убедитесь, что пользователи могут видеть все свои активные на данный момент сессии и устройства и (после повторного ввода учетных данных) выходить из любой из них или из всех сразу. | | ✓ | ✓ | 613 | 7.1 |

## V3.4 Cookie

| № | Описание | L1 | L2 | L3 | CWE | NIST |
| :---: | :--- | :---: | :---:| :---: | :---: | :---: |
| **3.4.1** | Убедитесь, что для сессионных токенов на основе файлов cookie установлен атрибут Secure. ([C6](https://owasp.org/www-project-proactive-controls/#div-numbering)) | ✓ | ✓ | ✓ | 614 | 7.1.1 |
| **3.4.2** | Убедитесь, что для сессионных токенов на основе cookie установлен атрибут HttpOnly. ([C6](https://owasp.org/www-project-proactive-controls/#div-numbering)) | ✓ | ✓ | ✓ | 1004 | 7.1.1 |
| **3.4.3** | Убедитесь, что сессионные токены на основе cookie используют атрибут SameSite, установленный в значение Lax или Strict, чтобы ограничить подверженность атакам по подмене межсайтовых запросов (CSRF). ([C6](https://owasp.org/www-project-proactive-controls/#div-numbering)) | ✓ | ✓ | ✓ | 16 | 7.1.1 |
| **3.4.4** | Убедитесь, что токены сессии на основе cookie используют префикс "__Host-". Таким образом, cookie отправляются только на тот хост, который изначально его установил, т.е. нельзя установить несколько cookie с одинаковым именем из другого поддомена или с другим значением домена или с другим значением пути. | ✓ | ✓ | ✓ | 16 | 7.1.1 |
| **3.4.5** | Убедитесь, что если приложение публикуется под одним доменным именем с другими приложениями, которые также устанавливают или используют свои сессионные cookie, и могут раскрывать их, то задайте атрибут Path, используя максимально точный путь. ([C6](https://owasp.org/www-project-proactive-controls/#div-numbering)) | ✓ | ✓ | ✓ | 16 | 7.1.1 |

## V3.5 Токены

Управление сессиями на основе токенов включает в себя JWT, OAuth, SAML и API-ключи. Известно, что последние являются наиболее слабыми и не должны использоваться в новых разработках.

| № | Описание | L1 | L2 | L3 | CWE | NIST |
| :---: | :--- | :---: | :---:| :---: | :---: | :---: |
| **3.5.1** | Убедитесь, что приложение позволяет пользователям отзывать Oauth-токены, которые формируют отношения доверия со связанными приложениями. | | ✓ | ✓ | 290 | 7.1.2 |
| **3.5.2** | Убедитесь, что приложение использует сессионные токены, а не статические секреты и API-ключи, за исключением устаревших реализаций. | | ✓ | ✓ | 798 | |
| **3.5.3** | Убедитесь, что сессионные токены без сохранения состояния используют электронную подпись, шифрование и другие контрмеры для защиты от атак подделки, обертывания, воспроизведения, нулевого шифрования и подмены ключей. | | ✓ | ✓ | 345 | |

## V3.6 Федеративная повторная аутентификация

Этот раздел предназначен для тех, кто разрабатывает код для проверяющей стороны (англ.: Relying Party, RP) или поставщика учётных данных (англ.: Credential Service Provider, CSP). Если вы полагаетесь на код, реализующий эти функции, убедитесь, что следующие ниже требования удовлетворяются.

| № | Описание | L1 | L2 | L3 | CWE | NIST |
| :---: | :--- | :---: | :---:| :---: | :---: | :---: |
| **3.6.1** | Убедитесь, что на проверяющей стороне (RP) определено предельно допустимое время аутентификации для поставщика учетных данных (CSP), и что CSP должны требовать повторной аутентификации пользователя, в случае бездействия в течение этого периода. | | | ✓ | 613 | 7.2.1 |
| **3.6.2** | Убедитесь, что поставщик учетных данных (CSP) информирует проверяющую сторону (RP) о последнем событии аутентификации, чтобы RP могла определить, нужно ли ей повторно аутентифицировать пользователя. | | | ✓ | 613 | 7.2.1 |

## V3.7 Меры защиты от уязвимостей сессии

Существует несколько атак на управление сессиями, некоторые из которых связаны с пользовательским интерфейсом (UX). Ранее, в соответствии с требованиями ISO 27002, ASVS требовал блокировать параллельные сессии. Теперь такое решение неприменимо, не только потому, что у современных пользователей много устройств, или потому, что приложение может представлять собой API без сессий от браузера, но ещё и потому, что в большинстве этих реализаций действующим остается только последний аутентификатор, который чаще всего и предъявляет злоумышленник. В этом разделе представлены основные рекомендации по предотвращению, задержке и обнаружению атак на управление сессиями.

### Описание «полуоткрытой» атаки

В начале 2018 года несколько финансовых учреждений были скомпрометированы с помощью так называемых «полуоткрытых атак». Полуоткрытая атака использует недостаток шаблона проектирования, часто встречающийся во многих системах аутентификации, управления сессиями и контроля доступа.

Злоумышленники начинают полуоткрытую атаку, пытаясь заблокировать, сбросить или восстановить учетные данные. В популярном шаблоне проектирования объекты профиля пользователя переиспользуются между неаутентифицированным, полуаутентифицированным (сброс или восстановление) и полностью аутентифицированным состояниями. Этот шаблон вставляет объект сессии или токен, содержащий профиль жертвы, включая хэш его пароля и имеющиеся роли. Если контроллер доступа или маршрутизатор не проверяют, что пользователь действительно полностью аутентифицирован, то злоумышленник сможет действовать от имени пользователя. Атаки могут включать изменение пароля, обновление адреса email, отключение многофакторной аутентификации или регистрацию нового устройства для МФА, раскрытие или изменение API-ключей и т.д.

| № | Описание | L1 | L2 | L3 | CWE | NIST |
| :---: | :--- | :---: | :---:| :---: | :---: | :---: |
| **3.7.1** | Убедитесь, что приложение обеспечивает полный, действительный сеанс входа в систему или требует повторной аутентификации или проверки второго фактора, прежде чем разрешать какие-либо конфиденциальные транзакции или изменения учетной записи. | ✓ | ✓ | ✓ | 306 | |

## Ссылки

Для дополнительной информации см. также:

* [OWASP Testing Guide 4.0: Session Management Testing](https://owasp.org/www-project-web-security-testing-guide/v42/4-Web_Application_Security_Testing/06-Session_Management_Testing/README.html)
* [OWASP Session Management Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/Session_Management_Cheat_Sheet.html)
* [Set-Cookie __Host- prefix details](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Set-Cookie#Directives)

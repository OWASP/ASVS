# V1 Архитектура, проектирование и моделирование угроз

## Задачи контроля

Во многих организациях архитектура безопасности сегодня стала почти забытым занятием. Слава корпоративных архитекторов в эпоху DevSecOps проходит. Область безопасности приложений должна подхватить это знамя, и, адаптируясь к принципам Agile, представить свои передовые принципы архитектуры безопасности разработчикам программного обеспечения. Архитектура — это не реализация, а способ осмысления проблемы, которая потенциально имеет много разных решений и не имеет единственного правильного ответа. Часто безопасность считается негибкой, требуя, чтобы разработчики исправляли код определённым образом, однако разработчики часто могут знать гораздо лучший способ решения. Не существует единого простого решения в архитектуре, и делать вид, что это не так, — медвежья услуга разработчикам программного обеспечения.

Конкретная реализация web-приложения, возможно, будет постоянно меняться на протяжении всего его жизненного цикла, но общая архитектура, скорее всего, будет меняться редко, и развиваться медленно. Так же и архитектура безопасности — аутентификация нужна нам сегодня, и завтра, и через пять лет. Если мы примем правильные решения сегодня, то сможем сэкономить много сил, времени и средств, выбрав и повторно используя архитектурно-совместимые решения. Например, лет десять назад многофакторная аутентификация почти не применялась.

Если бы разработчики вложились в единую защищённую модель поставщика удостоверений, такую как федеративные удостоверения SAML, её можно было бы обновить, включив только новые требования, например, из стандарта NIST 800-63, без изменения интерфейсов исходного приложения. Если множество приложений имеют общую архитектуру безопасности и, следовательно, общие компоненты, то все они получат выгоду от этого обновления одновременно. Однако SAML не всегда будет лучшим или наиболее подходящим решением для аутентификации — возможно, его придётся заменить другими решениями по мере изменения требований. Подобные изменения либо сложны, либо настолько дорогостоящи, что требуют полной переделки, либо совершенно невозможны без архитектуры безопасности.

В этой главе ASVS охватывает основные аспекты правильной архитектуры безопасности: доступность, конфиденциальность, целостность обработки, неотказуемость и конфиденциальность. Каждый из этих принципов безопасности должен быть встроен во все приложения. Крайне важно «двигаться влево», начиная с поддержки разработчиков с помощью чек-листов безопасного программирования, наставничества и обучения, разработки и тестирования, сборки, развёртывания, конфигурирования и эксплуатации, и заканчивая приёмо-сдаточным тестированием, чтобы убедиться, что все необходимые меры безопасности приняты и они работают. Раньше этот последний шаг и был всем, что мы делали. Но теперь этого недостаточно, ведь разработчики выпускают код в промышленную среду десятки или сотни раз в день. Специалисты по безопасности приложений должны идти в ногу с гибкими методами, что означает изучение инструментов разработки, обучение программированию и совместную работу с разработчиками, а не критику проекта спустя месяцы после того, как все остальные продвинулись дальше.

## V1.1 Жизненный цикл разработки безопасного ПО

| № | Описание | L1 | L2 | L3 | CWE |
| :---: | :--- | :---: | :---:| :---: | :---: |
| **1.1.1** | Убедитесь в использовании безопасного жизненного цикла разработки программного обеспечения, который обеспечивает безопасность на всех этапах разработки. ([C1](https://owasp.org/www-project-proactive-controls/#div-numbering)) | | ✓ | ✓ | |
| **1.1.2** | Убедитесь в применении моделирования угроз для каждого изменения дизайна или планирования спринта, чтобы выявлять угрозы, планировать контрмеры, способствовать надлежащему реагированию на риски и управлять тестированием безопасности. | | ✓ | ✓ | 1053 |
| **1.1.3** | Убедитесь, что все пользовательские истории и функции содержат функциональные ограничения безопасности. Например, такие: "Как пользователь, я должен иметь возможность просматривать и редактировать свой профиль, но не должен иметь возможности просматривать или редактировать чужой профиль". | | ✓ | ✓ | 1110 |
| **1.1.4** | Убедитесь в наличии документации и обоснования для всех границ доверия приложения, его компонентов и значимых информационных взаимодействий. | | ✓ | ✓ | 1059 |
| **1.1.5** | Проверьте описание концептуальной архитектуры приложения, связанных с ним внешних систем и анализ их безопасности. ([C1](https://owasp.org/www-project-proactive-controls/#div-numbering)) | | ✓ | ✓ | 1059 |
| **1.1.6** | Проконтролируйте наличие централизованных, простых в реализации, проверенных, безопасных и переиспользуемых мер безопасности, чтобы избежать их дублирования или, наоборот, отсутствия, а также неэффективных или небезопасных мер. ([C10](https://owasp.org/www-project-proactive-controls/#div-numbering)) | | ✓ | ✓ | 637 |
| **1.1.7** | Убедитесь в наличии чек-листа для безопасной разработки, требований, политик и стандартов безопасности, а также в их доступности для разработчиков и тестировщиков. | | ✓ | ✓ | 637 |

## V1.2 Аутентификация

При проектировании системы аутентификации не имеет значения, насколько безопасна ваша многофакторная аутентификация, если злоумышленник может сбросить пароль учетной записи, просто позвонив в контакт-центр, и ответив на общеизвестные вопросы. При подтверждении личности все пути аутентификации должны иметь одинаковую силу.

| № | Описание | L1 | L2 | L3 | CWE |
| :---: | :--- | :---: | :---:| :---: | :---: |
| **1.2.1** | Убедитесь в использовании всеми компонентами приложений, служб и серверов уникальных или специальных учетных записей операционной системы с низким уровнем привилегий. ([C3](https://owasp.org/www-project-proactive-controls/#div-numbering)) | | ✓ | ✓ | 250 |
| **1.2.2** | Убедитесь, что взаимодействие между всеми компонентами приложения, включая API, промежуточное ПО и уровень хранения данных, аутентифицировано. Компоненты должны иметь минимально необходимые привилегии. ([C3](https://owasp.org/www-project-proactive-controls/#div-numbering)) | | ✓ | ✓ | 306 |
| **1.2.3** | Убедитесь, что приложение использует единый утвержденный механизм аутентификации, который может быть дополнен включением строгой аутентификации, а также обеспечивает адекватное журналирование и мониторинг для обнаружения нарушений политик безопасности или взлома учетной записи. | | ✓ | ✓ | 306 |
| **1.2.4** | Убедитесь, что все пути аутентификации и API идентификации реализуют заданный уровень безопасности, и что более слабые альтернативы отсутствуют. | | ✓ | ✓ | 306 |

## V1.3 Управление сессиями

Место вставки для будущих архитектурных требований.

## V1.4 Контроль доступа

| № | Описание | L1 | L2 | L3 | CWE |
| :---: | :--- | :---: | :---:| :---: | :---: |
| **1.4.1** | Убедитесь, что контроль доступа применяется в пределах контролируемоой зоны (т.е. на шлюзах безопасности, серверах и бессерверных функциях). Нельзя применять контроль доступа на стороне клиента. | | ✓ | ✓ | 602 |
| **1.4.2** | [УДАЛЕНО, НЕВОЗМОЖНО ПРОВЕРИТЬ] | | | | |
| **1.4.3** | [УДАЛЕНО, ДУБЛИРУЕТ 4.1.3] | | | | |
| **1.4.4** | Убедитесь, что приложение использует единый и тщательно протестированный механизм контроля доступа для доступа к защищенным данным и ресурсам. Все запросы должны проходить через этот единый механизм, чтобы избежать копирования и вставки или небезопасных альтернативных путей. ([C7](https://owasp.org/www-project-proactive-controls/#div-numbering)) | | ✓ | ✓ | 284 |
| **1.4.5** | Убедитесь, что при управлении доступом на основе атрибутов или функций, код проверяет доступ пользователя к функции/данным, а не только его роль. Разрешения в любом случае должны выдаваться в соответствии с ролью. ([C7](https://owasp.org/www-project-proactive-controls/#div-numbering)) | | ✓ | ✓ | 275 |

## V1.5 Входные и выходные данные

В версии 4.0 мы отошли от термина «серверная часть» как термина, обозначающего границу доверия. Граница доверия как термин по-прежнему вызывает сомнения — контроль доступа в недоверенных браузерах или клиентских устройствах можно обойти. Однако в современных архитектурных концепциях смысл точки обеспечения доверия кардинально изменился. Поэтому, когда в ASVS используется термин «уровень доверенного сервиса», мы подразумеваем любую доверенную точку применения политики управления доступом, независимо от ее местоположения, например, это может быть микросервис, бессерверный API, серверная часть, доверенный API на клиентском устройстве, которое имеет доверенную загрузку, партнерские или внешние API и т.д.

Термин «недоверенный клиент» здесь относится к технологиям на стороне клиента, которые отображают уровень представления, обычно называемый интерфейсным (front-end). Термин «сериализация» здесь относится не только к отправке данных по сети, например, массива значений или получению и чтению структуры JSON, но и к передаче сложных объектов, которые могут содержать логику, например, Data Transfer Objects, (DTO).

| № | Описание | L1 | L2 | L3 | CWE |
| :---: | :--- | :---: | :---:| :---: | :---: |
| **1.5.1** | Убедитесь, что требования к входным и выходным данным четко определяют, как обращаться с данными и обрабатывать их в зависимости от типа, содержимого и применимых законов, нормативных документов и других политик. | | ✓ | ✓ | 1029 |
| **1.5.2** | Убедитесь, что сериализация не используется при взаимодействии с недоверенными клиентами. Если это невозможно, убедитесь, что применяются адекватные меры контроля целостности (и, при необходимости, шифрование при передаче конфиденциальных данных) для предотвращения атак десериализации, включая внедрение объектов. | | ✓ | ✓ | 502 |
| **1.5.3** | Убедитесь, что форматно-логический контроль входных данных выполняется на уровне доверенного сервиса. ([C5](https://owasp.org/www-project-proactive-controls/#div-numbering)) | | ✓ | ✓ | 602 |
| **1.5.4** | Убедитесь, что кодировка и/или экранирование выходных данных проводится интерпретатором, для которого они предназначены, или непосредственно перед ним. ([C4](https://owasp.org/www-project-proactive-controls/#div-numbering)) | | ✓ | ✓ | 116 |

## V1.6 Криптографическая защита

Приложения должны разрабатываться в соответствии с утвержденной архитектурой криптографической защиты информационных ресурсов с учетом их категории конфиденциальности. Шифровать всё — это расточительство, а не шифровать вовсе — правовой нигилизм. Компромисс обычно находится во время архитектурного или концептуального проектирования, спринтов по дизайну. Разработка криптографии по ходу проекта или ее последующая модернизация обойдутся гораздо дороже, чем встроить ее с самого начала.

Архитектурные требования предъявляются ко всей кодовой базе, поэтому их трудно охватить модульными или интеграционными тестами. Требования к архитектуре требуют учета в стандартах разработки на протяжении всего жизненного цикла и должны учитываться на архитектуре безопасности, при оценке кода коллегами или на ретроспективах.

| № | Описание | L1 | L2 | L3 | CWE |
| :---: | :--- | :---: | :---:| :---: | :---: |
| **1.6.1** | Убедитесь в наличии формализованной политики управления криптографическими ключами и что жизненный цикл криптографического ключа соответствует стандарту управления ключами, например NIST SP 800-57. | | ✓ | ✓ | 320 |
| **1.6.2** | Убедитесь, что потребители криптографических сервисов защищают ключевой материал и другие секреты с помощью хранилища ключей (vault) или альтернатив на основе API. | | ✓ | ✓ | 320 |
| **1.6.3** | Убедитесь, что все ключи и пароли являются заменяемыми и являются частью формализованного и легко воспроизводимого процесса шифрования чувствительных данных. | | ✓ | ✓ | 320 |
| **1.6.4** | Убедитесь, что на уровне архитектуры секреты на стороне клиента, такие как симметричные ключи, пароли или API-токены, считаются по умолчанию небезопасными, и никогда не используются для защиты или доступа к конфиденциальным данным. | | ✓ | ✓ | 320 |

## V1.7 Обработка ошибок, ведение журнала и аудит

| № | Описание | L1 | L2 | L3 | CWE |
| :---: | :--- | :---: | :---:| :---: | :---: |
| **1.7.1** | Убедитесь, что в системе используются единый подход и формат ведения журнала событий. ([C9](https://owasp.org/www-project-proactive-controls/#div-numbering)) | | ✓ | ✓ | 1009 |
| **1.7.2** | Убедитесь, что журналы событий безопасности надежно передаются в предпочтительно удалённую систему для их дальнейшего анализа, обнаружения аномалий, оповещения соответствующих специалистов и эскалации. ([C9](https://owasp.org/www-project-proactive-controls/#div-numbering)) | | ✓ | ✓ | |

## V1.8 Защита информации и конфиденциальность

| № | Описание | L1 | L2 | L3 | CWE |
| :---: | :--- | :---: | :---:| :---: | :---: |
| **1.8.1** | Убедитесь, что все чувствительные данные идентифицированы и классифицированы по уровням защиты. | | ✓ | ✓ | |
| **1.8.2** | Убедитесь, что каждому уровню защиты соответствует набор требований безопасности (целостность, конфиденциальность, сроки хранения и др.), и что эти требования удовлетворяются в архитектуре. | | ✓ | ✓ | |

## V1.9 Передача данных

| № | Описание | L1 | L2 | L3 | CWE |
| :---: | :--- | :---: | :---:| :---: | :---: |
| **1.9.1** | Убедитесь, что приложение шифрует обмен данными между компонентами, особенно когда эти компоненты находятся в разных контейнерах, системах, сайтах или у разных провайдеров облачной инфраструктуры. ([C3](https://owasp.org/www-project-proactive-controls/#div-numbering)) | | ✓ | ✓ | 319 |
| **1.9.2** | Убедитесь, что компоненты приложения аутентифицируют каждую сторону взаимодействия, чтобы предотвратить атаки "человек посередине". Например, компоненты приложения должны проверять сертификаты и цепочки доверия TLS. | | ✓ | ✓ | 295 |

## V1.10 Вредоносный код

| № | Описание | L1 | L2 | L3 | CWE |
| :---: | :--- | :---: | :---:| :---: | :---: |
| **1.10.1** | Убедитесь, что используется система управления исходным кодом и применяются процедуры, гарантирующие, что регистрация кода сопровождается отчетами о проблемах или заявками на изменение. Система управления исходным кодом должна контролировать доступ и идентифицировать пользователей, чтобы можно было отслеживать каждое изменение кода. | | ✓ | ✓ | 284 |

## V1.11 Бизнес-логика

| № | Описание | L1 | L2 | L3 | CWE |
| :---: | :--- | :---: | :---:| :---: | :---: |
| **1.11.1** | Проверьте определение и документацию на компоненты приложения с точки зрения бизнес-функций или функций безопасности, которые они обеспечивают. | | ✓ | ✓ | 1059 |
| **1.11.2** | Убедитесь, что все ключевые потоки бизнес-логики, включая аутентификацию, управление сессиями и контроль доступа, не используются в несинхронизированном состоянии. | | ✓ | ✓ | 362 |
| **1.11.3** | Убедитесь, что все критичные потоки бизнес-логики, включая аутентификацию, управление сессиями и контроль доступа, являются безопасными с точки зрения их параллельного выполнения и устойчивыми к условиям гонки, вызванной разницей между состояниями приложения в момент проверки и в момент использования (TOCTOU). | | | ✓ | 367 |

## V1.12 Безопасная загрузка файлов

| № | Описание | L1 | L2 | L3 | CWE |
| :---: | :--- | :---: | :---:| :---: | :---: |
| **1.12.1** | [УДАЛЕНО, ДУБЛИРУЕТ 12.4.1] | | | | |
| **1.12.2** | Убедитесь, что загружаемые пользователем файлы — если требуется их отображение или загрузка из приложения — сохраняются либо как MIME-type: application/octet-stream, либо из несвязанного домена, например из облачного хранилища файлов, Чтобы снизить риск воздействия XSS-векторов или других атак, связанных с загружаемыми файлами, применяется соответствующая политика безопасности контента (CSP). | | ✓ | ✓ | 646 |

## V1.13 Архитектура API

Место вставки для будущих архитектурных требований.

## V1.14 Безопасные конфигурации

| № | Описание | L1 | L2 | L3 | CWE |
| :---: | :--- | :---: | :---:| :---: | :---: |
| **1.14.1** | Контролируйте разделение компонентов с разными уровнями доверия с помощью шлюзов безопасности, правил брандмауэра, шлюзов API, обратных прокси-серверов, облачных групп безопасности и т.п. | | ✓ | ✓ | 923 |
| **1.14.2** | Убедитесь, что при развертывании бинарных файлов на удаленных устройствах контролируются их сигнатуры, используются доверенные соединения и конечные точки из списка разрешенных. | | ✓ | ✓ | 494 |
| **1.14.3** | Убедитесь, что конвейер сборки предупреждает об устаревших или небезопасных компонентах и предпринимает соответствующие действия. | | ✓ | ✓ | 1104 |
| **1.14.4** | Убедитесь, что конвейер содержит этап автоматической сборки и проверки безопасного развертывания приложения, особенно если инфраструктура приложения определяется программно, например сценарием сборки в облачной среде. | | ✓ | ✓ | |
| **1.14.5** | Убедитесь, что развертывание приложений проводится в «песочнице», контейнере и/или изолировано на сетевом уровне, чтобы сдержать нарушителя от атак на другие приложения, особенно когда они выполняют чувствительные или опасные действия, например, десериализацию. ([C5](https://owasp.org/www-project-proactive-controls/#div-numbering)) | | ✓ | ✓ | 265 |
| **1.14.6** | Убедитесь, что приложение не использует неподдерживаемые, небезопасные или устаревшие клиентские технологии, такие как подключаемые модули NSAPI, Flash, Shockwave, ActiveX, Silverlight, NACL или клиентские Java-апплеты. | | ✓ | ✓ | 477 |

## Ссылки

Для дополнительной информации см. также:

* [OWASP Threat Modeling Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/Threat_Modeling_Cheat_Sheet.html)
* [OWASP Attack Surface Analysis Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/Attack_Surface_Analysis_Cheat_Sheet.html)
* [OWASP Threat modeling](https://owasp.org/www-community/Application_Threat_Modeling)
* [OWASP Software Assurance Maturity Model Project](https://owasp.org/www-project-samm/)
* [Microsoft SDL](https://www.microsoft.com/en-us/sdl/)
* [NIST SP 800-57](https://csrc.nist.gov/publications/detail/sp/800-57-part-1/rev-5/final)

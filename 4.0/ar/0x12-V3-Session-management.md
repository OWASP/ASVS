# ت3: إدارة الجلسة

## الهدف من ضوابط الأمان

أحد المكونات الأساسية لأي تطبيق مستند إلى الويب web-based application  أو واجهة برمجة التطبيقات ذات الحالة stateful API  هو الآلية التي يتحكم بها ويحافظ على الحالة للمستخدم أو الجهاز الذي يتفاعل معها. تقوم إدارة الجلسة بتغيير بروتوكول عديم الحالة stateless protocol ليصبح ذو حالة stateful ، وهو أمر بالغ الأهمية للتمييز بين المستخدمين أو الأجهزة المختلفة.

تأكد من أن التطبيق الذي تم التحقق منه يلبي المتطلبات رفيعة المستوى لإدارة الجلسة وهي:

* الجلسات فريدة لكل مستخدم ولا يمكن تخمينها أو مشاركتها.
* يتم إبطال  الجلسات invalidated  عند عدم الحاجة إليها وتنتهي مهلتها خلال فترات عدم النشاط.

كما لوحظ سابقًا ، تم موائمة هذه المتطلبات لتكون مجموعة فرعية متوافقة من ضوابط NIST 800-63b المحددة ، والتي تركز على التهديدات الشائعة ونقاط ضعف المصادقة التي يتم استغلالها بشكل شائع. تم إلغاء متطلبات التحقق السابقة أو إلغاء خدعها de-duped أو موائمتها في معظم الحالات لتتماشى بشكل قوي مع الغرض من متطلبات  [NIST 800-63b](https://pages.nist.gov/800-63-3/sp800-63b.html) الإلزامية.

## متطلبات التحقق الأمني

## ق1.3 أمان إدارة الجلسة الأساسية  Fundamental Session Management Security

| # | التوصيف | L1 | L2 | L3 | CWE | [NIST &sect;](https://pages.nist.gov/800-63-3/sp800-63b.html) |
| :---: | :--- | :---: | :---:| :---: | :---: | :---: |
| **1.1.3** | تحقق من أن التطبيق لا يكشف أبدًا عن الرموز المميزة للجلسة session Tokens في بارامترات الرابط URL parameters. | ✓ | ✓ | ✓ | 598 | |

## V3.2 ق2.3 ربط الجلسة

| # | التوصيف | L1 | L2 | L3 | CWE | [NIST &sect;](https://pages.nist.gov/800-63-3/sp800-63b.html) |
| :---: | :--- | :---: | :---:| :---: | :---: | :---: |
| **1.2.3** | تحقق من أن التطبيق ينشئ رمزًا مميزًا جديدًا للجلسة session token  عند مصادقة المستخدم. ([C6](https://owasp.org/www-project-proactive-controls/#div-numbering)) | ✓ | ✓ | ✓ | 384 | 7.1 |
| **2.2.3** | تحقق من أن الرموز المميزة للجلسة session token تمتلك ما لا يقل عن 64 بتًا من الانتروبيا entropy. ([C6](https://owasp.org/www-project-proactive-controls/#div-numbering)) | ✓ | ✓ | ✓ | 331 | 7.1 |
| **3.2.3** | تحقق من أن التطبيق يخزن فقط الرموز المميزة للجلسة session token في المتصفح باستخدام طرق آمنة مثل ملفات تعريف الارتباط المؤمنة secured cookies  بشكل مناسب (انظر القسم 4.3) أو تخزين جلسة HTML 5 (HTML 5 session storage). | ✓ | ✓ | ✓ | 539 | 7.1 |
| **4.2.3** | تحقق من توليد رمز الجلسة session token باستخدام خوارزميات التشفير المعتمدة. ([C6](https://owasp.org/www-project-proactive-controls/#div-numbering)) | | ✓ | ✓ | 331 | 7.1 |

إن TLS أو قناة نقل آمنة أخرى secure transport channel إلزامية لإدارة الجلسة. هذا مغطى في فصل أمان الاتصالات.

## ق3.3 إنهاء الجلسة

تمت موائمة مهلات الجلسة Session timeouts مع NIST 800-63 ، مما يسمح بمهلة أطول للجلسة أكثر مما تسمح به معايير الأمان تقليديًا. يجب على المؤسسات مراجعة الجدول أدناه ، وإذا كان من المرغوب فيه الحصول على مهلة أطول استنادًا إلى مخاطر التطبيق ، فيجب أن تكون قيمة NIST هي الحدود العليا لمهلة الخمول للجلسة session idle timeouts.

L1 في هذا السياق هي IAL1 / AAL1 ، L2 هي IAL2 / AAL3 ، L3 هي IAL3 / AAL3. بالنسبة إلى IAL2 / AAL2 و IAL3 / AAL3 ، تكون مهلة الخمول idle الأقصر هي الحد الأدنى لأوقات الخمول لتسجيل الخروج أو إعادة المصادقة لاستئناف resume الجلسة.

| # | التوصيف | L1 | L2 | L3 | CWE | [NIST &sect;](https://pages.nist.gov/800-63-3/sp800-63b.html) |
| :---: | :--- | :---: | :---:| :---: | :---: | :---: |
| **1.3.3** | تحقق من أن تسجيل الخروج وانتهاء الصلاحية يبطلان الرمز المميز للجلسة ، بحيث لا يستأنف زر الرجوع أو الطرف المعتمد المتلقين للمعلومات جلسة مصادق عليها ، بما في ذلك عبر الأطراف المعتمدة. ([C6](https://owasp.org/www-project-proactive-controls/#div-numbering)) | ✓ | ✓ | ✓ | 613 | 7.1 |
| **2.3.3** | تحقق من أن تسجيل الخروج وانتهاء الصلاحية يبطلان الرمز المميز للجلسة ، بحيث لا يستأنف زر الرجوع أو الطرف المعتمد المتلقين للمعلومات جلسة مصادق عليها ، بما في ذلك عبر الأطراف المعتمدة. ([C6](https://owasp.org/www-project-proactive-controls/#div-numbering)) | 30 days | 12 hours or 30 minutes of inactivity, 2FA optional | 12 hours or 15 minutes of inactivity, with 2FA | 613 | 7.2 |
| **3.3.3** | تحقق من أن التطبيق يمنح خيار إنهاء جميع الجلسات النشطة الأخرى بعد تغيير كلمة المرور بنجاح (بما في ذلك التغيير عبر إعادة تعيين / استرداد كلمة المرور) ، وأن هذا فعال عبر التطبيق ، وتسجيل الدخول الموحد (إن وجد) ، وأي أطراف معتمدة. | | ✓ | ✓ | 613 | |
| **4.3.3** | تحقق من أن التطبيق يمنح خيار إنهاء جميع الجلسات النشطة الأخرى بعد تغيير كلمة المرور بنجاح (بما في ذلك التغيير عبر إعادة تعيين / استرداد كلمة المرور) ، وأن هذا فعال عبر التطبيق ، وتسجيل الدخول الموحد (إن وجد) ، وأي أطراف معتمدة. | | ✓ | ✓ | 613 | 7.1 |

## ق4.3 إدارة الجلسة المستندة إلى ملفات تعريف الارتباط

| # | التوصيف | L1 | L2 | L3 | CWE | [NIST &sect;](https://pages.nist.gov/800-63-3/sp800-63b.html) |
| :---: | :--- | :---: | :---:| :---: | :---: | :---: |
| **1.4.3** | تحقق من أن الرموز المميزة للجلسة المستندة إلى ملفات تعريف الارتباط cookie-based session tokens مفعل بها السمة "secure". ([C6](https://owasp.org/www-project-proactive-controls/#div-numbering)) | ✓ | ✓ | ✓ | 614 | 7.1.1 |
| **2.4.3** | تحقق من أن الرموز المميزة للجلسة المستندة إلى ملفات تعريف الارتباط cookie-based session tokens  مفعل بها السمة "HttpOnly". ([C6](https://owasp.org/www-project-proactive-controls/#div-numbering)) | ✓ | ✓ | ✓ | 1004 | 7.1.1 |
| **3.4.3** | تحقق من أن الرموز المميزة للجلسة المستندة إلى ملفات تعريف الارتباط cookie-based session tokens  تستخدم سمة "SameSite" للحد من التعرض لهجمات طلبات التزوير عبر المواقع cookie-based session tokens. ([C6](https://owasp.org/www-project-proactive-controls/#div-numbering)) | ✓ | ✓ | ✓ | 1275 | 7.1.1 |
| **4.4.3** | تحقق من أن الرموز المميزة للجلسة المستندة إلى ملفات تعريف الارتباط cookie-based session tokens تستخدم بادئة  "-Host__" لذلك يتم إرسال ملفات تعريف الارتباط فقط إلى المضيف الذي قام في البداية بتعيين ملف تعريف الارتباط. | ✓ | ✓ | ✓ | 16 | 7.1.1 |
| **5.4.3** | تحقق من أنه إذا تم نشر التطبيق تحت اسم نطاق مع تطبيقات أخرى تقوم بتعيين أو استخدام ملفات تعريف ارتباط الجلسة التي قد تكشف عن ملفات تعريف الارتباط للجلسة ، فقم بتعيين سمة path  في الرموز المميزة للجلسة المستندة إلى ملفات تعريف الارتباط باستخدام المسار الأكثر دقة ممكنًا. ([C6](https://owasp.org/www-project-proactive-controls/#div-numbering)) | ✓ | ✓ | ✓ | 16 | 7.1.1 |

## ق5.3 إدارة الجلسة المستندة إلى الرمز المميز

تتضمن إدارة الجلسة المستندة إلى الرمز المميز مفاتيح JWT و OAuth و SAML و API. من بين هذه المفاتيح ، من المعروف أن مفاتيح API ضعيفة ويجب عدم استخدامها في كود جديد.

| # | التوصيف | L1 | L2 | L3 | CWE | [NIST &sect;](https://pages.nist.gov/800-63-3/sp800-63b.html) |
| :---: | :--- | :---: | :---:| :---: | :---: | :---: |
| **1.5.3** | تحقق من أن التطبيق يسمح للمستخدمين بإبطال revoke رموز OAuth المميزة التي تشكل علاقات ثقة مع التطبيقات المرتبطة. | | ✓ | ✓ | 290 | 7.1.2 |
| **2.5.3** | تحقق من أن التطبيق يستخدم الرموز المميزة للجلسة بدلاً من أسرار ومفاتيح واجهة برمجة التطبيقات الثابتة static API secrets and keys  ، باستثناء عمليات التنفيذ القديمة legacy implementations. | | ✓ | ✓ | 798 | |
| **3.5.3** | تحقق من أن الرموز المميزة للجلسة عديمة الحالة stateless session tokens  تستخدم التوقيعات الرقمية والتشفير وغيرها من الإجراءات المضادة للحماية من هجمات التلاعب tampering ، والتغليف enveloping  ، وإعادة التشغيل reply، والتشفير الفارغ null cipher ، استبدال المفتاح key substitution. | | ✓ | ✓ | 345 | |

## ق6.3 إعادة المصادقة الموحدة Federated Re-authentication

يتعلق هذا القسم بأولئك الذين يكتبون الشيفرة المصدرية للطرف المعتمد Relying Party (RP) أو مزود خدمة الاعتماد Credential Service Provider (CSP). في حالة الاعتماد على التعليمات البرمجية التي تنفذ هذه الميزات ، تأكد من التعامل مع هذه المشكلات بشكل صحيح.

| # | التوصيف | L1 | L2 | L3 | CWE | [NIST &sect;](https://pages.nist.gov/800-63-3/sp800-63b.html) |
| :---: | :--- | :---: | :---:| :---: | :---: | :---: |
| **1.6.3** | تحقق من أن الأطراف المعتمدة Relying Parties (RPs) تحدد الحد الأقصى لوقت المصادقة لمقدمي خدمات الاعتماد (CSPs) وأن CSPs يعيدون مصادقة المستخدم إذا لم يستخدموا جلسة خلال تلك الفترة. | | | ✓ | 613 | 7.2.1 |
| **2.6.3** | تحقق من أن مقدمي خدمات الاعتماد (CSPs) يبلغون الأطراف المعتمدة (RPs) بحدث المصادقة الأخير ، للسماح لـ RPs بتحديد ما إذا كانوا بحاجة إلى إعادة مصادقة المستخدم. | | | ✓ | 613 | 7.2.1 |

## ق7.3 الحماية ضد استغلالات إدارة الجلسة

هناك عدد قليل من هجمات إدارة الجلسات ، بعضها يتعلق بتجربة المستخدم (UX) للجلسات. في السابق ، بناءً على متطلبات ISO 27002 ، تطلب ASVS حظر عدة جلسات متزامنة. لم يعد حظر الجلسات المتزامنة مناسبًا ، ليس فقط لأن المستخدمين الحديثين لديهم العديد من الأجهزة أو أن التطبيق عبارة عن واجهة برمجة تطبيقات بدون جلسة متصفح  API without a browser session ، ولكن في معظم هذه التطبيقات ، يفوز المصادق الأخير ، والذي غالبًا ما يكون المهاجم. يوفر هذا القسم إرشادات رائدة حول ردع وتأخير واكتشاف هجمات إدارة الجلسة باستخدام التعليمات البرمجية.

### وصف الهجوم نصف المفتوح

في أوائل عام 2018 ، تم اختراق العديد من المؤسسات المالية باستخدام ما أطلق عليه المهاجمون "هجمات نصف مفتوحة half-open attacks ". هذا المصطلح عالق في الصناعة. قام المهاجمون بضرب مؤسسات متعددة بقواعد رموز احتكارية مختلفة proprietary code bases ، ويبدو بالفعل أن قواعد كود مختلفة داخل نفس المؤسسات. يستغل الهجوم نصف المفتوح عيبًا في نمط التصميم شائعًا في العديد من أنظمة المصادقة الحالية وإدارة الجلسة والتحكم في الوصو.

يبدأ المهاجمون هجومًا نصف مفتوح بمحاولة قفل بيانات الاعتماد أو إعادة تعيينها أو استردادها. يعيد نمط تصميم إدارة الجلسة الشائع استخدام كائنات / نماذج objects/models لجلسة ملف تعريف المستخدم بين غير مصادق unauthenticated، ونصف مصادق half-authenticated  (إعادة تعيين كلمة المرور ، نسيان اسم المستخدم) ، ورمز مصادق بالكامل fully authenticated code. يملأ نمط التصميم هذا كائن جلسة صالحًا أو رمزًا مميزًا يحتوي على ملف تعريف الضحية ، بما في ذلك تجزئة كلمة المرور password hashes والأدوار rules. إذا لم يتحقق التحكم في الوصول في وحدات التحكم أو أجهزة التوجيه بشكل صحيح من تسجيل المستخدم للدخول بشكل كامل ، فسيكون المهاجم قادرًا على التصرف كمستخدم. يمكن أن تشمل الهجمات تغيير كلمة مرور المستخدم إلى قيمة معروفة ، وتحديث عنوان البريد الإلكتروني لإجراء إعادة تعيين كلمة مرور صالحة ، أو تعطيل المصادقة متعددة العوامل أو تسجيل جهاز MFA جديد ، أو الكشف عن مفاتيح واجهة برمجة التطبيقات  API keys أو تغييرها ، وما إلى ذلك.

| # | التوصيف | L1 | L2 | L3 | CWE | [NIST &sect;](https://pages.nist.gov/800-63-3/sp800-63b.html) |
| :---: | :--- | :---: | :---:| :---: | :---: | :---: |
| **1.7.3** | تحقق من التطبيق يضمن جلسة تسجيل دخول كاملة وصالحة أو يتطلب إعادة المصادقة أو التحقق الثانوي قبل السماح بأي معاملات حساسة أو تعديلات على الحساب. | ✓ | ✓ | ✓ | 306 | |

## المراجع

لمزيد من المعلومات، يمكن أيضاً الاطلاع على:

* [OWASP Testing Guide 4.0: Session Management Testing](https://owasp.org/www-project-web-security-testing-guide/v41/4-Web_Application_Security_Testing/06-Session_Management_Testing/README.html)
* [OWASP Session Management Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/Session_Management_Cheat_Sheet.html)
* [Set-Cookie __Host- prefix details](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Set-Cookie#Directives)

# ت1: المعمارية، والتصميم ونمذجة التهديدات

## الهدف من ضوابط الأمان

أصبح أمان المعمارية فنًا مفقوداً في العديد من المنظمات. لقد ولت أيام مهندس معمارية التطبيق في المؤسسة enterprise architect في عصر DevSecOps. يجب على مجال أمان التطبيقات أن يواكب الجديد ويعتمد مبادئ أمان agile عند إعادة تقديم مبادئ أمان المعمارية الرائدة لممارسي هندسة البرمجيات. المعمارية ليست تنفيذ، ولكنها طريقة للتفكير في مشكلة يحتمل أن يكون لها العديد من الإجابات المختلفة، ولا توجد إجابة واحدة "صحيحة". في كثير من الأحيان، يُنظر إلى الأمان على أنه غير مرن ويتطلب من المطورين تعديل الشيفرة المصدرية بطريقة معينة عندما يجد المطورون طريقة أفضل لحل المشكلة. لا يوجد حل واحد بسيط للمعمارية، والاعتقاد بخلاف ذلك يضر بمجال هندسة البرمجيات.

ربما تتم مراجعة تنفيذ معين لتطبيق ويب بشكل مستمر طوال حياته، تتغير المعمارية نادراً ولكنها تتطور ببطىء. إن معمارية الأمان مماثلة في كل التفاصيل والأوقات على حد سواء - نحتاج إلى المصادقة اليوم ، وسنحتاج المصادقة غدًا ، وسنحتاجها بعد خمس سنوات من الآن. إذا اتخذنا قرارات سليمة اليوم، فيمكننا توفير الكثير من الجهد والوقت والمال إذا اخترنا الحلول المتوافقة مع المعمارية وأعدنا استخدامها. على سبيل المثال، قبل عشرة سنوات، كان استخدام المصادقة متعددة العوامل multi-factor authentication  نادراً.

فيمكن تحديث مزود الهوية لدمج متطلبات جديدة مثل متطلبات الامتثال لـ NIST 800-63 ، مع عدم تغيير واجهات التطبيق الأصلي. إذا كانت العديد من التطبيقات تشترك في نفس معمارية الأمان وبالتالي نفس المكون، فإنهم جميعًا يستفيدون من هذه الترقية مرة واحدة. ومع ذلك، لن تظل SAML دائمًا أفضل حل مصادقة أو أنسبها - فقد يلزم استبدالها بحلول أخرى مع تغير المتطلبات. مثل هذه التغييرات إما معقدة، ومكلفة للغاية بحيث تتطلب إعادة كتابة كاملة، أو مستحيلة تمامًا بدون معمارية الأمان.

في هذا الفصل، يغطي ASVS الجوانب الأساسية لأي معمارية أمان سليمة: التوافر availability والسرية confidentiality وسلامة المعالجة processing integrity وعدم الإنكار non-repudiation والخصوصية privacy. يجب أن تكون مبادئ الأمان هذه بديهية وأساسية في جميع التطبيقات. إنه من المهم "التحول نحو اليسار shift left"، بدءًا من تمكين المطور من خلال قوائم التحقق من كتابة الشيفرة المصدرية الآمنة secure coding checklists، والتوجيه mentoring والتدريب، وكتابة الشيفرة المصدرية والاختبار، والبناء  build، والنشر deployment ، والتكوين configuration ، والعمليات ، والانهاء بالاختبارات المستقلة يتبع ما سبق للتأكد من أن جميع ضوابط الأمان موجودة وفعالة. الخطوة الأخيرة هي استخدام كل ما سبق في الصناعة، ولكن هذا لم يعد كافيًا عندما يضع المطورون الشيفرة المصدرية في بيئة الإنتاج الحقيقية production  عشرات أو مئات المرات يومياً. يجب على محترفي أمان التطبيقات مواكبة تقنيات agile، مما يعني اعتماد أدوات المطور developer tools، وتعلم البرمجة، والعمل مع المطورين بدلاً من انتقاد المشروع بعد شهور من انتقال أي شخص آخر.

## ق1.1 دورة حياة تطوير البرمجيات الآمنة

| # | التوصيف | L1 | L2 | L3 | CWE |
| :---: | :--- | :---: | :---:| :---: | :---: |
| **1.1.1** | تحقق من استخدام دورة حياة تطوير البرمجيات الآمنة التي تتناول الأمان في جميع مراحل التطوير. ([C1](https://owasp.org/www-project-proactive-controls/#div-numbering)) | | ✓ | ✓ | |
| **2.1.1** | تحقق من استخدام نمذجة التهديد عند كل تغيير في التصميم أو في الـ sprint لتحديد التهديدات، والتخطيط للإجراءات المضادة، وتسهيل الاستجابات المناسبة للمخاطر، وتوجيه اختبارات الأمان. | | ✓ | ✓ | 1053 |
| **3.1.1** | تحقق من أن جميع قصص المستخدم user stories والميزات تحتوي على قيود أمان وظيفية، مثل "بصفتي مستخدمًا، يجب أن أتمكن من عرض ملف التعريف الخاص بي وتعديله. لا ينبغي أن أكون قادرًا على عرض ملف التعريف الخاص بأي شخص آخر أو تعديله" | | ✓ | ✓ | 1110 |
| **4.1.1** | تحقق من التوثيق والتبرير justification لجميع حدود ثقة التطبيق trust boundaries والمكونات وتدفقات البيانات significant data flows الهامة. | | ✓ | ✓ | 1059 |
| **5.1.1** | تحقق من التعريف والتحليل الأمني للمعمارية عالية المستوى high-level architecture للتطبيق وجميع الخدمات المتصلة عن بعد connected remote services. ([C1](https://owasp.org/www-project-proactive-controls/#div-numbering)) | | ✓ | ✓ | 1059 |
| **6.1.1** | تحقق من تنفيذ ضوابط أمنية مركزية وبسيطة (الاقتصاد في التصميم economy of design) تم فحصها وتعتبر آمنة وقابلة لإعادة الاستخدام لتجنب الضوابط المكررة أو المفقودة أو غير الفعالة أو غير الآمنة. ([C10](https://owasp.org/www-project-proactive-controls/#div-numbering)) | | ✓ | ✓ | 637 |
| **7.1.1** | تحقق من توفر قائمة تحقق لكتابة شيفرة مصدرية آمنة secure coding checklist ،أو متطلبات الأمان أو إرشادات أو سياسة لجميع المطورين والمختبرين. | | ✓ | ✓ | 637 |

## ق2.1 معمارية المصادقة

عند تصميم المصادقة ، لا يهم أن يكون لديك مصادقة متعددة العوامل ممكّنة للأجهزة القوية إذا كان بإمكان المهاجم إعادة تعيين حساب عن طريق الاتصال بمركز الاتصال call center والإجابة على الأسئلة الشائعة. عند إثبات الهوية، يجب أن تتمتع جميع مسارات المصادقة authentication paths بنفس القوة.

| # | التوصيف | L1 | L2 | L3 | CWE |
| :---: | :--- | :---: | :---:| :---: | :---: |
| **1.2.1** | تحقق من استخدام حسابات نظام تشغيل فريدة أو خاصة بامتيازات منخفضة low-privilege لجميع مكونات التطبيق والخدمات والخوادم. ([C3](https://owasp.org/www-project-proactive-controls/#div-numbering)) | | ✓ | ✓ | 250 |
| **2.2.1** | تحقق من أن جميع الاتصالات بين مكونات التطبيق ، بما في ذلك الـ APIs وmiddleware وطبقات البيانات data layers هي مصادق عليها authenticated. يجب أن تحتوي المكونات على أقل الامتيازات اللازمة. ([C3](https://owasp.org/www-project-proactive-controls/#div-numbering)) | | ✓ | ✓ | 306 |
| **3.2.1** | تحقق من أن التطبيق يستخدم آلية مصادقة واحدة تم فحصها ومن المعروف أنها آمنة ، ويمكن توسيعها لتشمل مصادقة قوية ، ولديه ما يكفي من التسجيل logging والمراقبة لاكتشاف إساءة استخدام الحساب أو الخروقات account abuse or breaches . | | ✓ | ✓ | 306 |
| **4.2.1** | تحقق من أن جميع مسارات المصادقة وواجهات برمجة تطبيقات إدارة الهوية identity management APIs تستخدم ضوابط أمان قوية وملائمة للمصادقة ، بحيث لا توجد بدائل أضعف من ناحية مخاطر التطبيق. | | ✓ | ✓ | 306 |

## ق3.1 معمارية إدارة الجلسة

هذه الفقرة فارغة للمتطلبات المعمارية المستقبلية المتعلقة بإدارة الجلسة.

## ق4.1 معمارية التحكم في الوصول

| # | التوصيف | L1 | L2 | L3 | CWE |
| :---: | :--- | :---: | :---:| :---: | :---: |
| **1.4.1** | تحقق من أن نقاط التنفيذ الموثوقة trusted enforcement points كالتي عند بوابات التحكم في الوصول والخوادم والـserverless functions  تفرض ضوابط الوصول. لا تفرض أبدًا ضوابط الوصول على العميل. | | ✓ | ✓ | 602 |
| **2.4.1** | [تم حذفها ، غير قابلة للتنفيذ] | | | | |
| **3.4.1** | [تم حذفها ، مكررة عن 3.1.4] | | | | |
| **4.4.1** | تحقق من أن التطبيق يستخدم آلية واحدة للتحكم في الوصول تم فحصها جيدًا للوصول إلى البيانات والموارد المحمية. يجب أن تمر جميع الطلبات من خلال هذه الآلية الفردية لتجنب النسخ واللصق أو المسارات البديلة غير الآمنة insecure alternative paths. ([C7](https://owasp.org/www-project-proactive-controls/#div-numbering)) | | ✓ | ✓ | 284 |
| **5.4.1** | تحقق من استخدام التحكم في الوصول المستند على الخاصية أو الميزة attribute or feature-based access control  حيث تتحقق الشيفرة المصدرية من وجود تفويض للمستخدم للوصول للميزة أو لعنصر البيانات بدلاً من التحقق من دوره فقط. يجب أن يتم حصر تخصيص الأذونات Permissions باستخدام الأدوار. ([C7](https://owasp.org/www-project-proactive-controls/#div-numbering)) | | ✓ | ✓ | 275 |

## ق5.1 معمارية المدخلات والمخرجات

في الإصدار 4.0 ، ابتعدنا عن مصطلح "من جهة الخادم"server-side " كمصطلح حدود الثقة المحملة loaded trust boundary. لا تزال حدود الثقة مثيرة للقلق - اتخاذ القرارات بشأن المتصفحات غير الموثوق بها أو أجهزة العميل أمر يمكن تجاوزه - ومع ذلك ، في عمليات نشر المعمارية السائدة mainstream architectural deployments اليوم ، تغيرت نقطة إنفاذ الثقة trust enforcement point بشكل كبير. لذلك ، عند استخدام مصطلح "طبقة الخدمة الموثوقة trusted service layer " في ASVS ، فإننا نعني أي نقطة تنفيذ موثوقة trusted enforcement point ، بغض النظر عن الموقع ، مثل خدمة مصغرة microservice والـ serverless API وserver-side والـ trusted API على جهاز عميل لديه إقلاع آمن secure boot أو partner or external APIs، وما إلى ذلك.

يشير مصطلح "العميل غير الموثوق به untrusted client" هنا إلى تقنيات من جهة العميل client-side technologies التي تعرض طبقة العرض التقديمي presentation layer، والتي يشار إليها عادةً باسم تقنيات "الواجهة الأمامية 'front-end ". لا يشير مصطلح "التسلسل serialization " هنا فقط إلى إرسال البيانات عبر السلك over the wire مثل مجموعة من القيم أو أخذ بنية JSON وقراءتها ، بل يشير أيضًا إلى تمرير الكائنات المعقدة التي يمكن أن تحتوي على منطق.

| # | التوصيف | L1 | L2 | L3 | CWE |
| :---: | :--- | :---: | :---:| :---: | :---: |
| **1.5.1** | تحقق من أن متطلبات المدخلات والمخرجات تحدد بوضوح كيفية التعامل مع البيانات ومعالجتها بناءً على النوع والمحتوى والقوانين واللوائح المعمول بها والامتثال للسياسة الأخرى. | | ✓ | ✓ | 1029 |
| **2.5.1** | تحقق من عدم استخدام التسلسل عند الاتصال بعملاء غير موثوق بهم. إذا لم يكن ذلك ممكنًا ، فتأكد من فرض ضوابط الحماية الكافية (كالتشفير إذا تم إرسال بيانات حساسة) لمنع هجمات إلغاء التسلسل deserialization attacks  بما في ذلك حقن الكائنات object injection. | | ✓ | ✓ | 502 |
| **3.5.1** | تحقق من أن التحقق من صحة المدخلات input validation يتم فرضه على طبقة خدمة موثوقة trusted service layer. ([C5](https://owasp.org/www-project-proactive-controls/#div-numbering)) | | ✓ | ✓ | 602 |
| **4.5.1** | تحقق من أن ترميز المخرجات output encoding يحدث بالقرب من أو من قبل مفسر الأوامر interpreter الموجه إليه. ([C4](https://owasp.org/www-project-proactive-controls/#div-numbering)) | | ✓ | ✓ | 116 |

## ق6.1 معمارية التشفير

يجب تصميم التطبيقات باستخدام معمارية تشفير قوية لحماية أصول البيانات وفقًا لتصنيفها. يعد تشفير كل شيء إهدارًا ، ولا يعد عدم تشفير أي شيء إهمالًا قانونيًا. يجب تحقيق توازن وهذا يكون عادةً أثناء التصميم المعماري أو عالي المستوى high level design ، أو في design sprints  أو المسامير المعمارية architectural spikes. إن تصميم أو تعديل التشفير للتنفيذ الآمن أثناء المضي قدماً سيكلف حتماً أكثر بكثير مقارنة ببنائه من البداية.

تعتبر المتطلبات المعمارية جوهرية لأساس الشيفرة المصدرية بأكملها ، وبالتالي تزيد من صعوبة اختبارات الوحدة والتكامل unit or integrate test. تحتاج المتطلبات المعمارية إلى النظر في معايير كتابة الشيفرة المصدرية coding standards ، طوال مرحلة التنفيذ البرمجي، ويجب مراجعتها ضمن معمارية الأمان، أو مراجعات الأقران أو مراجعات الشيفرة المصدرية ، أو عمليات الاسترجاع retrospectives.

| # | التوصيف | L1 | L2 | L3 | CWE |
| :---: | :--- | :---: | :---:| :---: | :---: |
| **1.6.1** | تحقق من وجود سياسة واضحة لإدارة مفاتيح التشفير وأن دورة حياة مفتاح التشفير تتبع معيار إدارة المفاتيح مثل NIST SP 800-57. | | ✓ | ✓ | 320 |
| **2.6.1** | تحقق من أن مستخدمي خدمات التشفير يحمون المواد الأساسية Key material والأسرار الأخرى other secrets باستخدام خزائن المفاتيح key vaults أو البدائل القائمة على APIs. | | ✓ | ✓ | 320 |
| **3.6.1** | تحقق من أن جميع المفاتيح وكلمات المرور قابلة للاستبدال وأنها جزء من عملية معرفة جيدًا لإعادة تشفير البيانات الحساسة. | | ✓ | ✓ | 320 |
| **4.6.1** | تحقق من أن المعمارية تتعامل مع الأسرار من جهة العميل client-side secrets - مثل المفاتيح المتناظرة symmetric keys أو كلمات المرور أو الرموز المميزة لواجهة برمجة التطبيقات API tokens - باعتبارها غير آمنة ولا تستخدمها أبدًا لحماية البيانات الحساسة أو الوصول إليها. | | ✓ | ✓ | 320 |

## ق7.1 معمارية الأخطاء، التسجيل والمراقبة

| # | التوصيف | L1 | L2 | L3 | CWE |
| :---: | :--- | :---: | :---:| :---: | :---: |
| **1.7.1** | تحقق من استخدام طريقة وتنسيق شائع للتسجيل common logging format and approach داخل النظام. ([C9](https://owasp.org/www-project-proactive-controls/#div-numbering)) | | ✓ | ✓ | 1009 |
| **2.7.1** | تحقق من أن السجلات يتم إرسالها بشكل آمن إلى نظام التحكم عن بعد remote system  للتحليل والاكتشاف والتنبيه alerting والتصعيد escalation. ([C9](https://owasp.org/www-project-proactive-controls/#div-numbering)) | | ✓ | ✓ | |

## ق8.1 معمارية حماية البيانات والخصوصية

| # | التوصيف | L1 | L2 | L3 | CWE |
| :---: | :--- | :---: | :---:| :---: | :---: |
| **1.8.1** | تحقق من تحديد وتصنيف جميع البيانات الحساسة ضمن مستويات حماية protection levels. | | ✓ | ✓ | |
| **2.8.1** | تحقق من أن جميع مستويات الحماية لها مجموعة مرتبطة من متطلبات الحماية ، مثل متطلبات التشفير ، ومتطلبات السلامة integrity requirements ، والاحتفاظ retention ، والخصوصية وغير ذلك من متطلبات السرية confidentiality requirements ، وأنه يتم تطبيقها في المعمارية. | | ✓ | ✓ | |

## ق9.1 معمارية الاتصالات

| # | التوصيف | L1 | L2 | L3 | CWE |
| :---: | :--- | :---: | :---:| :---: | :---: |
| **1.9.1** | تحقق من أن التطبيق يقوم بتشفير الاتصالات بين المكونات، خاصة عندما تتواجد المكونات في حاويات containers أو أنظمة أو مواقع أو مزودي خدمات سحابية cloud providers مختلفة. ([C3](https://owasp.org/www-project-proactive-controls/#div-numbering)) | | ✓ | ✓ | 319 |
| **2.9.1** | تحقق من أن مكونات التطبيق تتحقق من صحة authenticity في كل جانب في حلقة الاتصال communication link لمنع هجمات الشخص في المنتصف person-in-the-middle. على سبيل المثال، يجب أن تتحقق مكونات التطبيق من صحة شهادات TLS وسلاسلها TLS certificates and chains. | | ✓ | ✓ | 295 |

## ق10.1 معمارية البرمجيات الخبيثة

| # | التوصيف | L1 | L2 | L3 | CWE |
| :---: | :--- | :---: | :---:| :---: | :---: |
| **1.10.1** | تحقق من أن نظام التحكم في الشيفرة المصدرية source code control system قيد الاستخدام ، مع إجراءات للتأكد من أن عمليات تسجيل الوصول يرافقها قضايا أو تذاكر تغيير issues or change tickets. يجب أن يمتلك نظام التحكم في الشيفرة المصدرية تحكماً في الوصول ومستخدمين يمكن التعرف عليهم للسماح بتتبع أي تغييرات. | | ✓ | ✓ | 284 |

## ق11.1 معمارية منطق الأعمال

| # | التوصيف | L1 | L2 | L3 | CWE |
| :---: | :--- | :---: | :---:| :---: | :---: |
| **1.11.1** | تحقق من تعريف وتوثيق جميع مكونات التطبيق من حيث الأعمال أو وظائف الأمان التي توفرها. | | ✓ | ✓ | 1059 |
| **2.11.1** | تحقق من أن جميع تدفقات منطق الأعمال عالية القيمة high-value business logic flows ، بما في ذلك المصادقة وإدارة الجلسة والتحكم في الوصول ، لا تشترك في الحالة غير المتزامنة unsynchronized state. | | ✓ | ✓ | 362 |
| **1.11.3** | تحقق من أن جميع تدفقات منطق الأعمال عالية القيمة ، بما في ذلك المصادقة وإدارة الجلسة والتحكم في الوصول ، هي آمنة عند استخدام الـthread  ومقاومة لـ time-of-check and time-of-use race conditions. | | | ✓ | 367 |

## ق12.1 معمارية رفع الملفات بشكل آمن

| # | التوصيف | L1 | L2 | L3 | CWE |
| :---: | :--- | :---: | :---:| :---: | :---: |
| **1.12.1** | [تم حذفها ، مكررة عن 1.4.12] | | | | |
| **2.12.1** | تحقق من أن الملفات التي يتم رفعها بواسطة المستخدم - إذا كان هناك حاجة لعرضها أو تحميلها  من التطبيق - يتم تقديمها إما من خلال تنزيلات دفق الثماني octet stream downloads ، أو من نطاق مختلف غير مرتبط بنطاق التطبيق unrelated domain ، مثل حاوية تخزين الملفات السحابية cloud file storage bucket. قم بتنفيذ سياسة أمان محتوى مناسبة Content Security Policy (CSP) لتقليل مخاطر هجمات XSS أو الهجمات الأخرى من الملف الذي تم رفعه. | | ✓ | ✓ | 646 |

## ق13.1 معمارية واجهة التطبيقات البرمجية API

هذه الفقرة فارغة للمتطلبات المعمارية المستقبلية المتعلقة بواجهة التطبيقات البرمجية API.

## ق14.1 معمارية التكوين

| # | التوصيف | L1 | L2 | L3 | CWE |
| :---: | :--- | :---: | :---:| :---: | :---: |
| **1.14.1** | تحقق من فصل مكونات مستويات الثقة المختلفة من خلال ضوابط أمان معرفة جيدًا ، أو قواعد جدار الحماية ، أو API gateways ، أو مخدمات البروكسي العكسية reverse proxies، أو مجموعات الأمان المستندة القائمة على السحابة  cloud-based security groups ، أو الآليات المماثلة. | | ✓ | ✓ | 923 |
| **2.14.1** | تحقق من استخدام التوقيعات الثنائية binary signatures ، والاتصالات الموثوقة trusted connections، ونقاط النهاية التي تم التحقق منها verified endpoints لنشر الـ Binary على الأجهزة البعيدة. | | ✓ | ✓ | 494 |
| **3.14.1** | تحقق من أن الـbuild pipeline يحذر من المكونات القديمة أو غير الآمنة ويتخذ الإجراءات المناسبة. | | ✓ | ✓ | 1104 |
| **4.14.1** | تحقق من أن الـ build pipeline يحتوي على خطوة بناءbuild step  للبناء والتحقق من النشر الآمن للتطبيق تلقائياً build and verify the secure deployment of the application ، لا سيما إذا كانت البنية الأساسية للتطبيق معرفة برمجياً software defined ، مثل البرامج النصية لإنشاء بيئة السحابة cloud environment build scripts. | | ✓ | ✓ | |
| **5.14.1** | تحقق من أن عمليات نشر التطبيق تقوم بشكل كاف بـ: استخدام وضع الحماية sandbox و / أو استخدام الحاويات containerize  و / أو عزل على مستوى الشبكة لتأخير وردع المهاجمين من مهاجمة التطبيقات الأخرى ، خاصةً عندما يقومون بأفعال حساسة أو خطيرة مثل إلغاء التسلسل deserialization. ([C5](https://owasp.org/www-project-proactive-controls/#div-numbering)) | | ✓ | ✓ | 265 |
| **6.14.1** | تحقق من أن التطبيق لا يستخدم تقنيات غير مدعومة أو غير آمنة أو مهملة deprecated  من جهة العميل مثل مكونات NSAPI الإضافية NSAPI plugins أو Flash أو Shockwave أو ActiveX أو Silverlight أو NACL أو تطبيقات Java الصغيرة من جهة العميل client-side Java applets. | | ✓ | ✓ | 477 |

## المراجع

لمزيد من المعلومات، يمكن أيضاً الاطلاع على:

* [OWASP Threat Modeling Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/Threat_Modeling_Cheat_Sheet.html)
* [OWASP Attack Surface Analysis Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/Attack_Surface_Analysis_Cheat_Sheet.html)
* [OWASP Threat modeling](https://owasp.org/www-community/Application_Threat_Modeling)
* [OWASP Software Assurance Maturity Model Project](https://owasp.org/www-project-samm/)
* [Microsoft SDL](https://www.microsoft.com/en-us/sdl/)
* [NIST SP 800-57](https://csrc.nist.gov/publications/detail/sp/800-57-part-1/rev-5/final)
